<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>revnote</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0f1117;
  --surface: #1a1d27;
  --surface2: #232736;
  --border: #2e3347;
  --text: #e8eaf0;
  --text2: #8b8fa8;
  --accent: #6c63ff;
  --accent2: #4ecdc4;
  --danger: #ff6b6b;
  --warning: #ffd93d;
  --success: #51cf66;
  --frozen: #74c0fc;
  --grad1: linear-gradient(135deg, #6c63ff 0%, #4ecdc4 100%);
  --grad2: linear-gradient(135deg, #ff6b6b 0%, #ffd93d 100%);
  --radius: 14px;
  --shadow: 0 4px 24px rgba(0,0,0,0.3);
  --canvas-bg: #f5f5f5;
}
/* Light theme */
:root.light {
  --bg: #f4f5f7;
  --surface: #ffffff;
  --surface2: #eef0f4;
  --border: #d8dce6;
  --text: #1a1d27;
  --text2: #6b7085;
  --shadow: 0 4px 24px rgba(0,0,0,0.08);
  --canvas-bg: #ffffff;
}

/* STRETCH ZONE */
.sz-badge{display:inline-flex;align-items:center;gap:3px;font-size:10px;font-weight:700;padding:2px 8px;border-radius:20px;white-space:nowrap}
.stage-badge{display:inline-flex;align-items:center;font-size:10px;font-weight:600;padding:2px 8px;border-radius:12px;white-space:nowrap}
.stage-new{background:rgba(108,99,255,.15);color:var(--accent)}
.stage-learning{background:rgba(255,193,7,.15);color:#f0ad4e}
.stage-reviewing{background:rgba(78,205,196,.15);color:#4ecdc4}
.stage-mastered{background:rgba(0,200,83,.15);color:var(--success)}
.stage-frozen{background:rgba(120,144,180,.15);color:var(--frozen)}
.type-badge{display:inline-flex;align-items:center;font-size:9px;font-weight:600;padding:1px 6px;border-radius:8px;white-space:nowrap}
.type-flash{background:rgba(255,193,7,.12);color:#f0ad4e}
.type-think{background:rgba(108,99,255,.12);color:var(--accent)}
@keyframes xpPop{0%{opacity:1;transform:translate(-50%,-50%) scale(1)}50%{transform:translate(-50%,-80%) scale(1.3)}100%{opacity:0;transform:translate(-50%,-120%) scale(0.8)}}
.sz-comfort{background:rgba(78,205,196,.15);color:#4ecdc4}
.sz-stretch{background:rgba(108,99,255,.15);color:var(--accent)}
.sz-panic{background:rgba(255,107,107,.15);color:var(--danger)}
.sz-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:16px}
.sz-card{border-radius:var(--radius);padding:14px;text-align:center;cursor:pointer;border:1px solid var(--border);transition:transform .15s}
.sz-card:active{transform:scale(.97)}
.sz-card .sz-num{font-size:28px;font-weight:900}
.sz-card .sz-label{font-size:11px;margin-top:2px}
.sz-comfort-card{background:rgba(78,205,196,.08)}
.sz-stretch-card{background:rgba(108,99,255,.08)}
.sz-panic-card{background:rgba(255,107,107,.08)}
.sz-bar{display:flex;height:6px;border-radius:3px;overflow:hidden;margin-top:8px;background:var(--surface2)}
.sz-bar-seg{height:100%;transition:width .3s}
/* TIMER BAR */
.timer-bar{position:fixed;top:0;left:0;right:0;height:44px;background:var(--surface);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 16px;z-index:150;gap:8px}
.timer-display{font-family:'JetBrains Mono',monospace;font-size:20px;font-weight:700;min-width:72px;text-align:center}
.timer-btn{padding:4px 12px;border-radius:6px;font-size:11px;border:1px solid var(--border);background:var(--surface2);color:var(--text2);cursor:pointer;font-family:inherit}
.timer-btn.active{border-color:var(--accent);color:var(--accent)}
.countdown-badge{font-size:11px;color:var(--warning);font-weight:700;white-space:nowrap}
/* SIDEBAR NAV */
.nav-side{display:none;position:fixed;top:0;left:0;bottom:0;width:72px;background:var(--surface);border-right:1px solid var(--border);flex-direction:column;align-items:center;padding:12px 0;gap:4px;z-index:200;overflow-y:auto}
.nav-side .s-item{display:flex;flex-direction:column;align-items:center;padding:10px 4px;gap:2px;color:var(--text2);font-size:9px;font-weight:500;cursor:pointer;border:none;background:none;border-radius:10px;width:64px}
.nav-side .s-item.active{color:var(--accent);background:rgba(108,99,255,.1)}
.nav-side .s-item span{font-size:20px}
.nav-side .s-logo{font-size:14px;font-weight:900;color:var(--accent);margin-bottom:8px;padding:8px 0}
/* CALENDAR */
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;text-align:center}
.cal-header{font-size:10px;color:var(--text2);padding:4px}
.cal-day{font-size:11px;padding:6px 2px;border-radius:6px;position:relative}
.cal-day.today{font-weight:900;color:var(--accent)}
.cal-day.has-data::after{content:'';position:absolute;bottom:2px;left:50%;transform:translateX(-50%);width:4px;height:4px;border-radius:50%;background:var(--success)}
.cal-day.has-data-many::after{background:var(--accent);width:6px;height:6px}
.cal-day.other-month{opacity:.3}
/* Zone detail */
.zone-detail{max-height:200px;overflow-y:auto;margin-top:8px}
.zone-detail-item{font-size:12px;padding:4px 0;border-bottom:1px solid var(--border);color:var(--text2)}

* { margin:0; padding:0; box-sizing:border-box; }
body {
  font-family: 'Noto Sans JP', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100dvh;
  overflow-x: hidden;
}
.mono { font-family: 'JetBrains Mono', monospace; }

/* === NAV === */
.nav {
  position: fixed; bottom: 0; left: 0; right: 0;
  background: var(--surface);
  border-top: 1px solid var(--border);
  display: flex; z-index: 100;
  padding-bottom: env(safe-area-inset-bottom);
}
.nav-item {
  flex: 1; display: flex; flex-direction: column; align-items: center;
  padding: 10px 4px 6px; gap: 3px;
  color: var(--text2); font-size: 10px; font-weight: 500;
  cursor: pointer; transition: color .2s;
  border: none; background: none;
}
.nav-item.active { color: var(--accent); }
.nav-item svg { width: 22px; height: 22px; }

/* === SCREENS === */
.screen { display: none; padding: 16px 16px 90px; max-width: 480px; margin: 0 auto; }
.screen.active { display: block; }

/* === HEADER === */
.header {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 20px; padding-top: 8px;
}
.header h1 { font-size: 22px; font-weight: 900; }
.header-sub { font-size: 12px; color: var(--text2); }

/* === STREAK === */
.streak-bar {
  background: var(--surface); border-radius: var(--radius);
  padding: 16px; margin-bottom: 16px;
  display: flex; align-items: center; gap: 14px;
  border: 1px solid var(--border);
}
.streak-fire { font-size: 32px; line-height: 1; }
.streak-num { font-size: 28px; font-weight: 900; }
.streak-label { font-size: 12px; color: var(--text2); }
.streak-days {
  display: flex; gap: 4px; margin-left: auto;
}
.streak-dot {
  width: 10px; height: 10px; border-radius: 50%;
  background: var(--border);
}
.streak-dot.done { background: var(--accent); }
.streak-dot.today { background: var(--warning); box-shadow: 0 0 6px var(--warning); }

/* === DAILY QUEUE === */
.queue-summary {
  background: var(--surface); border-radius: var(--radius);
  padding: 20px; margin-bottom: 16px;
  border: 1px solid var(--border); text-align: center;
}
.queue-count { font-size: 48px; font-weight: 900; background: var(--grad1); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
.queue-label { font-size: 13px; color: var(--text2); margin-top: 2px; }
.queue-progress {
  height: 6px; background: var(--border); border-radius: 3px;
  margin-top: 14px; overflow: hidden;
}
.queue-progress-fill {
  height: 100%; border-radius: 3px;
  background: var(--grad1); transition: width .5s ease;
}
.btn-start {
  width: 100%; padding: 16px; border: none; border-radius: var(--radius);
  background: var(--grad1); color: #fff; font-size: 16px; font-weight: 700;
  cursor: pointer; margin-top: 16px; transition: transform .15s, box-shadow .15s;
  font-family: inherit;
}
.btn-start:active { transform: scale(0.97); }
.btn-start:disabled { opacity: .4; cursor: default; }

/* === PROBLEM CARD === */
.card-wrap {
  display: none; flex-direction: column; gap: 12px;
}
.card-wrap.active { display: flex; }
.problem-card {
  background: var(--surface); border-radius: var(--radius);
  padding: 20px; border: 1px solid var(--border);
  position: relative; overflow: hidden;
}
.card-badge {
  display: inline-block; padding: 3px 10px; border-radius: 20px;
  font-size: 11px; font-weight: 700; margin-bottom: 10px;
}
.badge-math { background: rgba(108,99,255,.15); color: var(--accent); }
.badge-science { background: rgba(78,205,196,.15); color: var(--accent2); }
.badge-social { background: rgba(255,217,61,.15); color: var(--warning); }
.badge-english { background: rgba(54,160,255,.15); color: #54a0ff; }
.badge-japanese { background: rgba(255,107,107,.15); color: var(--danger); }
.badge-english { background: rgba(116,192,252,.15); color: var(--frozen); }
.card-source { font-size: 11px; color: var(--text2); margin-bottom: 8px; }
.card-topic { font-size: 17px; font-weight: 700; margin-bottom: 6px; }
.card-content { font-size: 14px; color: var(--text2); line-height: 1.6; }
.card-content img { max-width: 100%; border-radius: 8px; margin-top: 8px; }
.card-meta {
  display: flex; gap: 8px; flex-wrap: wrap; margin-top: 12px;
}
.meta-tag {
  font-size: 10px; padding: 3px 8px; border-radius: 6px;
  background: var(--surface2); color: var(--text2);
}
.meta-freq-high { color: var(--danger); border: 1px solid rgba(255,107,107,.3); }
.meta-diff-hard { color: var(--warning); border: 1px solid rgba(255,217,61,.3); }

/* answer buttons */
.answer-btns {
  display: flex; gap: 10px;
}
.btn-reveal {
  width: 100%; padding: 14px; border: none; border-radius: var(--radius);
  background: var(--surface2); color: var(--text); font-size: 15px; font-weight: 700;
  cursor: pointer; font-family: inherit; border: 1px solid var(--border);
  transition: transform .15s;
}
.btn-reveal:active { transform: scale(0.97); }
.btn-skip {
  width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: var(--radius);
  background: none; color: var(--text2); font-size: 13px; cursor: pointer; font-family: inherit;
  margin-top: 4px;
}
.btn-skip:active { background: var(--surface2); }
.answer-section { display: none; margin-top: 12px; padding: 14px; background: var(--surface2); border-radius: 10px; }
.answer-section.show { display: block; }
.answer-section strong { font-size: 12px; color: var(--text2); }
/* scratchpad */
.scratchpad-wrap { margin-top: 0; position: relative; -webkit-user-select:none; user-select:none; }
.scratchpad-canvas {
  width: 100%; border-radius: 10px; background: var(--canvas-bg);
  border: 1px solid var(--border); touch-action: none;
  -webkit-user-select:none; user-select:none;
  -webkit-touch-callout:none;
}
.scratchpad-toolbar {
  display: flex; gap: 4px; align-items: center; padding: 4px 6px;
  background: var(--surface); border:1px solid var(--border); border-radius: 8px;
  position: absolute; top: 6px; right: 6px; z-index: 10; opacity: 0.85;
}
.scratchpad-toolbar:hover,.scratchpad-toolbar:active { opacity: 1; }
.sp-btn {
  padding: 3px 8px; border-radius: 6px; font-size: 10px;
  border: 1px solid var(--border); background: var(--surface);
  color: var(--text2); cursor: pointer; font-family: inherit;
}
.sp-btn.active { border-color: var(--accent); color: var(--accent); }
.sp-color { width: 18px; height: 18px; border-radius: 50%; border: 2px solid var(--border); cursor: pointer; }
.sp-color.active { border-color: #fff; box-shadow: 0 0 4px rgba(255,255,255,.4); }

/* Review columns layout */
.review-columns { display: flex; flex-direction: column; gap: 12px; }
.review-info { display: flex; flex-direction: column; gap: 10px; }
.review-scratch { display: flex; flex-direction: column; }
/* memo after answer */
.review-memo { margin-top: 10px; }
.review-memo textarea {
  width: 100%; padding: 10px 12px; border-radius: 8px; min-height: 50px; resize: vertical;
  border: 1px solid var(--border); background: var(--surface); color: var(--text);
  font-size: 13px; font-family: inherit; outline: none;
}
.review-memo textarea:focus { border-color: var(--accent); }
.btn-ans {
  flex: 1; padding: 16px 12px; border: none; border-radius: var(--radius);
  font-size: 14px; font-weight: 700; cursor: pointer;
  font-family: inherit; transition: transform .15s;
}
.btn-ans:active { transform: scale(0.95); }
.btn-correct { background: rgba(81,207,102,.15); color: var(--success); border: 1px solid rgba(81,207,102,.3); }
.btn-wrong { background: rgba(255,107,107,.15); color: var(--danger); border: 1px solid rgba(255,107,107,.3); }
.btn-hard { background: rgba(255,217,61,.12); color: var(--warning); border: 1px solid rgba(255,217,61,.25); }

/* === COMPLETION === */
.completion {
  text-align: center; padding: 40px 20px;
}
.completion-icon { font-size: 64px; margin-bottom: 16px; }
.completion h2 { font-size: 24px; font-weight: 900; margin-bottom: 8px; }
.completion p { color: var(--text2); font-size: 14px; }
.completion-stats {
  display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;
  margin-top: 24px;
}
.comp-stat {
  background: var(--surface); border-radius: 12px; padding: 16px 8px;
  border: 1px solid var(--border);
}
.comp-stat-num { font-size: 24px; font-weight: 900; }
.comp-stat-label { font-size: 10px; color: var(--text2); margin-top: 2px; }
.graduated-flash {
  position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(81,207,102,.12); display: flex; align-items: center;
  justify-content: center; z-index: 200; opacity: 0;
  pointer-events: none; transition: opacity .4s;
}
.graduated-flash.show { opacity: 1; pointer-events: auto; }
.graduated-inner { text-align: center; }
.graduated-inner .icon { font-size: 80px; animation: bounce .6s ease; }
@keyframes bounce { 0%,100%{transform:scale(1)} 50%{transform:scale(1.3)} }

/* === ADD PROBLEM === */
.form-group { margin-bottom: 14px; }
.form-group label { display: block; font-size: 12px; font-weight: 500; color: var(--text2); margin-bottom: 6px; }
.form-input, .form-select, .form-textarea {
  width: 100%; padding: 12px 14px; border-radius: 10px;
  border: 1px solid var(--border); background: var(--surface);
  color: var(--text); font-size: 14px; font-family: inherit;
  outline: none; transition: border-color .2s;
}
.form-input:focus, .form-select:focus, .form-textarea:focus {
  border-color: var(--accent);
}
.form-textarea { min-height: 80px; resize: vertical; }
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.form-select { appearance: none; cursor: pointer; }
.btn-add {
  width: 100%; padding: 14px; border: none; border-radius: var(--radius);
  background: var(--accent); color: #fff; font-size: 15px; font-weight: 700;
  cursor: pointer; font-family: inherit; margin-top: 8px;
}
.queue-warning {
  background: rgba(255,217,61,.1); border: 1px solid rgba(255,217,61,.25);
  border-radius: 10px; padding: 10px 14px; margin-bottom: 14px;
  font-size: 12px; color: var(--warning);
}

/* === ZONE MAP (parent dashboard) === */
.zone-grid {
  display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
  margin-bottom: 16px;
}
.zone-card {
  background: var(--surface); border-radius: var(--radius);
  padding: 16px; border: 1px solid var(--border);
  position: relative;
}
.zone-card .num { font-size: 28px; font-weight: 900; }
.zone-card .label { font-size: 11px; color: var(--text2); margin-top: 2px; }
.zone-priority { border-color: rgba(255,107,107,.3); }
.zone-priority .num { color: var(--danger); }
.zone-graduated { border-color: rgba(81,207,102,.3); }
.zone-graduated .num { color: var(--success); }
.zone-frozen { border-color: rgba(116,192,252,.3); }
.zone-frozen .num { color: var(--frozen); }
.zone-review { border-color: rgba(255,217,61,.3); }
.zone-review .num { color: var(--warning); }

.subject-breakdown {
  background: var(--surface); border-radius: var(--radius);
  padding: 16px; margin-bottom: 16px;
  border: 1px solid var(--border);
}
.subject-row {
  display: flex; align-items: center; gap: 10px; margin-bottom: 10px;
}
.subject-row:last-child { margin-bottom: 0; }
.subject-name { font-size: 12px; width: 40px; color: var(--text2); }
.subject-bar-bg {
  flex: 1; height: 8px; background: var(--border); border-radius: 4px;
  overflow: hidden;
}
.subject-bar { height: 100%; border-radius: 4px; transition: width .5s; }
.subject-pct { font-size: 11px; width: 36px; text-align: right; color: var(--text2); }

/* === PROBLEM LIST === */
.filter-row {
  display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 14px;
}
.filter-chip {
  padding: 6px 14px; border-radius: 20px; font-size: 12px;
  border: 1px solid var(--border); background: transparent;
  color: var(--text2); cursor: pointer; font-family: inherit;
}
.filter-chip.active { background: var(--accent); color: #fff; border-color: var(--accent); }
.problem-list-item {
  background: var(--surface); border-radius: 12px;
  padding: 14px; margin-bottom: 8px;
  border: 1px solid var(--border);
  display: flex; align-items: center; gap: 12px;
  cursor: pointer; transition: border-color .2s;
}
.problem-list-item:hover { border-color: var(--accent); }
.pli-status {
  width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0;
}
.pli-info { flex: 1; min-width: 0; }
.pli-topic { font-size: 13px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.pli-sub { font-size: 11px; color: var(--text2); }
.pli-next { font-size: 10px; color: var(--text2); text-align: right; }
.pli-actions { display: flex; gap: 6px; }
.btn-freeze {
  padding: 4px 10px; border-radius: 6px; font-size: 10px;
  border: 1px solid var(--frozen); background: rgba(116,192,252,.1);
  color: var(--frozen); cursor: pointer; font-family: inherit;
}
.btn-delete-p {
  padding: 4px 10px; border-radius: 6px; font-size: 10px;
  border: 1px solid var(--danger); background: rgba(255,107,107,.08);
  color: var(--danger); cursor: pointer; font-family: inherit;
}

/* === SETTINGS === */
.setting-card {
  background: var(--surface); border-radius: var(--radius);
  padding: 16px; margin-bottom: 12px;
  border: 1px solid var(--border);
}
.setting-card h3 { font-size: 14px; font-weight: 700; margin-bottom: 10px; }
.setting-row {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 8px;
}
.setting-row:last-child { margin-bottom: 0; }
.setting-label { font-size: 13px; color: var(--text2); }
.setting-val { font-size: 13px; font-weight: 700; }
.range-input { width: 120px; accent-color: var(--accent); }
.btn-export, .btn-import-label {
  display: inline-block; padding: 10px 20px; border-radius: 10px;
  background: var(--surface2); color: var(--text); font-size: 13px;
  font-weight: 500; border: 1px solid var(--border);
  cursor: pointer; font-family: inherit; text-align: center;
}
.btn-danger {
  background: rgba(255,107,107,.1); border-color: rgba(255,107,107,.3);
  color: var(--danger);
}
#importFile { display: none; }

/* === IMAGE UPLOAD === */
.img-drop {
  border: 2px dashed var(--border); border-radius: 10px;
  padding: 20px; text-align: center; cursor: pointer;
  transition: border-color .2s, background .2s;
  color: var(--text2); font-size: 12px; position: relative;
  min-height: 60px; display: flex; align-items: center;
  justify-content: center; flex-direction: column; gap: 6px;
}
.img-drop:hover, .img-drop.dragover {
  border-color: var(--accent); background: rgba(108,99,255,.05);
}
.img-drop input[type="file"] {
  position: absolute; inset: 0; opacity: 0; cursor: pointer;
}
.img-drop img {
  max-width: 100%; max-height: 200px; border-radius: 6px;
}
.img-drop .remove-img {
  position: absolute; top: 6px; right: 6px;
  width: 24px; height: 24px; border-radius: 50%;
  background: var(--danger); color: #fff; border: none;
  font-size: 14px; cursor: pointer; display: flex;
  align-items: center; justify-content: center; line-height: 1;
}
.form-group-rel { position: relative; }
.form-tab-row {
  display: flex; gap: 0; margin-bottom: 8px;
}
.form-tab {
  flex: 1; padding: 8px; border: 1px solid var(--border);
  background: transparent; color: var(--text2); font-size: 12px;
  cursor: pointer; font-family: inherit; transition: all .2s;
}
.form-tab:first-child { border-radius: 8px 0 0 8px; }
.form-tab:last-child { border-radius: 0 8px 8px 0; }
.form-tab.active { background: var(--accent); color: #fff; border-color: var(--accent); }

/* === EMPTY STATE === */
.empty-state {
  text-align: center; padding: 60px 20px;
}
.empty-state .icon { font-size: 48px; margin-bottom: 12px; opacity: .5; }
.empty-state p { color: var(--text2); font-size: 14px; }

/* scroll top padding */
.screen { padding-top: max(env(safe-area-inset-top, 16px), 52px); }

/* === iPad landscape 2-column layout === */
/* --- LANDSCAPE 2-COLUMN LAYOUT --- */
.today-layout { display:block; }
.today-left, .today-right { display:block; }
@media(min-width:1024px) {
  nav.nav{display:none!important}
  .nav-side{display:flex!important}
  .timer-bar{left:72px}
  .screen { max-width:none; padding:56px 16px 8px 16px; margin-left:72px; }
  /* Today: 2-column, left=info+problem, right=scratchpad */
  .today-layout{display:grid;grid-template-columns:340px 1fr;gap:12px;height:calc(100vh - 64px)}
  .today-left{overflow-y:auto;max-height:calc(100vh - 64px);padding-right:8px;-webkit-overflow-scrolling:touch}
  .today-right{overflow:hidden;height:calc(100vh - 64px);display:flex;flex-direction:column}
  .today-right .scratchpad-wrap{flex:1;display:flex;flex-direction:column}
  .today-right .scratchpad-canvas{flex:1;min-height:0!important;width:100%!important}
  .today-left .card-wrap{display:flex!important}
  /* Compact left pane */
  .queue-summary{padding:10px}
  .queue-count{font-size:20px}
  .today-left .header{margin-bottom:2px}
  .today-left .header h1{font-size:15px}
  .today-left .streak-bar{padding:6px 10px;margin-bottom:6px}
  .today-left .streak-num{font-size:16px}
  .screen{padding-bottom:4px!important}
}

/* Image canvas overlay for drawing on problem image */
.img-canvas-wrap {
  position: relative; width: 100%; background: #fff; border-radius: 8px; overflow: hidden;
  -webkit-user-select:none; user-select:none; -webkit-touch-callout:none;
}
.img-canvas-wrap img { display: block; width: 100%; }
.img-canvas-wrap canvas {
  position: absolute; top: 0; left: 0; width: 100%; height: 100%;
  touch-action: none; cursor: crosshair; z-index: 2;
}
.img-draw-hint {
  font-size: 10px; color: var(--accent); text-align: center; margin-top: 4px;
}

/* freeze candidate notification */
.freeze-alert {
  background: rgba(116,192,252,.1); border: 1px solid rgba(116,192,252,.25);
  border-radius: 10px; padding: 12px 14px; margin-bottom: 14px;
  font-size: 12px; color: var(--frozen); display: flex; align-items: center; gap: 10px;
}
.freeze-alert button {
  padding: 5px 12px; border-radius: 6px; font-size: 11px;
  border: 1px solid var(--frozen); background: rgba(116,192,252,.15);
  color: var(--frozen); cursor: pointer; font-family: inherit; white-space: nowrap;
}
@keyframes fadeInOut { 0%{opacity:0;transform:translateY(-8px)} 15%{opacity:1;transform:translateY(0)} 85%{opacity:1} 100%{opacity:0} }
.quick-mode .normal-only { display: none !important; }
.quick-mode #contentImageArea { display: block !important; }
.quick-mode #contentTextArea { display: none !important; }
.quick-mode #answerTextArea { display: none !important; }
.quick-mode #answerImageArea { display: none !important; }
</style>
</head>
<body>

<!-- TIMER BAR -->
<div class="timer-bar">
  <div style="display:flex;align-items:center;gap:8px">
    <div class="timer-display" id="timerDisplay">25:00</div>
    <button class="timer-btn" id="timerStartBtn" onclick="toggleTimer()">â–¶</button>
    <button class="timer-btn" onclick="resetTimer()">â†º</button>
    <button class="timer-btn" id="timerModeBtn" onclick="cycleTimerMode()">25åˆ†</button>
  </div>
  <div id="countdownBadge" class="countdown-badge"></div>
</div>

<!-- SIDEBAR NAV (landscape) -->
<nav class="nav-side" id="navSide">
  <div class="s-logo">rn<div style="font-size:8px;color:var(--text2);font-weight:400">v2.5</div></div>
  <button class="s-item active" data-screen="Today" onclick="switchScreen('Today')"><span>âš”ï¸</span>ä»Šæ—¥</button>
  <button class="s-item" data-screen="Add" onclick="switchScreen('Add')"><span>ğŸ“¸</span>ç™»éŒ²</button>
  <button class="s-item" data-screen="List" onclick="switchScreen('List')"><span>ğŸ“š</span>ä¸€è¦§</button>
  <button class="s-item" data-screen="Dash" onclick="switchScreen('Dash')"><span>ğŸ“Š</span>åˆ†æ</button>
  <button class="s-item" data-screen="Settings" onclick="switchScreen('Settings')"><span>âš™ï¸</span>è¨­å®š</button>
  <div style="flex:1"></div>
  <button class="s-item" onclick="toggleTheme()" id="sideThemeBtn"><span>ğŸŒ™</span>ãƒ†ãƒ¼ãƒ</button>
</nav>

<!-- === GRADUATED FLASH === -->
<div class="graduated-flash" id="graduatedFlash">
  <div class="graduated-inner">
    <div class="icon">ğŸ‰</div>
    <h2 style="font-size:22px;font-weight:900;margin-top:12px">å®šç€ãŠã‚ã§ã¨ã†ï¼</h2>
    <p id="graduatedMsg" style="color:var(--text2);font-size:14px;margin-top:6px"></p>
  </div>
</div>

<!-- === SCREEN: TODAY === -->
<div class="screen active" id="screenToday">
  <div class="today-layout">
    <!-- LEFT PANE: today info + problem/answer -->
    <div class="today-left">
      <div class="header">
        <div>
          <h1>ğŸ““ revnote</h1>
          <div class="header-sub" id="todayDate"></div>
        </div>
      </div>
      <div id="examCountdown" class="card" style="display:none;text-align:center;background:linear-gradient(135deg,rgba(108,99,255,.08),rgba(78,205,196,.08));margin-bottom:12px;border-radius:var(--radius);padding:16px;border:1px solid var(--border)">
        <div style="font-size:11px;color:var(--text2)" id="examLabel"></div>
        <div style="font-size:36px;font-weight:900;background:var(--grad1);-webkit-background-clip:text;-webkit-text-fill-color:transparent" id="examDays"></div>
        <div style="font-size:12px;color:var(--text2)">æ—¥</div>
      </div>
      <div class="streak-bar">
        <div class="streak-fire">ğŸ”¥</div>
        <div>
          <div class="streak-num" id="streakCount">0</div>
          <div class="streak-label">æ—¥é€£ç¶š</div>
        </div>
        <div class="streak-days" id="streakDots"></div>
      </div>
      <div id="monthTopics" class="card" style="display:none;background:var(--surface);border-radius:var(--radius);padding:12px 16px;border:1px solid var(--border);margin-bottom:12px">
        <div style="font-size:11px;color:var(--text2);margin-bottom:4px">ğŸ“– ä»Šæœˆã®å­¦ç¿’å˜å…ƒ</div>
        <div id="monthTopicsList" style="font-size:13px;font-weight:600"></div>
      </div>
      <div id="freezeAlerts"></div>
      <div class="queue-summary" id="queueSummary">
        <div class="queue-count" id="queueCount">0</div>
        <div class="queue-label">å• ã‚„ã‚‹ã¹ãå•é¡Œ</div>
        <div class="queue-progress"><div class="queue-progress-fill" id="queueProgress" style="width:0%"></div></div>
        <div id="queueBreakdown" style="font-size:11px;color:var(--text2);margin-top:8px"></div>
        <div id="queueStretchBar" style="margin-top:6px"></div>
        <!-- Session filter -->
        <div id="sessionFilter" style="margin-top:10px;padding:10px;background:var(--surface2);border-radius:10px">
          <div style="font-size:11px;font-weight:600;margin-bottom:6px;color:var(--text2)">ğŸ“š ä»Šå›ã‚„ã‚‹ç¯„å›²</div>
          <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:6px" id="filterSubjectChips"></div>
          <div style="display:flex;gap:6px;flex-wrap:wrap" id="filterTypeChips">
            <button class="filter-chip active" onclick="setSessionType('all',this)">å…¨éƒ¨</button>
            <button class="filter-chip" onclick="setSessionType('think',this)">ğŸ§  æ€è€ƒ</button>
            <button class="filter-chip" onclick="setSessionType('flash',this)">âš¡ æš—è¨˜</button>
          </div>
        </div>
        <!-- XP & Level -->
        <div id="playerStats" style="margin-top:10px;display:flex;align-items:center;gap:10px">
          <div style="font-size:13px;font-weight:700" id="playerLevel">Lv.1</div>
          <div style="flex:1;height:8px;background:var(--surface2);border-radius:4px;overflow:hidden">
            <div id="xpBar" style="height:100%;background:linear-gradient(90deg,var(--accent),#ff6b6b);border-radius:4px;width:0%;transition:width .5s"></div>
          </div>
          <div style="font-size:10px;color:var(--text2)" id="xpText">0 / 100 XP</div>
        </div>
        <button class="btn-start" id="btnStart" onclick="startFilteredSession()">å¾©ç¿’ã‚’ã¯ã˜ã‚ã‚‹</button>
      </div>
      <div class="completion" id="completionView" style="display:none">
        <div class="completion-icon">ğŸ†</div>
        <h2>ä»Šæ—¥ã®ãƒªãƒ™ãƒ³ã‚¸å®Œäº†ï¼</h2>
        <p id="completionMsg"></p>
        <div class="completion-stats" id="completionStats"></div>
      </div>
      <!-- Problem card + answer (in left pane) -->
      <div class="card-wrap" id="cardWrap">
        <div id="cardProgress" style="font-size:12px;color:var(--text2);text-align:center"></div>
        <!-- Problem Timer -->
        <div id="problemTimer" style="display:none;text-align:center;margin:6px 0">
          <div style="display:flex;align-items:center;justify-content:center;gap:8px">
            <span id="timerDisplay" style="font-size:20px;font-weight:800;font-family:'JetBrains Mono',monospace;color:var(--accent)">5:00</span>
            <span id="timerLabel" style="font-size:10px;color:var(--text2)">ğŸ§  æ€è€ƒã‚¿ã‚¤ãƒ </span>
          </div>
          <div style="height:3px;background:var(--surface2);border-radius:2px;margin-top:4px;overflow:hidden">
            <div id="timerBar" style="height:100%;background:var(--accent);border-radius:2px;width:100%;transition:width 1s linear"></div>
          </div>
        </div>
        <div class="problem-card" id="problemCard"></div>
        <!-- Hint button (before reveal) -->
        <button class="btn-reveal" id="btnHint" onclick="showHint()" style="display:none;background:var(--surface2);border-color:var(--border);color:var(--text2)">ğŸ’¡ ãƒ’ãƒ³ãƒˆã‚’è¦‹ã‚‹</button>
        <div id="hintSection" style="display:none;padding:10px 14px;background:rgba(255,193,7,.08);border:1px solid rgba(255,193,7,.2);border-radius:8px;margin:6px 0;font-size:13px;color:var(--warning)"></div>
        <button class="btn-reveal" id="btnReveal" onclick="revealAnswer()">ğŸ‘ ç­”ãˆã‚’è¦‹ã‚‹</button>
        <div class="answer-section" id="answerSection"></div>
        <div class="review-memo" id="reviewMemo" style="display:none">
          <textarea id="reviewMemoText" placeholder="ãƒ¡ãƒ¢ï¼ˆæ°—ã¥ã„ãŸã“ã¨ã€é–“é•ãˆãŸãƒã‚¤ãƒ³ãƒˆãªã©ï¼‰"></textarea>
        </div>
        <div class="answer-btns" id="answerBtns" style="display:none">
          <button class="btn-ans btn-wrong" onclick="recordAnswer(0)">âŒ ã§ããªã‹ã£ãŸ</button>
          <button class="btn-ans btn-hard" onclick="recordAnswer(3)">ğŸ¤” ã‚ã‚„ã—ã„</button>
          <button class="btn-ans btn-correct" onclick="recordAnswer(5)">âœ… ã§ããŸï¼</button>
        </div>
        <!-- Mistake reason (shown after âŒ) -->
        <div id="mistakeReason" style="display:none;margin-top:8px;text-align:center">
          <div style="font-size:11px;color:var(--text2);margin-bottom:6px">é–“é•ãˆãŸç†ç”±ã¯ï¼Ÿ</div>
          <div style="display:flex;gap:6px;justify-content:center;flex-wrap:wrap">
            <button class="filter-chip" onclick="tagMistake('è¨ˆç®—ãƒŸã‚¹')">ğŸ”¢ è¨ˆç®—ãƒŸã‚¹</button>
            <button class="filter-chip" onclick="tagMistake('èª­ã¿é•ã„')">ğŸ“– èª­ã¿é•ã„</button>
            <button class="filter-chip" onclick="tagMistake('è§£æ³•ä¸æ˜')">â“ è§£æ³•ä¸æ˜</button>
            <button class="filter-chip" onclick="tagMistake('æ™‚é–“åˆ‡ã‚Œ')">â° æ™‚é–“åˆ‡ã‚Œ</button>
            <button class="filter-chip" onclick="tagMistake('')">ã‚¹ã‚­ãƒƒãƒ—</button>
          </div>
        </div>
        <button class="btn-skip" id="btnSkip" onclick="skipProblem()" style="display:none">â­ ã‚¹ã‚­ãƒƒãƒ—</button>
        <!-- Swipe hint for flash -->
        <div id="swipeHint" style="display:none;text-align:center;font-size:10px;color:var(--text2);margin-top:6px">
          â† ã‚¹ãƒ¯ã‚¤ãƒ—: âŒ ã§ããªã‹ã£ãŸ ï½œ ã‚¹ãƒ¯ã‚¤ãƒ— â†’: âœ… ã§ããŸ
        </div>
      </div>
      <div class="card" id="calCard" style="margin-top:12px;background:var(--surface);border-radius:var(--radius);padding:12px 16px;border:1px solid var(--border)">
        <div style="display:flex;justify-content:space-between;align-items:center;cursor:pointer" onclick="toggleCalendar()">
          <span style="font-size:12px;font-weight:600">ğŸ“… å­¦ç¿’ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</span>
          <span id="calToggle" style="font-size:14px;color:var(--text2);transition:transform .2s">â–¶</span>
        </div>
        <div id="calBody" style="display:none;margin-top:8px">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <button class="sp-btn" onclick="calNav(-1)">â—€</button>
            <h3 id="calTitle" style="font-size:13px;font-weight:700"></h3>
            <button class="sp-btn" onclick="calNav(1)">â–¶</button>
          </div>
          <div class="cal-grid" id="calGrid"></div>
        </div>
      </div>
    </div>
    <!-- RIGHT PANE: scratchpad only -->
    <div class="today-right">
      <div class="scratchpad-wrap" id="scratchpadWrap">
        <div class="scratchpad-toolbar" id="scratchpadToolbar">
          <button class="sp-btn" onclick="clearScratchpad()">ãƒªã‚»ãƒƒãƒˆ</button>
          <button class="sp-btn" id="spEraser" onclick="toggleEraser()">æ¶ˆã—ã‚´ãƒ </button>
          <input type="range" min="1" max="8" value="3" id="spLineWidth" style="width:50px;accent-color:var(--accent)">
          <div class="sp-color active" style="background:#333" onclick="setScratchColor('#333',this)"></div>
          <div class="sp-color" style="background:#6c63ff" onclick="setScratchColor('#6c63ff',this)"></div>
          <div class="sp-color" style="background:#ff6b6b" onclick="setScratchColor('#ff6b6b',this)"></div>
          <div class="sp-color" style="background:#51cf66" onclick="setScratchColor('#51cf66',this)"></div>
        </div>
        <canvas class="scratchpad-canvas" id="scratchpadCanvas" width="500" height="350"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- === SCREEN: ADD === -->
<div class="screen" id="screenAdd">
  <div class="header"><h1>å•é¡Œã‚’ç™»éŒ²</h1></div>
  <div id="addQueueWarning"></div>

  <!-- Mode toggle -->
  <div style="display:flex;gap:8px;margin-bottom:14px">
    <button class="filter-chip active" id="modeNormal" onclick="setAddMode('normal')">é€šå¸¸ç™»éŒ²</button>
    <button class="filter-chip" id="modeQuick" onclick="setAddMode('quick')">ğŸ“· ã‹ã‚“ãŸã‚“ç™»éŒ²</button>
  </div>

  <!-- Quick mode hint -->
  <div id="quickModeHint" style="display:none;background:var(--surface2);padding:10px 14px;border-radius:10px;margin-bottom:12px;font-size:12px;color:var(--text2)">
    ğŸ“· æ•™ç§‘ã‚’é¸ã‚“ã§å†™çœŸã‚’æ’®ã‚‹ã ã‘ã€‚å˜å…ƒã‚„ç­”ãˆã¯å¾Œã‹ã‚‰è¿½åŠ ã§ãã¾ã™ã€‚
  </div>

  <div class="form-group">
    <label>æ•™ç§‘</label>
    <select class="form-select" id="addSubject" onchange="onSubjectChange()">
      <option value="ç®—æ•°">ç®—æ•°</option>
      <option value="å›½èª">å›½èª</option>
      <option value="ç†ç§‘">ç†ç§‘</option>
      <option value="ç¤¾ä¼š">ç¤¾ä¼š</option>
    </select>
  </div>
  <div class="form-group normal-only">
    <label>å˜å…ƒã‚«ãƒ†ã‚´ãƒª</label>
    <select class="form-select" id="addTopicCategory" onchange="onCategoryChange()">
      <option value="">-- ã‚«ãƒ†ã‚´ãƒª --</option>
    </select>
  </div>
  <div class="form-group normal-only">
    <label>è©³ç´°ï¼ˆä»»æ„ï¼‰</label>
    <select class="form-select" id="addTopicDetail" onchange="onDetailChange()">
      <option value="">-- è©³ç´°ï¼ˆä»»æ„ï¼‰ --</option>
    </select>
  </div>
  <div class="form-group normal-only">
    <label>å˜å…ƒï¼ˆæ‰‹å…¥åŠ›ãƒ»è£œè¶³ï¼‰</label>
    <input class="form-input" id="addTopic" placeholder="ã‚«ãƒ†ã‚´ãƒªé¸æŠã§è‡ªå‹•å…¥åŠ› / æ‰‹å…¥åŠ›OK">
  </div>
  <div class="form-group">
    <label>å‡ºå…¸</label>
    <input class="form-input" id="addSource" placeholder="ä¾‹: äºˆç¿’ã‚·ãƒªãƒ¼ã‚º 5å¹´ä¸‹ ç¬¬12å› p.45">
  </div>

  <!-- å•é¡Œ content: text or image -->
  <div class="form-group">
    <label>å•é¡Œã®å†…å®¹</label>
    <div class="form-tab-row normal-only">
      <button class="form-tab active" onclick="switchContentTab('text')" id="contentTabText">ãƒ†ã‚­ã‚¹ãƒˆ</button>
      <button class="form-tab" onclick="switchContentTab('image')" id="contentTabImage">ç”»åƒ</button>
    </div>
    <div id="contentTextArea" class="normal-only">
      <textarea class="form-textarea" id="addContent" placeholder="å•é¡Œã®è¦ç´„ã‚„ãƒ¡ãƒ¢"></textarea>
    </div>
    <div id="contentImageArea" style="display:none">
      <div class="img-drop" id="contentImgDrop">
        <input type="file" accept="image/*" onchange="handleImgUpload(event,'content')">
        <div id="contentImgPreview">ğŸ“· ã‚¿ãƒƒãƒ—ã§é¸æŠ / ãƒšãƒ¼ã‚¹ãƒˆã‚‚å¯</div>
      </div>
      <button class="sp-btn" style="margin-top:6px;width:100%;padding:10px" onclick="pasteFromClipboard('content')">ğŸ“‹ ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‹ã‚‰è²¼ã‚Šä»˜ã‘</button>
    </div>
  </div>

  <!-- ç­”ãˆãƒ»è§£èª¬: text or image -->
  <div class="form-group normal-only">
    <label>ç­”ãˆãƒ»è§£èª¬</label>
    <div class="form-tab-row">
      <button class="form-tab active" onclick="switchAnswerTab('text')" id="answerTabText">ãƒ†ã‚­ã‚¹ãƒˆ</button>
      <button class="form-tab" onclick="switchAnswerTab('image')" id="answerTabImage">ç”»åƒ</button>
    </div>
    <div id="answerTextArea">
      <input class="form-input" id="addAnswer" placeholder="ä¾‹: 3:5">
    </div>
    <div id="answerImageArea" style="display:none">
      <div class="img-drop" id="answerImgDrop">
        <input type="file" accept="image/*" onchange="handleImgUpload(event,'answer')">
        <div id="answerImgPreview">ğŸ“· ã‚¿ãƒƒãƒ—ã§é¸æŠ / ãƒšãƒ¼ã‚¹ãƒˆã‚‚å¯</div>
      </div>
      <button class="sp-btn" style="margin-top:6px;width:100%;padding:10px" onclick="pasteFromClipboard('answer')">ğŸ“‹ ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‹ã‚‰è²¼ã‚Šä»˜ã‘</button>
    </div>
  </div>

  <div class="form-row normal-only">
    <div class="form-group">
      <label><input type="checkbox" id="addRateCheck" onchange="toggleRateSlider()"> æ­£ç­”ç‡ã‚’å…¥åŠ›ã™ã‚‹ï¼ˆãƒ†ã‚¹ãƒˆã§åˆ¤æ˜ã—ã¦ã„ã‚Œã°ï¼‰</label>
      <div id="rateSliderWrap" style="display:none;margin-top:8px">
        <div style="display:flex;align-items:center;gap:8px">
          <input type="range" class="range-input" id="addCorrectRate" min="0" max="100" value="50" style="flex:1;width:auto" oninput="updateRateLabel()">
          <span class="setting-val" id="rateLabel" style="min-width:44px;text-align:right">50%</span>
        </div>
        <div id="rateHint" style="font-size:11px;color:var(--text2);margin-top:4px"></div>
      </div>
    </div>
  </div>
  <div class="form-row normal-only">
    <div class="form-group">
      <label>é »å‡ºåº¦</label>
      <select class="form-select" id="addFreq">
        <option value="high">é«˜ï¼ˆã‚ˆãå‡ºã‚‹ï¼‰</option>
        <option value="medium" selected>ä¸­</option>
        <option value="low">ä½ï¼ˆã‚ã£ãŸã«å‡ºãªã„ï¼‰</option>
      </select>
    </div>
    <div class="form-group">
      <label>é›£æ˜“åº¦</label>
      <select class="form-select" id="addDiff">
        <option value="basic">åŸºæœ¬</option>
        <option value="standard" selected>æ¨™æº–</option>
        <option value="hard">å¿œç”¨</option>
      </select>
    </div>
  </div>
  <!-- Tags -->
  <div class="form-group">
    <label>ã‚¿ã‚°ï¼ˆã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Šï¼‰</label>
    <input class="form-input" id="addTags" placeholder="ä¾‹: ãƒ†ã‚¹ãƒˆç›´ã— è‹¦æ‰‹ è¦å¾©ç¿’">
    <div id="tagSuggestions" style="display:flex;gap:6px;flex-wrap:wrap;margin-top:6px"></div>
  </div>
  <button class="btn-add" onclick="addProblem()">ç™»éŒ²ã™ã‚‹</button>
  <div id="addSuccessToast" style="display:none;background:var(--success);color:#fff;padding:10px 16px;border-radius:10px;margin-top:10px;font-size:14px;font-weight:600;text-align:center"></div>
  <div id="addContinueHint" style="display:none;text-align:center;margin-top:8px;font-size:12px;color:var(--text2)">
    å‡ºå…¸ãƒ»æ•™ç§‘ãƒ»å˜å…ƒã¯ãã®ã¾ã¾ã€‚ç¶šã‘ã¦ç™»éŒ²ã§ãã¾ã™ã€‚
  </div>
</div>

<!-- === SCREEN: LIST === -->
<div class="screen" id="screenList">
  <div class="header"><h1>å•é¡Œä¸€è¦§</h1></div>
  <div class="filter-row" id="filterRow"></div>
  <div class="filter-row" id="subjectFilterRow" style="margin-top:-6px"></div>
  <div class="filter-row" id="tagFilterRow" style="margin-top:-6px"></div>
  <div style="display:flex;gap:8px;margin-bottom:12px;align-items:center">
    <span style="font-size:11px;color:var(--text2)">ä¸¦æ›¿:</span>
    <select class="form-select" id="listSort" onchange="renderList()" style="width:auto;padding:6px 10px;font-size:11px">
      <option value="next">å¾©ç¿’æ—¥é †</option>
      <option value="created">ç™»éŒ²æ—¥é †</option>
      <option value="topic">å˜å…ƒé †</option>
      <option value="failures">è‹¦æ‰‹é †</option>
      <option value="recentWrong">æœ€è¿‘é–“é•ãˆãŸé †</option>
      <option value="almostMastered">ã‚‚ã†ã™ãå®šç€</option>
      <option value="longIdle">é•·æœŸæ”¾ç½®</option>
    </select>
  </div>
  <div id="problemListContainer"></div>
</div>

<!-- === SCREEN: DASHBOARD === -->
<div class="screen" id="screenDash">
  <div class="header"><h1>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1></div>
  <div style="margin-bottom:16px">
    <h3 style="font-size:14px;font-weight:700;margin-bottom:10px">ğŸ¯ ã‚¹ãƒˆãƒ¬ãƒƒãƒã‚¾ãƒ¼ãƒ³</h3>
    <div style="font-size:11px;color:var(--text2);margin-bottom:8px">æœ€é©ãªè² è·ã®å•é¡Œã‚’å„ªå…ˆå‡ºé¡Œ</div>
    <div id="stretchZoneGrid"></div>
    <div id="szDetailPanel" style="display:none;margin-top:8px;padding:12px;background:var(--surface);border-radius:var(--radius);border:1px solid var(--border)">
      <h4 id="szDetailTitle" style="font-size:12px;font-weight:700;margin-bottom:6px"></h4>
      <div id="szDetailList" class="zone-detail"></div>
    </div>
  </div>
  <div class="filter-row" style="margin-bottom:8px"><select class="form-select" id="dashSubjectFilter" onchange="renderDashboard()" style="width:auto;padding:6px 12px;font-size:12px"><option value="">å…¨æ•™ç§‘</option></select></div>
  <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px"><select class="form-select" id="curriculumFilter" onchange="renderList()" style="width:auto;padding:6px 10px;font-size:11px"><option value="all">å…¨å˜å…ƒ</option><option value="learned">å±¥ä¿®æ¸ˆã¿</option><option value="upcoming">æœªå±¥ä¿®ï¼ˆå…ˆå–ã‚Šï¼‰</option></select></div>
  <div class="zone-grid" id="zoneGrid"></div>
  <div class="subject-breakdown" id="subjectBreakdown">
    <h3 style="font-size:13px;font-weight:700;margin-bottom:12px">æ•™ç§‘åˆ¥ å®šç€ç‡</h3>
    <div id="subjectBars"></div>
  </div>
  <div id="weeklyReport" style="background:var(--surface);border-radius:var(--radius);padding:16px;border:1px solid var(--border)">
    <h3 style="font-size:13px;font-weight:700;margin-bottom:10px">ä»Šé€±ã®ã¾ã¨ã‚</h3>
    <div id="weeklyContent" style="font-size:13px;color:var(--text2);line-height:1.7"></div>
  </div>
</div>

<!-- === SCREEN: SETTINGS === -->
<div class="screen" id="screenSettings">
  <div class="header"><h1>è¨­å®š</h1></div>
  <!-- Cloud Auth -->
  <div class="setting-card" id="authCard">
    <h3>â˜ï¸ ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸ</h3>
    <div id="authLoggedOut">
      <div style="font-size:12px;color:var(--text2);line-height:1.7;margin-bottom:10px">
        ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã¨å•é¡Œãƒ‡ãƒ¼ã‚¿ãŒã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜ã•ã‚Œã€<br>è¤‡æ•°ç«¯æœ«ã§åŒæœŸãƒ»è¦ªå­å…±æœ‰ãŒã§ãã¾ã™ã€‚
      </div>
      <div style="display:flex;flex-direction:column;gap:8px;max-width:300px">
        <input class="form-input" id="authEmail" type="email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹">
        <input class="form-input" id="authPassword" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆ6æ–‡å­—ä»¥ä¸Šï¼‰">
        <div style="display:flex;gap:8px">
          <button class="btn-export" onclick="authLogin()" style="flex:1;border-color:var(--accent);color:var(--accent)">ãƒ­ã‚°ã‚¤ãƒ³</button>
          <button class="btn-export" onclick="authSignup()" style="flex:1">æ–°è¦ç™»éŒ²</button>
        </div>
      </div>
      <div id="authMsg" style="font-size:12px;margin-top:8px;min-height:18px"></div>
    </div>
    <div id="authLoggedIn" style="display:none">
      <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
        <span style="font-size:13px">âœ… <strong id="authUserEmail"></strong></span>
        <button class="btn-export" onclick="cloudSync()" style="border-color:var(--accent);color:var(--accent)">ğŸ”„ ä»Šã™ãåŒæœŸ</button>
        <button class="btn-export" onclick="authLogout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      </div>
      <div id="syncStatus" style="font-size:11px;color:var(--text2);margin-top:6px"></div>
    </div>
  </div>
  <div class="setting-card"><h3>ğŸ‘¶ ãŠå­æ§˜æƒ…å ±</h3>
    <div class="setting-row"><span class="setting-label">ç”Ÿå¹´æœˆæ—¥</span><input type="date" class="form-input" id="settingBirthDate" onchange="saveBirthJuku()" style="width:auto"></div>
    <div class="setting-row" style="margin-top:8px"><span class="setting-label">æº–æ‹ å¡¾</span>
      <select class="form-select" id="settingJuku" onchange="saveBirthJuku()" style="width:auto;padding:6px 12px;font-size:13px">
        <option value="none">æŒ‡å®šãªã—ï¼ˆå…¨å•é¡Œè¡¨ç¤ºï¼‰</option>
        <option value="yotsuya">å››è°·å¤§å¡šï¼ˆäºˆç¿’ã‚·ãƒªãƒ¼ã‚ºï¼‰</option>
        <option value="sapix">SAPIX</option>
        <option value="nichinoken">æ—¥èƒ½ç ”</option>
      </select>
    </div>
    <div id="jukuInfo" style="margin-top:8px;font-size:12px;color:var(--text2)"></div>
  </div>
  <div class="setting-card"><h3>ğŸ¯ å…¥è©¦ç›®æ¨™</h3>
    <div class="setting-row"><span class="setting-label">å…¥è©¦æ—¥</span><input type="date" class="form-input" id="settingExamDate" onchange="saveExamGoal()" style="width:auto"></div>
    <div class="setting-row" style="margin-top:8px"><span class="setting-label">ç›®æ¨™æ ¡</span><input class="form-input" id="settingExamName" onchange="saveExamGoal()" placeholder="ä¾‹: é–‹æˆä¸­å­¦" style="width:180px"></div>
  </div>
  <div class="setting-card">
    <h3>ğŸ¨ ãƒ†ãƒ¼ãƒ</h3>
    <div class="setting-row">
      <span class="setting-label">è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰</span>
      <button class="btn-export" id="settingThemeBtn" onclick="toggleTheme()" style="min-width:100px">ğŸŒ™ ãƒ€ãƒ¼ã‚¯</button>
    </div>
  </div>
  <div class="setting-card">
    <h3>å­¦æ ¡æ®µéš</h3>
    <div class="setting-row">
      <span class="setting-label">å¯¾è±¡</span>
      <select class="form-select" id="settingSchoolLevel" onchange="onSchoolLevelChange()" style="width:auto;padding:8px 14px">
        <option value="elementary">å°å­¦ç”Ÿï¼ˆä¸­å­¦å—é¨“ï¼‰</option>
        <option value="secondary">ä¸­å­¦ãƒ»é«˜æ ¡ç”Ÿ</option>
      </select>
    </div>
  </div>
  <div class="setting-card">
    <h3>å¾©ç¿’è¨­å®š</h3>
    <div class="setting-row">
      <span class="setting-label">1æ—¥ã®ä¸Šé™</span>
      <span><input type="range" class="range-input" id="settingCap" min="5" max="30" value="15" oninput="updateCapLabel()"> <span class="setting-val" id="capLabel">15å•</span></span>
    </div>
    <div class="setting-row">
      <span class="setting-label">è‡ªå‹•å‡çµï¼ˆé€£ç¶šä¸æ­£è§£ï¼‰</span>
      <span><input type="range" class="range-input" id="settingFreeze" min="3" max="10" value="5" oninput="updateFreezeLabel()"> <span class="setting-val" id="freezeLabel">5å›</span></span>
    </div>
  </div>
  <div class="setting-card"><h3>ğŸ”„ è¦ªå­åŒæœŸ</h3>
    <div style="font-size:12px;color:var(--text2);line-height:1.7;margin-bottom:10px">
      è¦ªã®iPadã§ç™»éŒ² â†’ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ â†’ å­ã®iPadã§ã‚¤ãƒ³ãƒãƒ¼ãƒˆ<br>
      <strong style="color:var(--accent)">å…±æœ‰ãƒªãƒ³ã‚¯:</strong> URLã«ãƒ‡ãƒ¼ã‚¿ã‚’åŸ‹ã‚è¾¼ã¿ã€‚ã‚µãƒ¼ãƒãƒ¼ä¸è¦ã§åŒæœŸã€‚
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
      <button class="btn-export" onclick="generateShareLink()" style="border-color:var(--accent);color:var(--accent)">ğŸ”— å…±æœ‰ãƒªãƒ³ã‚¯ç”Ÿæˆ</button>
      <button class="btn-export" onclick="importFromURL()">ğŸ“² ãƒªãƒ³ã‚¯ã‹ã‚‰å–è¾¼</button>
    </div>
    <div id="shareLinkArea" style="display:none;margin-top:8px">
      <textarea id="shareLinkText" class="form-textarea" style="min-height:40px;font-size:10px" readonly></textarea>
      <button class="sp-btn" onclick="navigator.clipboard.writeText(document.getElementById('shareLinkText').value);alert('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ')" style="margin-top:4px">ã‚³ãƒ”ãƒ¼</button>
    </div>
  </div>
  <div class="setting-card">
    <h3>ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h3>
    <div style="display:flex;gap:10px;flex-wrap:wrap">
      <button class="btn-export" onclick="exportData()">ğŸ“¤ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
      <label class="btn-import-label">ğŸ“¥ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ<input type="file" id="importFile" accept=".json" onchange="importData(event)"></label>
    </div>
    <div style="margin-top:12px">
      <button class="btn-export btn-danger" onclick="if(confirm('å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ'))resetAll()">ğŸ—‘ å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤</button>
    </div>
    <div style="margin-top:12px">
      <button class="btn-export" onclick="loadSampleData()">ğŸ“‹ ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€ï¼ˆ4ãƒ»5ãƒ»6å¹´ å…¨æ•™ç§‘ï¼‰</button>
    </div>
  </div>
  <div class="setting-card">
    <h3>å¿˜å´æ›²ç·šã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ </h3>
    <div style="font-size:12px;color:var(--text2);line-height:1.8">
      SM-2ãƒ™ãƒ¼ã‚¹ã®é–“éš”åå¾©ã‚’ä½¿ç”¨ã€‚<br>
      æ­£è§£ã®ãŸã³ã«å¾©ç¿’é–“éš”ãŒä¼¸ã³ã¾ã™ï¼ˆ1æ—¥â†’3æ—¥â†’7æ—¥â†’14æ—¥â†’30æ—¥â†’â€¦ï¼‰ã€‚<br>
      ä¸æ­£è§£ã§é–“éš”ãƒªã‚»ãƒƒãƒˆã€‚ã€Œã‚ã‚„ã—ã„ã€ã¯é–“éš”ã‚’åŠåˆ†ã«ã€‚<br>
      <strong style="color:var(--text)">EaseFactor</strong>ãŒå›ç­”ã®è³ªã§å‹•çš„ã«å¤‰åŒ–ã—ã€å¾—æ„ãªå•é¡Œã¯é–“éš”ãŒåŠ é€Ÿåº¦çš„ã«ä¼¸ã³ã¾ã™ã€‚<br>
      <strong style="color:var(--danger)">é€£ç¶šä¸æ­£è§£<span id="algoFreezeN">5</span>å›</strong>ã§è‡ªå‹•å‡çµå€™è£œã«ã€‚
    </div>
  </div>
  <div style="text-align:center;padding:16px 0 8px;font-size:11px;color:var(--text2)">revnote v2.5</div>
</div>
<nav class="nav">
  <button class="nav-item active" onclick="switchScreen('Today')">
    <span style="font-size:20px">âš”ï¸</span>
    ä»Šæ—¥
  </button>
  <button class="nav-item" onclick="switchScreen('Add')">
    <span style="font-size:20px">ğŸ“¸</span>
    ç™»éŒ²
  </button>
  <button class="nav-item" onclick="switchScreen('List')">
    <span style="font-size:20px">ğŸ“š</span>
    ä¸€è¦§
  </button>
  <button class="nav-item" onclick="switchScreen('Dash')">
    <span style="font-size:20px">ğŸ“Š</span>
    åˆ†æ
  </button>
  <button class="nav-item" onclick="switchScreen('Settings')">
    <span style="font-size:20px">âš™ï¸</span>
    è¨­å®š
  </button>
</nav>

<script>
// ================================================================
// DATA LAYER
// ================================================================
var STORAGE_KEY = 'revengeNote_v1';
var today = () => new Date().toISOString().split('T')[0];

// ================================================================
// SUPABASE
// ================================================================
var SUPABASE_URL = 'https://hciwivjeuqgywwjdeegn.supabase.co';
var SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhjaXdpdmpldXFneXd3amRlZWduIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIyMzI3MDAsImV4cCI6MjA4NzgwODcwMH0.UHUsaMgz-RaCb_fPVNnw2TQnwKsu9_w1NSG-ngNSRt8';
var supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
var _syncTimer = null;
var _currentUser = null;

function loadData() {
  var raw = localStorage.getItem(STORAGE_KEY);
  if (!raw) return defaultData();
  try { return JSON.parse(raw); } catch { return defaultData(); }
}
function saveData(d) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(d));
  // Debounced cloud sync
  if (_currentUser) {
    clearTimeout(_syncTimer);
    _syncTimer = setTimeout(function() { cloudSync(true); }, 3000);
  }
}
function defaultData() {
  return {
    version: '1.0',
    problems: [],
    settings: { dailyCap: 15, freezeThreshold: 5 },
    streak: { count: 0, lastDate: null, history: [] },
    sessionLog: []
  };
}

// Auth functions
async function authSignup() {
  var email = document.getElementById('authEmail').value.trim();
  var pass = document.getElementById('authPassword').value;
  var msg = document.getElementById('authMsg');
  if (!email || pass.length < 6) { msg.textContent = 'ãƒ¡ãƒ¼ãƒ«ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆ6æ–‡å­—ä»¥ä¸Šï¼‰ã‚’å…¥åŠ›'; msg.style.color = 'var(--danger)'; return; }
  msg.textContent = 'ç™»éŒ²ä¸­...'; msg.style.color = 'var(--text2)';
  var res = await supabase.auth.signUp({ email: email, password: pass });
  if (res.error) { msg.textContent = res.error.message; msg.style.color = 'var(--danger)'; return; }
  if (res.data.user && !res.data.session) {
    msg.textContent = 'ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚ãƒ¡ãƒ¼ãƒ«å†…ã®ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‹ã‚‰å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚';
    msg.style.color = 'var(--accent)';
  } else {
    msg.textContent = 'ç™»éŒ²å®Œäº†ï¼';
    msg.style.color = 'var(--success)';
    onAuthStateChange(res.data.session);
  }
}

async function authLogin() {
  var email = document.getElementById('authEmail').value.trim();
  var pass = document.getElementById('authPassword').value;
  var msg = document.getElementById('authMsg');
  if (!email || !pass) { msg.textContent = 'ãƒ¡ãƒ¼ãƒ«ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›'; msg.style.color = 'var(--danger)'; return; }
  msg.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³ä¸­...'; msg.style.color = 'var(--text2)';
  var res = await supabase.auth.signInWithPassword({ email: email, password: pass });
  if (res.error) { msg.textContent = res.error.message; msg.style.color = 'var(--danger)'; return; }
  onAuthStateChange(res.data.session);
}

async function authLogout() {
  await supabase.auth.signOut();
  _currentUser = null;
  document.getElementById('authLoggedOut').style.display = '';
  document.getElementById('authLoggedIn').style.display = 'none';
}

function onAuthStateChange(session) {
  if (session && session.user) {
    _currentUser = session.user;
    document.getElementById('authLoggedOut').style.display = 'none';
    document.getElementById('authLoggedIn').style.display = '';
    document.getElementById('authUserEmail').textContent = session.user.email;
    // Sync: load cloud data
    cloudLoad();
  } else {
    _currentUser = null;
    document.getElementById('authLoggedOut').style.display = '';
    document.getElementById('authLoggedIn').style.display = 'none';
  }
}

async function cloudSync(silent) {
  if (!_currentUser) return;
  var status = document.getElementById('syncStatus');
  if (!silent) status.textContent = 'åŒæœŸä¸­...';
  try {
    var res = await supabase.from('user_data').upsert({
      user_id: _currentUser.id,
      data: DATA
    }, { onConflict: 'user_id' });
    if (res.error) throw res.error;
    var now = new Date().toLocaleTimeString('ja-JP');
    status.textContent = 'æœ€çµ‚åŒæœŸ: ' + now;
  } catch (e) {
    status.textContent = 'åŒæœŸã‚¨ãƒ©ãƒ¼: ' + (e.message || e);
    status.style.color = 'var(--danger)';
  }
}

async function cloudLoad() {
  if (!_currentUser) return;
  var status = document.getElementById('syncStatus');
  status.textContent = 'ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...';
  try {
    var res = await supabase.from('user_data').select('data, updated_at').eq('user_id', _currentUser.id).single();
    if (res.error && res.error.code === 'PGRST116') {
      // No data in cloud yet - upload current local data
      status.textContent = 'ã‚¯ãƒ©ã‚¦ãƒ‰ã«ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...';
      await cloudSync();
      return;
    }
    if (res.error) throw res.error;

    var cloudData = res.data.data;
    var localProblems = DATA.problems.length;
    var cloudProblems = (cloudData.problems || []).length;

    if (cloudProblems === 0 && localProblems > 0) {
      // Cloud empty, local has data - upload
      await cloudSync();
      status.textContent = 'ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒ©ã‚¦ãƒ‰ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†';
    } else if (cloudProblems > 0 && localProblems === 0) {
      // Local empty, cloud has data - download
      DATA = cloudData;
      saveData(DATA);
      renderToday();
      status.textContent = 'ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸï¼ˆ' + cloudProblems + 'å•ï¼‰';
    } else if (cloudProblems > 0 && localProblems > 0) {
      // Both have data - ask user
      var cloudDate = new Date(res.data.updated_at).toLocaleString('ja-JP');
      if (confirm('ã‚¯ãƒ©ã‚¦ãƒ‰ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã™ï¼ˆ' + cloudProblems + 'å•, ' + cloudDate + 'ï¼‰\n\nã‚¯ãƒ©ã‚¦ãƒ‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ã„ã¾ã™ã‹ï¼Ÿ\nã€ŒOKã€â†’ã‚¯ãƒ©ã‚¦ãƒ‰ã‚’ä½¿ã†\nã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€â†’ä»Šã®ç«¯æœ«ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ã†ï¼ˆã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¸Šæ›¸ãï¼‰')) {
        DATA = cloudData;
        saveData(DATA);
        renderToday();
        status.textContent = 'ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰å¾©å…ƒï¼ˆ' + cloudProblems + 'å•ï¼‰';
      } else {
        await cloudSync();
        status.textContent = 'ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã§ã‚¯ãƒ©ã‚¦ãƒ‰ã‚’æ›´æ–°';
      }
    } else {
      status.textContent = 'åŒæœŸå®Œäº†ï¼ˆãƒ‡ãƒ¼ã‚¿ãªã—ï¼‰';
    }
  } catch (e) {
    status.textContent = 'èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + (e.message || e);
  }
}

// Check existing session on load
async function initAuth() {
  var res = await supabase.auth.getSession();
  if (res.data.session) {
    onAuthStateChange(res.data.session);
  }
  // Listen for auth changes
  supabase.auth.onAuthStateChange(function(event, session) {
    onAuthStateChange(session);
  });
}
var DATA = loadData();

// ================================================================
// SPACED REPETITION ENGINE v2 (Type-aware)
// ================================================================
// Problem types: 'flash' (æš—è¨˜) vs 'think' (æ€è€ƒ)
// Auto-detected from subject + tags, or manually set

// Interval tables (days)
var INTERVALS = {
  flash: [0, 1, 3, 7, 14, 30, 60],   // æš—è¨˜: é€Ÿãå›ã™
  think: [1, 3, 7, 14, 30, 60, 90]    // æ€è€ƒ: ã˜ã£ãã‚Š
};

function getProblemType(p) {
  if (p.problemType) return p.problemType; // manual override
  // Auto-detect from tags
  var tags = (p.tags || []).join(' ').toLowerCase();
  if (tags.match(/æš—è¨˜|æ¼¢å­—|å¹´å·|èªå½™|å››å­—ç†Ÿèª/)) return 'flash';
  // Auto-detect from subject + topic
  var topic = (p.topic || '').toLowerCase();
  if (topic.match(/æ¼¢å­—|æ›¸ãå–ã‚Š|å››å­—ç†Ÿèª|ã“ã¨ã‚ã–|æ…£ç”¨å¥/)) return 'flash';
  if (topic.match(/å¹´å·|å¹´ä»£|æš—è¨˜|ç”¨èª/)) return 'flash';
  if (p.subject === 'å›½èª' && topic.match(/èªå½™|æ–‡æ³•/)) return 'flash';
  if (p.subject === 'ç†ç§‘' && topic.match(/æš—è¨˜|æ˜Ÿåº§|å²©çŸ³|äººä½“|æ¤ç‰©|æ˜†è™«/)) return 'flash';
  if (p.subject === 'ç¤¾ä¼š') return 'flash'; // ç¤¾ä¼šã¯ã»ã¼æš—è¨˜
  // Default: think
  return 'think';
}

// Stage: visible to user
// ğŸ†• new(0) â†’ ğŸ“ learning(1-2) â†’ ğŸ”„ reviewing(3+) â†’ âœ… mastered(intervalâ‰§14)
function getStage(p) {
  if (p.frozen) return 'frozen';
  var reps = p.repetitions || 0;
  var interval = p.interval || 0;
  if (interval >= 14 && reps >= 4) return 'mastered';
  if (reps >= 3) return 'reviewing';
  if (reps >= 1) return 'learning';
  return 'new';
}

function getStageBadge(p) {
  var s = getStage(p);
  var map = {
    'new':       '<span class="stage-badge stage-new">ğŸ†• ã¯ã˜ã‚ã¦</span>',
    'learning':  '<span class="stage-badge stage-learning">ğŸ“ ç·´ç¿’ä¸­</span>',
    'reviewing': '<span class="stage-badge stage-reviewing">ğŸ”„ å¾©ç¿’ä¸­</span>',
    'mastered':  '<span class="stage-badge stage-mastered">âœ… å®šç€</span>',
    'frozen':    '<span class="stage-badge stage-frozen">â„ï¸ å‡çµ</span>'
  };
  return map[s] || '';
}

function getTypeBadge(p) {
  var t = getProblemType(p);
  return t === 'flash'
    ? '<span class="type-badge type-flash">âš¡æš—è¨˜</span>'
    : '<span class="type-badge type-think">ğŸ§ æ€è€ƒ</span>';
}

function calcNextReview(problem, quality) {
  // quality: 0=wrong, 3=hard, 5=correct
  var type = getProblemType(problem);
  var intervals = INTERVALS[type];
  var reps = problem.repetitions || 0;
  var interval = problem.interval || 0;
  var consFailures = problem.consecutiveFailures || 0;

  if (quality >= 4) {
    // Correct: advance to next interval
    reps++;
    var idx = Math.min(reps, intervals.length - 1);
    interval = intervals[idx];
    consFailures = 0;
  } else if (quality >= 3) {
    // Hard: same stage, shorter interval
    reps = Math.max(0, reps); // don't advance
    interval = Math.max(1, Math.round(interval * 0.5));
    consFailures = 0;
  } else {
    // Wrong: reset
    reps = 0;
    interval = type === 'flash' ? 0 : 1; // flash: same day retry
    consFailures++;
  }

  var nextDate = new Date();
  nextDate.setDate(nextDate.getDate() + interval);

  return {
    interval: interval,
    repetitions: reps,
    consecutiveFailures: consFailures,
    nextReviewDate: nextDate.toISOString().split('T')[0],
    // Keep easeFactor/masteryLevel for backward compat but derive from reps
    easeFactor: problem.easeFactor || 2.5,
    masteryLevel: (interval >= 14 && reps >= 4) ? 4 : Math.min(3, reps)
  };
}

function calcMastery(reps, failures) {
  if (failures >= 3) return 0;
  if (reps >= 5) return 4;
  if (reps >= 3) return 3;
  if (reps >= 1) return 2;
  return 1;
}

// ================================================================
// ZONE CLASSIFICATION (simplified)
// ================================================================
function classifyZone(p) {
  if (p.frozen) return 'frozen';
  var stage = getStage(p);
  if (stage === 'mastered') return 'graduated';
  // High-priority: new or learning + high frequency
  var isHighFreq = p.frequency === 'high' || p.frequency === 'medium';
  if ((stage === 'new' || stage === 'learning') && isHighFreq) return 'priority';
  return 'review';
}

// ================================================================
// DAILY QUEUE GENERATION (type-aware)
// ================================================================
function generateQueue() {
  var cap = DATA.settings.dailyCap || 15;
  var t = today();
  var eligible = DATA.problems.filter(p =>
    !p.frozen && getStage(p) !== 'mastered' && p.nextReviewDate <= t
  );
  // Separate by type
  var flashProbs = eligible.filter(p => getProblemType(p) === 'flash');
  var thinkProbs = eligible.filter(p => getProblemType(p) !== 'flash');
  // Sort each by priority
  flashProbs.sort((a, b) => calcPriority(b, t) - calcPriority(a, t));
  thinkProbs.sort((a, b) => calcPriority(b, t) - calcPriority(a, t));
  // Mix: alternate think/flash but respect cap
  // Aim for roughly 60% think, 40% flash (adjustable)
  var thinkCap = Math.ceil(cap * 0.6);
  var flashCap = cap - thinkCap;
  // But if one type has fewer, give to other
  if (thinkProbs.length < thinkCap) {
    flashCap += (thinkCap - thinkProbs.length);
    thinkCap = thinkProbs.length;
  }
  if (flashProbs.length < flashCap) {
    thinkCap += (flashCap - flashProbs.length);
    flashCap = flashProbs.length;
  }
  var queue = thinkProbs.slice(0, thinkCap).concat(flashProbs.slice(0, flashCap));
  // Interleave: think, flash, think, flash...
  var result = [];
  var ti = 0, fi = 0;
  var thinks = thinkProbs.slice(0, thinkCap);
  var flashes = flashProbs.slice(0, flashCap);
  while (ti < thinks.length || fi < flashes.length) {
    if (ti < thinks.length) result.push(thinks[ti++]);
    if (fi < flashes.length) result.push(flashes[fi++]);
  }
  return result;
}

function calcPriority(p, t) {
  var daysOverdue = Math.floor((new Date(t) - new Date(p.nextReviewDate)) / 86400000);
  var urgency = Math.max(0, daysOverdue) + 1;
  var freqMult = { high: 2, medium: 1, low: 0.5 }[p.frequency] || 1;
  var failPenalty = (p.consecutiveFailures || 0) >= 3 ? 0.3 : 1.0;
  var rateMult = 1.0;
  if (p.correctRate != null) {
    if (p.correctRate >= 70) rateMult = 1.5;
    else if (p.correctRate >= 40) rateMult = 1.3;
    else if (p.correctRate >= 20) rateMult = 1.0;
    else rateMult = 0.7;
  }
  // New problems get a boost
  var stage = getStage(p);
  var stageMult = stage === 'new' ? 1.5 : stage === 'learning' ? 1.2 : 1.0;
  return urgency * freqMult * failPenalty * rateMult * stageMult;
}

// ================================================================
// UI RENDERING
// ================================================================
var currentQueue = [];
var currentIndex = 0;
var sessionStats = { correct: 0, wrong: 0, hard: 0, graduated: 0 };

function switchScreen(name) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById('screen' + name).classList.add('active');
  // Update bottom nav
  var screens = ['Today','Add','List','Dash','Settings'];
  document.querySelectorAll('.nav-item').forEach((n, i) => {
    n.classList.toggle('active', screens[i] === name);
  });
  // Update sidebar nav
  document.querySelectorAll('.s-item').forEach(n => {
    n.classList.toggle('active', n.getAttribute('data-screen') === name);
  });
  if (name !== 'Add') { addCount = 0; document.getElementById('addContinueHint').style.display = 'none'; }
  if (name === 'Today') renderToday();
  if (name === 'List') renderList();
  if (name === 'Dash') renderDashboard();
  if (name === 'Add') renderAdd();
  if (name === 'Settings') renderSettings();
}

function renderToday() {
  document.getElementById('todayDate').textContent = formatDate(today());
  renderStreak();
  renderFreezeAlerts();
  currentQueue = generateQueue();
  var total = DATA.problems.filter(p => !p.frozen && getStage(p) !== 'mastered' && p.nextReviewDate <= today()).length;
  var count = currentQueue.length;
  document.getElementById('queueCount').textContent = count;
  var overdue = total - count;
  // Subject breakdown
  var bySubj = {};
  currentQueue.forEach(p => { bySubj[p.subject] = (bySubj[p.subject]||0)+1; });
  var parts = Object.entries(bySubj).map(([s,n]) => `${s}${n}å•`);
  var breakdown = parts.length ? parts.join(' / ') + (overdue > 0 ? ` ï¼‹ç¹°è¶Š${overdue}å•` : '') : '';
  document.getElementById('queueBreakdown').textContent = breakdown;
  // Type + Stage bar
  var flashCount = currentQueue.filter(p => getProblemType(p) === 'flash').length;
  var thinkCount = count - flashCount;
  var stages = {new:0,learning:0,reviewing:0};
  currentQueue.forEach(function(p){ var s=getStage(p); if(stages[s]!==undefined)stages[s]++; });
  var szBar = document.getElementById('queueStretchBar');
  if(szBar && count){
    szBar.innerHTML='<div style="display:flex;gap:8px;font-size:10px;margin-bottom:4px;flex-wrap:wrap">'
      +'<span class="type-badge type-think">ğŸ§  æ€è€ƒ '+thinkCount+'</span>'
      +'<span class="type-badge type-flash">âš¡ æš—è¨˜ '+flashCount+'</span>'
      +'<span style="margin-left:4px" class="stage-badge stage-new">ğŸ†• '+stages.new+'</span>'
      +'<span class="stage-badge stage-learning">ğŸ“ '+stages.learning+'</span>'
      +'<span class="stage-badge stage-reviewing">ğŸ”„ '+stages.reviewing+'</span>'
      +'</div>';
  }else if(szBar){szBar.innerHTML=''}

  document.getElementById('btnStart').disabled = count === 0;
  document.getElementById('queueProgress').style.width = '0%';
  document.getElementById('cardWrap').classList.remove('active');
  document.getElementById('completionView').style.display = 'none';
  document.getElementById('queueSummary').style.display = '';
  // Render subject filter chips
  renderSessionFilters();
  // Render XP
  renderPlayerStats();
}

// Session filter state
var _sessionSubject = 'all';
var _sessionType = 'all';

function renderSessionFilters() {
  var subjects = {};
  currentQueue.forEach(p => { subjects[p.subject] = (subjects[p.subject]||0)+1; });
  var el = document.getElementById('filterSubjectChips');
  if (!el) return;
  var html = '<button class="filter-chip ' + (_sessionSubject === 'all' ? 'active' : '') + '" onclick="setSessionSubject(\'all\',this)">å…¨æ•™ç§‘</button>';
  Object.entries(subjects).forEach(([s, n]) => {
    html += '<button class="filter-chip ' + (_sessionSubject === s ? 'active' : '') + '" onclick="setSessionSubject(\'' + s + '\',this)">' + s + ' ' + n + '</button>';
  });
  el.innerHTML = html;
  updateFilteredCount();
}

function setSessionSubject(subj, btn) {
  _sessionSubject = subj;
  document.querySelectorAll('#filterSubjectChips .filter-chip').forEach(c => c.classList.remove('active'));
  btn.classList.add('active');
  updateFilteredCount();
}

function setSessionType(type, btn) {
  _sessionType = type;
  document.querySelectorAll('#filterTypeChips .filter-chip').forEach(c => c.classList.remove('active'));
  btn.classList.add('active');
  updateFilteredCount();
}

function updateFilteredCount() {
  var filtered = getFilteredQueue();
  var btn = document.getElementById('btnStart');
  btn.textContent = filtered.length > 0 ? 'å¾©ç¿’ã‚’ã¯ã˜ã‚ã‚‹ï¼ˆ' + filtered.length + 'å•ï¼‰' : 'å¯¾è±¡ã®å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“';
  btn.disabled = filtered.length === 0;
}

function getFilteredQueue() {
  return currentQueue.filter(function(p) {
    if (_sessionSubject !== 'all' && p.subject !== _sessionSubject) return false;
    if (_sessionType !== 'all' && getProblemType(p) !== _sessionType) return false;
    return true;
  });
}

function startFilteredSession() {
  var filtered = getFilteredQueue();
  if (filtered.length === 0) return;
  currentQueue = filtered;
  startSession();
}

// ================================================================
// XP & LEVEL SYSTEM
// ================================================================
function getXP() { return DATA.xp || 0; }
function getLevel() {
  var xp = getXP();
  // XP needed: Lv1=0, Lv2=100, Lv3=250, Lv4=450...
  // Formula: level = floor(sqrt(xp/50)) + 1
  return Math.floor(Math.sqrt(xp / 50)) + 1;
}
function getXPForLevel(lv) { return (lv - 1) * (lv - 1) * 50; }

function addXP(amount, reason) {
  DATA.xp = (DATA.xp || 0) + amount;
  saveData(DATA);
  renderPlayerStats();
  // Show XP popup
  showXPPopup('+' + amount + ' XP ' + (reason || ''));
}

function showXPPopup(text) {
  var el = document.createElement('div');
  el.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--accent);color:#fff;padding:12px 24px;border-radius:12px;font-size:18px;font-weight:800;z-index:9999;animation:xpPop .8s ease-out forwards;pointer-events:none';
  el.textContent = text;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 1000);
}

function renderPlayerStats() {
  var lv = getLevel();
  var xp = getXP();
  var curLvXP = getXPForLevel(lv);
  var nextLvXP = getXPForLevel(lv + 1);
  var progress = nextLvXP > curLvXP ? ((xp - curLvXP) / (nextLvXP - curLvXP) * 100) : 100;
  var lvEl = document.getElementById('playerLevel');
  var barEl = document.getElementById('xpBar');
  var textEl = document.getElementById('xpText');
  if (lvEl) lvEl.textContent = 'Lv.' + lv;
  if (barEl) barEl.style.width = Math.min(100, progress) + '%';
  if (textEl) textEl.textContent = xp + ' / ' + nextLvXP + ' XP';
}

// Boss battle check - every 5 levels
function checkBossBattle(prevLv) {
  var newLv = getLevel();
  if (newLv > prevLv && newLv % 5 === 0) {
    showBossDefeat(newLv);
  } else if (newLv > prevLv) {
    showLevelUp(newLv);
  }
}

function showLevelUp(lv) {
  var flash = document.getElementById('graduatedFlash');
  document.getElementById('graduatedMsg').textContent = 'ğŸ‰ Lv.' + lv + ' ã«ä¸ŠãŒã£ãŸï¼';
  flash.classList.add('show');
  setTimeout(() => flash.classList.remove('show'), 2500);
}

function showBossDefeat(lv) {
  var bosses = ['ã‚¹ãƒ©ã‚¤ãƒ ã‚­ãƒ³ã‚°','ã‚´ãƒ–ãƒªãƒ³ãƒ­ãƒ¼ãƒ‰','ãƒ‰ãƒ©ã‚´ãƒ³ãƒ‘ãƒ”ãƒ¼','ãƒ•ãƒ­ã‚¹ãƒˆã‚®ã‚¬ãƒ³ãƒˆ','ãƒ€ãƒ¼ã‚¯ãƒŠã‚¤ãƒˆ','ãƒ•ã‚§ãƒ‹ãƒƒã‚¯ã‚¹','ãƒªãƒ´ã‚¡ã‚¤ã‚¢ã‚µãƒ³','ã‚±ãƒ«ãƒ™ãƒ­ã‚¹','é­”ç‹ãƒ©ã‚¹ãƒœã‚¹â… ','é­”ç‹ãƒ©ã‚¹ãƒœã‚¹â…¡'];
  var bossIdx = Math.floor(lv / 5) - 1;
  var bossName = bosses[Math.min(bossIdx, bosses.length - 1)];
  var overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.85);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;animation:fadeIn .3s';
  overlay.innerHTML = '<div style="font-size:60px;animation:xpPop .6s">âš”ï¸</div>'
    + '<div style="font-size:24px;font-weight:900;color:#ffd700;margin:16px 0;text-shadow:0 0 20px rgba(255,215,0,.5)">BOSS DEFEATED!</div>'
    + '<div style="font-size:18px;color:#fff;font-weight:700">Lv.' + lv + ' ã€Œ' + bossName + 'ã€ã‚’æ’ƒç ´ï¼</div>'
    + '<div style="font-size:13px;color:var(--text2);margin-top:8px">å®šç€ã—ãŸçŸ¥è­˜ãŒæ­¦å™¨ã«ãªã‚‹ğŸ’ª</div>'
    + '<div style="display:flex;gap:10px;margin-top:24px">'
    + '<button onclick="shareCard({type:\'boss\',bossName:\'' + bossName + '\',bossLv:' + lv + '});this.parentElement.parentElement.remove()" style="padding:10px 28px;border-radius:8px;background:var(--accent);color:#fff;font-weight:700;border:none;font-size:15px;cursor:pointer">ğŸ“± ã‚·ã‚§ã‚¢ã™ã‚‹</button>'
    + '<button onclick="this.parentElement.parentElement.remove()" style="padding:10px 28px;border-radius:8px;background:var(--surface2);color:#fff;font-weight:700;border:1px solid var(--border);font-size:15px;cursor:pointer">ç¶šã‘ã‚‹</button>'
    + '</div>';
  document.body.appendChild(overlay);
  fireConfetti(); fireConfetti();
}

// ================================================================
// SHARE CARD GENERATION
// ================================================================
function generateShareCard(opts) {
  // opts: {type:'session'|'boss'|'streak'|'milestone', bossName, bossLv}
  var canvas = document.createElement('canvas');
  canvas.width = 600; canvas.height = 340;
  var ctx = canvas.getContext('2d');
  // Background gradient
  var grad = ctx.createLinearGradient(0, 0, 600, 340);
  grad.addColorStop(0, '#1a1d27'); grad.addColorStop(1, '#2a1f4e');
  ctx.fillStyle = grad; ctx.fillRect(0, 0, 600, 340);
  // Accent strip top
  var strip = ctx.createLinearGradient(0, 0, 600, 0);
  strip.addColorStop(0, '#6c63ff'); strip.addColorStop(1, '#ff6b6b');
  ctx.fillStyle = strip; ctx.fillRect(0, 0, 600, 4);
  // Logo
  ctx.fillStyle = '#fff'; ctx.font = 'bold 20px "Noto Sans JP",sans-serif';
  ctx.fillText('ğŸ““ revnote', 24, 36);
  ctx.fillStyle = '#8b8fa8'; ctx.font = '11px sans-serif';
  ctx.fillText('ä¸­å­¦å—é¨“ãƒªãƒ™ãƒ³ã‚¸ãƒãƒ¼ãƒˆ', 130, 36);
  // Main content based on type
  var lv = getLevel(), xp = getXP(), streak = DATA.streak.count;
  var mastered = DATA.problems.filter(p => getStage(p) === 'mastered').length;
  var total = DATA.problems.length;

  if (opts.type === 'boss') {
    ctx.fillStyle = '#ffd700'; ctx.font = 'bold 36px "Noto Sans JP",sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('âš”ï¸ BOSS DEFEATED!', 300, 100);
    ctx.fillStyle = '#fff'; ctx.font = 'bold 22px "Noto Sans JP",sans-serif';
    ctx.fillText('Lv.' + opts.bossLv + ' ã€Œ' + opts.bossName + 'ã€æ’ƒç ´ï¼', 300, 140);
    ctx.textAlign = 'left';
  } else if (opts.type === 'streak') {
    ctx.fillStyle = '#ff6b6b'; ctx.font = 'bold 48px "Noto Sans JP",sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('ğŸ”¥ ' + streak + 'æ—¥é€£ç¶šï¼', 300, 110);
    ctx.textAlign = 'left';
  } else if (opts.type === 'milestone') {
    ctx.fillStyle = '#4ecdc4'; ctx.font = 'bold 36px "Noto Sans JP",sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('âœ… ' + mastered + 'å• å®šç€é”æˆï¼', 300, 110);
    ctx.textAlign = 'left';
  } else {
    ctx.fillStyle = '#fff'; ctx.font = 'bold 28px "Noto Sans JP",sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('ğŸ† ä»Šæ—¥ã®ãƒªãƒ™ãƒ³ã‚¸å®Œäº†ï¼', 300, 100);
    ctx.textAlign = 'left';
  }
  // Stats row
  var statsY = 180;
  var stats = [
    { emoji: 'âš”ï¸', val: 'Lv.' + lv, label: 'ãƒ¬ãƒ™ãƒ«' },
    { emoji: 'ğŸ”¥', val: streak + 'æ—¥', label: 'é€£ç¶š' },
    { emoji: 'âœ…', val: mastered + 'å•', label: 'å®šç€' },
    { emoji: 'ğŸ“š', val: total + 'å•', label: 'å…¨å•é¡Œ' }
  ];
  var colW = 140;
  stats.forEach(function(s, i) {
    var x = 24 + i * colW;
    ctx.fillStyle = 'rgba(108,99,255,.15)';
    roundRect(ctx, x, statsY, colW - 12, 70, 10); ctx.fill();
    ctx.fillStyle = '#fff'; ctx.font = 'bold 22px "Noto Sans JP",sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText(s.emoji + ' ' + s.val, x + (colW-12)/2, statsY + 32);
    ctx.fillStyle = '#8b8fa8'; ctx.font = '11px sans-serif';
    ctx.fillText(s.label, x + (colW-12)/2, statsY + 54);
    ctx.textAlign = 'left';
  });
  // Exam countdown
  if (DATA.settings.examDate) {
    var diff = Math.ceil((new Date(DATA.settings.examDate) - new Date()) / 864e5);
    if (diff > 0) {
      ctx.fillStyle = '#ff6b6b'; ctx.font = 'bold 13px "Noto Sans JP",sans-serif';
      ctx.fillText('ğŸ“… ' + (DATA.settings.examName || 'å…¥è©¦') + 'ã¾ã§ ã‚ã¨' + diff + 'æ—¥', 24, 288);
    }
  }
  // Footer
  ctx.fillStyle = '#555'; ctx.font = '11px sans-serif';
  ctx.fillText('ppxa.github.io/revnote', 24, 322);
  // Session detail for session type
  if (opts.type === 'session' && sessionStats) {
    ctx.fillStyle = '#8b8fa8'; ctx.font = '12px "Noto Sans JP",sans-serif';
    ctx.textAlign = 'right';
    ctx.fillText('â­•' + sessionStats.correct + ' ğŸ”º' + sessionStats.hard + ' âŒ' + sessionStats.wrong, 576, 322);
    ctx.textAlign = 'left';
  }
  return canvas;
}

function roundRect(ctx, x, y, w, h, r) {
  ctx.beginPath();
  ctx.moveTo(x + r, y);
  ctx.lineTo(x + w - r, y);
  ctx.quadraticCurveTo(x + w, y, x + w, y + r);
  ctx.lineTo(x + w, y + h - r);
  ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
  ctx.lineTo(x + r, y + h);
  ctx.quadraticCurveTo(x, y + h, x, y + h - r);
  ctx.lineTo(x, y + r);
  ctx.quadraticCurveTo(x, y, x + r, y);
  ctx.closePath();
}

async function shareCard(opts) {
  var canvas = generateShareCard(opts);
  var blob = await new Promise(r => canvas.toBlob(r, 'image/png'));
  var file = new File([blob], 'revnote-share.png', { type: 'image/png' });
  // Build share text
  var lv = getLevel(), streak = DATA.streak.count;
  var mastered = DATA.problems.filter(p => getStage(p) === 'mastered').length;
  var text = '';
  if (opts.type === 'boss') text = 'âš”ï¸ Lv.' + opts.bossLv + 'ã€Œ' + opts.bossName + 'ã€ã‚’æ’ƒç ´ï¼';
  else if (opts.type === 'streak') text = 'ğŸ”¥ ' + streak + 'æ—¥é€£ç¶šãƒªãƒ™ãƒ³ã‚¸é”æˆï¼';
  else if (opts.type === 'milestone') text = 'âœ… ' + mastered + 'å•ãŒå®šç€ï¼';
  else text = 'ğŸ† ä»Šæ—¥ã®ãƒªãƒ™ãƒ³ã‚¸å®Œäº†ï¼â­•' + sessionStats.correct + ' ğŸ”º' + sessionStats.hard + ' âŒ' + sessionStats.wrong;
  text += '\nLv.' + lv + ' | ğŸ”¥' + streak + 'æ—¥é€£ç¶š | âœ…' + mastered + 'å•å®šç€';
  text += '\n\n#revnote #ä¸­å­¦å—é¨“ #å‹‰å¼·å¢\nhttps://ppxa.github.io/revnote/';

  if (navigator.canShare && navigator.canShare({ files: [file] })) {
    try {
      await navigator.share({ text: text, files: [file] });
      return;
    } catch (e) { /* user cancelled or error, fall through */ }
  }
  // Fallback: show card as download + copy text
  showShareFallback(canvas, text);
}

function showShareFallback(canvas, text) {
  var overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.85);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;padding:20px';
  overlay.innerHTML = '<div style="font-size:14px;color:#fff;font-weight:700;margin-bottom:12px">ğŸ“± ã‚·ã‚§ã‚¢ã‚«ãƒ¼ãƒ‰</div>';
  var img = document.createElement('img');
  img.src = canvas.toDataURL();
  img.style.cssText = 'max-width:90%;max-height:40vh;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,.5)';
  overlay.appendChild(img);
  // Share buttons
  var btns = document.createElement('div');
  btns.style.cssText = 'display:flex;gap:10px;margin-top:16px;flex-wrap:wrap;justify-content:center';
  // X (Twitter)
  btns.innerHTML = '<a href="https://twitter.com/intent/tweet?text=' + encodeURIComponent(text) + '" target="_blank" style="padding:10px 20px;background:#000;color:#fff;border-radius:8px;text-decoration:none;font-weight:700;font-size:13px">ğ• ãƒã‚¹ãƒˆ</a>'
    + '<a href="https://line.me/R/share?text=' + encodeURIComponent(text) + '" target="_blank" style="padding:10px 20px;background:#06c755;color:#fff;border-radius:8px;text-decoration:none;font-weight:700;font-size:13px">LINE</a>'
    + '<button onclick="navigator.clipboard.writeText(\'' + text.replace(/'/g, "\\'").replace(/\n/g, "\\n") + '\');this.textContent=\'ã‚³ãƒ”ãƒ¼æ¸ˆâœ“\'" style="padding:10px 20px;background:var(--surface2);color:#fff;border-radius:8px;border:1px solid var(--border);font-weight:700;font-size:13px;cursor:pointer">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>';
  overlay.appendChild(btns);
  // Save image
  var saveBtn = document.createElement('button');
  saveBtn.textContent = 'ğŸ’¾ ç”»åƒã‚’ä¿å­˜';
  saveBtn.style.cssText = 'margin-top:12px;padding:8px 20px;background:var(--accent);color:#fff;border:none;border-radius:8px;font-weight:700;font-size:13px;cursor:pointer';
  saveBtn.onclick = function() {
    var a = document.createElement('a');
    a.href = canvas.toDataURL();
    a.download = 'revnote-share.png';
    a.click();
  };
  overlay.appendChild(saveBtn);
  // Close
  var closeBtn = document.createElement('button');
  closeBtn.textContent = 'âœ• é–‰ã˜ã‚‹';
  closeBtn.style.cssText = 'margin-top:12px;padding:8px 20px;background:transparent;color:var(--text2);border:1px solid var(--border);border-radius:8px;font-size:13px;cursor:pointer';
  closeBtn.onclick = function() { overlay.remove(); };
  overlay.appendChild(closeBtn);
  document.body.appendChild(overlay);
}

// Check streak milestones (7, 14, 30, 50, 100...)
function checkStreakMilestone() {
  var s = DATA.streak.count;
  var milestones = [7, 14, 30, 50, 100, 200, 365];
  if (milestones.includes(s)) {
    setTimeout(function() {
      showStreakMilestone(s);
    }, 500);
  }
}

function showStreakMilestone(days) {
  var overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.85);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999';
  overlay.innerHTML = '<div style="font-size:60px">ğŸ”¥</div>'
    + '<div style="font-size:28px;font-weight:900;color:#ff6b6b;margin:12px 0">' + days + 'æ—¥é€£ç¶šé”æˆï¼</div>'
    + '<div style="font-size:14px;color:var(--text2)">æ¯æ—¥ã®åŠªåŠ›ãŒåŠ›ã«ãªã‚‹ğŸ’ª</div>'
    + '<div style="display:flex;gap:10px;margin-top:20px">'
    + '<button onclick="shareCard({type:\'streak\'});this.parentElement.parentElement.remove()" style="padding:10px 24px;border-radius:8px;background:var(--accent);color:#fff;font-weight:700;border:none;font-size:14px;cursor:pointer">ğŸ“± ã‚·ã‚§ã‚¢ã™ã‚‹</button>'
    + '<button onclick="this.parentElement.parentElement.remove()" style="padding:10px 24px;border-radius:8px;background:var(--surface2);color:#fff;font-weight:700;border:1px solid var(--border);font-size:14px;cursor:pointer">é–‰ã˜ã‚‹</button>'
    + '</div>';
  document.body.appendChild(overlay);
  fireConfetti();
}

// Check mastered milestone (10, 25, 50, 100...)
function checkMasteredMilestone() {
  var m = DATA.problems.filter(p => getStage(p) === 'mastered').length;
  var milestones = [10, 25, 50, 100, 200, 500];
  if (milestones.includes(m)) {
    setTimeout(function() {
      var overlay = document.createElement('div');
      overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.85);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999';
      overlay.innerHTML = '<div style="font-size:60px">âœ…</div>'
        + '<div style="font-size:28px;font-weight:900;color:#4ecdc4;margin:12px 0">' + m + 'å• å®šç€é”æˆï¼</div>'
        + '<div style="font-size:14px;color:var(--text2)">ç€å®Ÿã«åŠ›ãŒã¤ã„ã¦ã‚‹ğŸ“ˆ</div>'
        + '<div style="display:flex;gap:10px;margin-top:20px">'
        + '<button onclick="shareCard({type:\'milestone\'});this.parentElement.parentElement.remove()" style="padding:10px 24px;border-radius:8px;background:var(--accent);color:#fff;font-weight:700;border:none;font-size:14px;cursor:pointer">ğŸ“± ã‚·ã‚§ã‚¢ã™ã‚‹</button>'
        + '<button onclick="this.parentElement.parentElement.remove()" style="padding:10px 24px;border-radius:8px;background:var(--surface2);color:#fff;font-weight:700;border:1px solid var(--border);font-size:14px;cursor:pointer">é–‰ã˜ã‚‹</button>'
        + '</div>';
      document.body.appendChild(overlay);
      fireConfetti();
    }, 800);
  }
}

function renderStreak() {
  updateStreak();
  document.getElementById('streakCount').textContent = DATA.streak.count;
  var dots = document.getElementById('streakDots');
  dots.innerHTML = '';
  var hist = DATA.streak.history.slice(-7);
  for (var i = 0; i < 7; i++) {
    var d = document.createElement('div');
    d.className = 'streak-dot';
    if (hist[i]) d.classList.add('done');
    if (i === hist.length - 1 && hist[i] === today()) d.classList.add('today');
    dots.appendChild(d);
  }
}

function updateStreak() {
  var t = today();
  var yesterday = new Date();
  yesterday.setDate(yesterday.getDate() - 1);
  var y = yesterday.toISOString().split('T')[0];
  if (DATA.streak.lastDate === t) return; // already recorded today
  if (DATA.streak.lastDate === y) {
    // streak continues â€” don't increment yet, wait for session
  } else if (DATA.streak.lastDate !== t) {
    // broken or first time
    if (DATA.streak.lastDate && DATA.streak.lastDate !== y) {
      DATA.streak.count = 0;
      DATA.streak.history = [];
    }
  }
}

function recordStreakToday() {
  var t = today();
  if (DATA.streak.lastDate !== t) {
    DATA.streak.count++;
    DATA.streak.lastDate = t;
    if (!DATA.streak.history.includes(t)) DATA.streak.history.push(t);
    if (DATA.streak.history.length > 30) DATA.streak.history.shift();
    saveData(DATA);
  }
}

function renderFreezeAlerts() {
  var container = document.getElementById('freezeAlerts');
  container.innerHTML = '';
  var threshold = DATA.settings.freezeThreshold || 5;
  var candidates = DATA.problems.filter(p =>
    !p.frozen && (p.consecutiveFailures || 0) >= threshold
  );
  candidates.forEach(p => {
    var div = document.createElement('div');
    div.className = 'freeze-alert';
    div.innerHTML = `
      <span>â„ï¸ ã€Œ${p.topic}ã€ãŒ${p.consecutiveFailures}å›é€£ç¶šä¸æ­£è§£</span>
      <button onclick="freezeProblem('${p.id}')">å‡çµã™ã‚‹</button>
    `;
    container.appendChild(div);
  });
}

function startSession() {
  if (currentQueue.length === 0) return;
  isSingleProblemMode = false;
  currentIndex = 0;
  sessionStats = { correct: 0, wrong: 0, hard: 0, graduated: 0 };
  document.getElementById('queueSummary').style.display = 'none';
  document.getElementById('completionView').style.display = 'none';
  document.getElementById('cardWrap').classList.add('active');
  showCard();
  recordStreakToday();
}

function showCard() {
  if (currentIndex >= currentQueue.length) {
    finishSession();
    return;
  }
  var p = currentQueue[currentIndex];
  var total = currentQueue.length;
  document.getElementById('cardProgress').textContent = `${currentIndex + 1} / ${total}`;
  document.getElementById('queueProgress').style.width = ((currentIndex) / total * 100) + '%';

  var badgeClass = {
    'ç®—æ•°': 'badge-math', 'æ•°å­¦': 'badge-math', 'å›½èª': 'badge-japanese',
    'ç†ç§‘': 'badge-science', 'ç¤¾ä¼š': 'badge-social', 'è‹±èª': 'badge-english'
  }[p.subject] || 'badge-math';

  var freqLabel = { high: 'é«˜é »å‡º', medium: 'ä¸­é »å‡º', low: 'ä½é »å‡º' }[p.frequency] || '';
  var diffLabel = { basic: 'åŸºæœ¬', standard: 'æ¨™æº–', hard: 'å¿œç”¨' }[p.difficulty] || '';

  // Show problem ONLY (no answer)
  var hasImage = !!p.contentImage;
  // Store image for scratchpad embedding
  window._currentProblemImage = hasImage ? p.contentImage : null;
  document.getElementById('problemCard').innerHTML = `
    <span class="card-badge ${badgeClass}">${p.subject}</span>
    <div class="card-source">${p.source || ''}</div>
    <div class="card-topic">${p.topic}</div>
    ${p.lastMemo ? `<div style="font-size:11px;color:var(--accent);margin-bottom:4px">ğŸ“ ${p.lastMemo}</div>` : ''}
    <div class="card-content" id="cardContentArea">
      ${hasImage ? '<div style="font-size:11px;color:var(--accent)">ğŸ“¸ å›³ã¤ãå•é¡Œ â€” è¨ˆç®—ã‚¹ãƒšãƒ¼ã‚¹ã«è¡¨ç¤ºï¼ˆ2æœ¬æŒ‡ã§ç§»å‹•ãƒ»æ‹¡ç¸®ï¼‰</div>' : (p.content || '')}
    </div>
    <div class="card-meta">
      ${getStageBadge(p)} ${getTypeBadge(p)}
      <span class="meta-tag ${p.frequency === 'high' ? 'meta-freq-high' : ''}">${freqLabel}</span>
      <span class="meta-tag ${p.difficulty === 'hard' ? 'meta-diff-hard' : ''}">${diffLabel}</span>
      ${p.correctRate != null ? `<span class="meta-tag" style="color:${p.correctRate >= 70 ? 'var(--success)' : p.correctRate >= 40 ? 'var(--warning)' : 'var(--danger)'}">æ­£ç­”ç‡${p.correctRate}%</span>` : ''}
      ${(p.tags||[]).length ? `<span class="meta-tag">${p.tags.map(t=>'#'+t).join(' ')}</span>` : ''}
    </div>
  `;

  // Prepare answer section (hidden)
  var answerHTML = p.answerImage
    ? `<strong>ç­”ãˆ:</strong><br><img src="${p.answerImage}" alt="è§£èª¬ç”»åƒ" style="max-width:100%;border-radius:6px;margin-top:6px">`
    : (p.answer ? `<strong>ç­”ãˆ:</strong> ${p.answer}` : '<span style="color:var(--text2)">ç­”ãˆæœªç™»éŒ²</span>');
  document.getElementById('answerSection').innerHTML = answerHTML;
  document.getElementById('answerSection').classList.remove('show');
  document.getElementById('btnReveal').style.display = '';
  document.getElementById('answerBtns').style.display = 'none';
  document.getElementById('reviewMemo').style.display = 'none';
  document.getElementById('reviewMemoText').value = '';
  document.getElementById('btnSkip').style.display = '';

  // Reset scratchpad
  clearScratchpad();
  initScratchpad();

  // Timer for think problems
  startProblemTimer(p);
  // Hint setup
  setupHint(p);
  // Swipe for flash
  setupSwipe(p);
  // Reset mistake reason
  document.getElementById('mistakeReason').style.display = 'none';

  // Mobile: scroll problem card to top
  if(window.innerWidth < 1024) {
    var el = document.getElementById('problemCard');
    if(el) setTimeout(function(){ el.scrollIntoView({behavior:'smooth',block:'start'}); }, 50);
  }
}

// ================================================================
// PROBLEM TIMER (think problems)
// ================================================================
var _problemTimer = null;
var _timerSeconds = 0;
var _timerTotal = 0;

function startProblemTimer(p) {
  clearInterval(_problemTimer);
  var el = document.getElementById('problemTimer');
  if (getProblemType(p) === 'think') {
    // Default 5 min, can be set per problem
    var mins = p.timerMinutes || 5;
    _timerTotal = mins * 60;
    _timerSeconds = _timerTotal;
    el.style.display = '';
    updateTimerUI();
    _problemTimer = setInterval(function() {
      _timerSeconds--;
      updateTimerUI();
      if (_timerSeconds <= 0) {
        clearInterval(_problemTimer);
        // Timer expired - gentle nudge
        document.getElementById('timerDisplay').style.color = 'var(--danger)';
        document.getElementById('timerLabel').textContent = 'â° æ™‚é–“åˆ‡ã‚Œï¼';
      }
    }, 1000);
  } else {
    el.style.display = 'none';
  }
}

function updateTimerUI() {
  var m = Math.floor(Math.max(0, _timerSeconds) / 60);
  var s = Math.max(0, _timerSeconds) % 60;
  document.getElementById('timerDisplay').textContent = m + ':' + String(s).padStart(2, '0');
  var pct = _timerTotal > 0 ? (_timerSeconds / _timerTotal * 100) : 0;
  document.getElementById('timerBar').style.width = pct + '%';
  // Color changes
  var disp = document.getElementById('timerDisplay');
  if (_timerSeconds <= 30) { disp.style.color = 'var(--danger)'; }
  else if (_timerSeconds <= 60) { disp.style.color = 'var(--warning)'; }
  else { disp.style.color = 'var(--accent)'; }
}

// ================================================================
// HINT SYSTEM
// ================================================================
function setupHint(p) {
  var btnHint = document.getElementById('btnHint');
  var hintSection = document.getElementById('hintSection');
  hintSection.style.display = 'none';
  // Generate hint from problem data
  var hint = generateHint(p);
  if (hint) {
    btnHint.style.display = '';
    btnHint.setAttribute('data-hint', hint);
  } else {
    btnHint.style.display = 'none';
  }
}

function generateHint(p) {
  // Auto-generate hints based on problem type
  var type = getProblemType(p);
  if (type === 'flash') {
    // For flash: show first character of answer, or partial
    if (p.answer) {
      var ans = p.answer.trim();
      if (ans.length <= 2) return null; // too short for hint
      // Show first char + blanks
      return 'ç­”ãˆã®æœ€åˆ: ã€Œ' + ans.charAt(0) + 'â—‹'.repeat(Math.min(ans.length - 1, 5)) + 'ã€';
    }
    return null;
  } else {
    // For think: hint from topic
    var hints = {
      'é£Ÿå¡©æ°´': 'é£Ÿå¡©ã®é‡ã• Ã· é£Ÿå¡©æ°´ã®é‡ã• Ã— 100',
      'é€Ÿã•': 'ãï¼ˆè·é›¢ï¼‰= ã¯ï¼ˆé€Ÿã•ï¼‰Ã— ã˜ï¼ˆæ™‚é–“ï¼‰',
      'å‰²åˆ': 'ãã‚‰ã¹ã‚‹é‡ Ã· ã‚‚ã¨ã«ã™ã‚‹é‡ = å‰²åˆ',
      'é¢ç©': 'åº•è¾º Ã— é«˜ã• Ã· 2',
      'ä½“ç©': 'åº•é¢ç© Ã— é«˜ã•',
      'æ¯”': 'å†…é …ã®ç© = å¤–é …ã®ç©',
      'æ¿ƒåº¦': 'æº¶è³ª Ã· æº¶æ¶² Ã— 100',
      'æ—…äººç®—': 'äºŒäººã®é€Ÿã•ã®å’Œï¼ˆå‡ºä¼šã„ï¼‰or å·®ï¼ˆè¿½ã„ã‹ã‘ï¼‰',
      'ä»•äº‹ç®—': 'å…¨ä½“ã‚’1ã¨ã—ã¦ã€1æ—¥ã‚ãŸã‚Šã®ä»•äº‹é‡ã‚’æ±‚ã‚ã‚‹',
      'å ´åˆã®æ•°': 'æ¨¹å½¢å›³ã‚’æ›¸ã„ã¦æ•°ãˆã‚‹',
    };
    var topic = p.topic || '';
    for (var key in hints) {
      if (topic.indexOf(key) >= 0) return 'ğŸ’¡ ' + hints[key];
    }
    // Generic hint: show tags or memo
    if (p.lastMemo) return 'ğŸ“ å‰å›ã®ãƒ¡ãƒ¢: ' + p.lastMemo;
    return null;
  }
}

function showHint() {
  var hint = document.getElementById('btnHint').getAttribute('data-hint');
  document.getElementById('hintSection').textContent = hint;
  document.getElementById('hintSection').style.display = '';
  document.getElementById('btnHint').style.display = 'none';
}

// ================================================================
// MISTAKE REASON TAG
// ================================================================
var _pendingMistakeQuality = null;

function recordAnswer(quality) {
  if (quality === 0) {
    // Show mistake reason selector before recording
    _pendingMistakeQuality = 0;
    document.getElementById('mistakeReason').style.display = '';
    document.getElementById('answerBtns').style.display = 'none';
    return;
  }
  doRecordAnswer(quality, '');
}

function tagMistake(reason) {
  document.getElementById('mistakeReason').style.display = 'none';
  doRecordAnswer(0, reason);
}

function revealAnswer() {
  document.getElementById('answerSection').classList.add('show');
  document.getElementById('btnReveal').style.display = 'none';
  document.getElementById('btnHint').style.display = 'none';
  document.getElementById('hintSection').style.display = 'none';
  document.getElementById('answerBtns').style.display = 'flex';
  document.getElementById('reviewMemo').style.display = 'block';
  document.getElementById('btnSkip').style.display = 'none';
  document.getElementById('swipeHint').style.display = 'none';
  clearInterval(_problemTimer);
}

function doRecordAnswer(quality, mistakeReason) {
  var p = currentQueue[currentIndex];
  var real = DATA.problems.find(x => x.id === p.id);
  if (!real) { currentIndex++; showCard(); return; }

  var prevLv = getLevel();
  var result = calcNextReview(real, quality);
  Object.assign(real, result);
  real.history = real.history || [];
  var memo = (document.getElementById('reviewMemoText').value || '').trim();
  var entry = {
    date: today(),
    result: quality >= 4 ? 'correct' : quality >= 3 ? 'hard' : 'incorrect',
    quality: quality,
    memo: memo || undefined
  };
  if (mistakeReason) entry.mistakeReason = mistakeReason;
  // Record time spent (from timer)
  if (_timerTotal > 0) entry.timeSpent = _timerTotal - Math.max(0, _timerSeconds);
  real.history.push(entry);
  if (memo) real.lastMemo = memo;

  // XP rewards
  var xpGain = 0;
  if (quality >= 4) { sessionStats.correct++; xpGain = 15; fireConfetti(); }
  else if (quality >= 3) { sessionStats.hard++; xpGain = 8; }
  else { sessionStats.wrong++; xpGain = 3; }
  if (getProblemType(real) === 'think' && quality >= 4) xpGain += 5;
  if (DATA.streak.count >= 7) xpGain = Math.round(xpGain * 1.5);
  else if (DATA.streak.count >= 3) xpGain = Math.round(xpGain * 1.2);
  addXP(xpGain);

  if (getStage(real) === 'mastered') {
    sessionStats.graduated++;
    showGraduated(real);
    addXP(30, 'å®šç€ãƒœãƒ¼ãƒŠã‚¹ï¼');
  }

  checkBossBattle(prevLv);
  clearInterval(_problemTimer);
  saveData(DATA);
  currentIndex++;
  showCard();
}

function skipProblem() {
  // Move to next without recording answer - problem stays in queue for later
  currentIndex++;
  if (currentIndex >= currentQueue.length) {
    finishSession();
  } else {
    showCard();
  }
}

// ================================================================
// SWIPE GESTURE (flash cards)
// ================================================================
var _swipeStartX = 0;
var _swipeStartY = 0;
var _swipeActive = false;

function setupSwipe(p) {
  var card = document.getElementById('problemCard');
  var hint = document.getElementById('swipeHint');
  // Only show swipe for flash type after answer is revealed
  if (getProblemType(p) === 'flash') {
    hint.style.display = '';
  } else {
    hint.style.display = 'none';
  }
  // Remove old listeners
  card.removeEventListener('touchstart', swipeTouchStart);
  card.removeEventListener('touchmove', swipeTouchMove);
  card.removeEventListener('touchend', swipeTouchEnd);
  // Add new
  card.addEventListener('touchstart', swipeTouchStart, { passive: true });
  card.addEventListener('touchmove', swipeTouchMove, { passive: false });
  card.addEventListener('touchend', swipeTouchEnd, { passive: true });
}

function swipeTouchStart(e) {
  if (e.touches.length !== 1) return;
  // Only allow swipe after answer is revealed
  var ansEl = document.getElementById('answerSection');
  if (!ansEl.classList.contains('show')) return;
  _swipeStartX = e.touches[0].clientX;
  _swipeStartY = e.touches[0].clientY;
  _swipeActive = true;
}

function swipeTouchMove(e) {
  if (!_swipeActive || e.touches.length !== 1) return;
  var dx = e.touches[0].clientX - _swipeStartX;
  var dy = e.touches[0].clientY - _swipeStartY;
  // Only horizontal swipes
  if (Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > 30) {
    e.preventDefault();
    var card = document.getElementById('problemCard');
    card.style.transform = 'translateX(' + dx + 'px) rotate(' + (dx * 0.05) + 'deg)';
    card.style.opacity = Math.max(0.5, 1 - Math.abs(dx) / 300);
  }
}

function swipeTouchEnd(e) {
  if (!_swipeActive) return;
  _swipeActive = false;
  var card = document.getElementById('problemCard');
  var dx = (e.changedTouches[0] ? e.changedTouches[0].clientX : 0) - _swipeStartX;
  card.style.transform = '';
  card.style.opacity = '';
  if (Math.abs(dx) > 100) {
    if (dx > 0) {
      // Swipe right = correct
      doRecordAnswer(5, '');
    } else {
      // Swipe left = wrong
      doRecordAnswer(0, '');
    }
  }
}

// ================================================================
// SCRATCHPAD (drawing canvas)
// ================================================================
var spCtx = null;
var spDrawing = false;
var spErasing = false;
var spColor = '#333';

function initScratchpad() {
  var canvas = document.getElementById('scratchpadCanvas');
  var wrap = canvas.parentElement;
  var w = wrap.offsetWidth;
  if (w < 10) return; // not visible yet
  var isLandscape = window.innerWidth >= 1024;
  var hRatio = isLandscape ? 0.8 : 0.7;
  var h = Math.max(250, Math.round(w * hRatio));
  canvas.width = w * 2; // retina
  canvas.height = h * 2;
  canvas.style.width = w + 'px';
  canvas.style.height = h + 'px';
  spCtx = canvas.getContext('2d');
  spCtx.lineCap = 'round';
  spCtx.lineJoin = 'round';
  var bgColor = getComputedStyle(document.documentElement).getPropertyValue('--canvas-bg').trim() || '#f5f5f5';
  spCtx.fillStyle = bgColor;
  spCtx.fillRect(0, 0, canvas.width, canvas.height);
  spDrawing = false;
  spErasing = false;
  document.getElementById('spEraser').classList.remove('active');

  // Draw problem image if present
  window._spStrokes = [];
  _imgState = null;
  _imgLoaded = null;
  drawProblemImageOnCanvas();

  // Setup pointer events (handles both drawing and image interaction)
  setupCanvasEvents(canvas);
}

// Image state for interactive positioning
var _imgState = null; // {img, x, y, w, h, selected, dragStart, resizing}
var _imgLoaded = null; // cached Image object

function drawProblemImageOnCanvas() {
  if (!window._currentProblemImage || !spCtx) return;
  var canvas = document.getElementById('scratchpadCanvas');
  var img = new Image();
  img.onload = function() {
    _imgLoaded = img;
    var cw = canvas.width;
    var ch = canvas.height;
    var isLandscape = window.innerWidth >= 1024;
    var maxW, maxH, dx, dy;
    if (isLandscape) {
      maxW = cw * 0.45; maxH = ch * 0.45; dx = 24; dy = 24;
    } else {
      maxW = cw * 0.9; maxH = ch * 0.45; dy = 24; dx = 0;
    }
    var scale = Math.min(maxW / img.width, maxH / img.height);
    var drawW = img.width * scale;
    var drawH = img.height * scale;
    if (!isLandscape) dx = (cw - drawW) / 2;
    _imgState = { x: dx, y: dy, w: drawW, h: drawH, selected: false, dragStart: null, resizing: false, origW: drawW, origH: drawH };
    redrawCanvas();
  };
  img.src = window._currentProblemImage;
}

function redrawCanvas() {
  var canvas = document.getElementById('scratchpadCanvas');
  if (!canvas || !spCtx) return;
  var bgColor = getComputedStyle(document.documentElement).getPropertyValue('--canvas-bg').trim() || '#f5f5f5';
  spCtx.globalCompositeOperation = 'source-over';
  spCtx.fillStyle = bgColor;
  spCtx.fillRect(0, 0, canvas.width, canvas.height);
  // Redraw saved strokes
  if (window._spStrokes && window._spStrokes.length > 0) {
    _spStrokes.forEach(function(stroke) {
      spCtx.globalCompositeOperation = stroke.erasing ? 'destination-out' : 'source-over';
      spCtx.strokeStyle = stroke.erasing ? 'rgba(0,0,0,1)' : stroke.color;
      spCtx.lineWidth = stroke.width;
      spCtx.lineCap = 'round'; spCtx.lineJoin = 'round';
      spCtx.beginPath();
      stroke.points.forEach(function(pt, i) {
        if (i === 0) spCtx.moveTo(pt.x, pt.y);
        else { spCtx.lineTo(pt.x, pt.y); spCtx.stroke(); }
      });
    });
    spCtx.globalCompositeOperation = 'source-over';
  }
  // Draw image
  if (_imgState && _imgLoaded) {
    spCtx.fillStyle = '#fff';
    spCtx.fillRect(_imgState.x - 6, _imgState.y - 6, _imgState.w + 12, _imgState.h + 12);
    spCtx.drawImage(_imgLoaded, _imgState.x, _imgState.y, _imgState.w, _imgState.h);
    if (_imgState.selected) {
      // Selection border
      spCtx.strokeStyle = '#6c63ff'; spCtx.lineWidth = 3; spCtx.setLineDash([8, 4]);
      spCtx.strokeRect(_imgState.x - 6, _imgState.y - 6, _imgState.w + 12, _imgState.h + 12);
      spCtx.setLineDash([]);
      // Resize handle (bottom-right)
      var hx = _imgState.x + _imgState.w; var hy = _imgState.y + _imgState.h;
      spCtx.fillStyle = '#6c63ff';
      spCtx.beginPath(); spCtx.arc(hx, hy, 16, 0, Math.PI * 2); spCtx.fill();
      spCtx.fillStyle = '#fff'; spCtx.font = 'bold 18px sans-serif'; spCtx.textAlign = 'center'; spCtx.textBaseline = 'middle';
      spCtx.fillText('â¤¡', hx, hy);
    }
  }
}

function isPointInImage(px, py) {
  if (!_imgState) return false;
  return px >= _imgState.x - 20 && px <= _imgState.x + _imgState.w + 20 &&
         py >= _imgState.y - 20 && py <= _imgState.y + _imgState.h + 20;
}

function isPointOnResizeHandle(px, py) {
  if (!_imgState || !_imgState.selected) return false;
  var hx = _imgState.x + _imgState.w;
  var hy = _imgState.y + _imgState.h;
  return Math.sqrt((px - hx) * (px - hx) + (py - hy) * (py - hy)) < 30;
}

// Stroke recording
window._spStrokes = [];
var _currentStroke = null;

function setupCanvasEvents(canvas) {
  // Use touch events for multi-finger, pointer for single-finger drawing
  var _imgMode = false;
  var _pinchStart = null; // {dist, cx, cy, imgX, imgY, imgW, imgH}

  function getTouchPos(touch) {
    var r = canvas.getBoundingClientRect();
    return { x: (touch.clientX - r.left) * (canvas.width / r.width), y: (touch.clientY - r.top) * (canvas.height / r.height) };
  }
  function pinchDist(t) {
    var dx = t[0].clientX - t[1].clientX;
    var dy = t[0].clientY - t[1].clientY;
    return Math.sqrt(dx * dx + dy * dy);
  }
  function pinchCenter(t) {
    var r = canvas.getBoundingClientRect();
    var cx = (t[0].clientX + t[1].clientX) / 2;
    var cy = (t[0].clientY + t[1].clientY) / 2;
    return { x: (cx - r.left) * (canvas.width / r.width), y: (cy - r.top) * (canvas.height / r.height) };
  }

  canvas.addEventListener('touchstart', function(e) {
    e.preventDefault();
    if (e.touches.length >= 2 && _imgState) {
      // Enter image mode
      _imgMode = true;
      spDrawing = false;
      _currentStroke = null;
      _imgState.selected = true;
      _pinchStart = {
        dist: pinchDist(e.touches),
        center: pinchCenter(e.touches),
        imgX: _imgState.x, imgY: _imgState.y,
        imgW: _imgState.w, imgH: _imgState.h
      };
      redrawCanvas();
      return;
    }
    // 1 finger = draw
    if (_imgState && _imgState.selected) { _imgState.selected = false; redrawCanvas(); }
    var pt = getTouchPos(e.touches[0]);
    spDrawing = true;
    var lw = parseInt(document.getElementById('spLineWidth').value) * 2;
    _currentStroke = { color: spColor, width: lw, erasing: spErasing, points: [pt] };
    spCtx.beginPath(); spCtx.moveTo(pt.x, pt.y);
  }, { passive: false });

  canvas.addEventListener('touchmove', function(e) {
    e.preventDefault();
    if (_imgMode && _imgState && _pinchStart && e.touches.length >= 2) {
      // Pinch resize
      var curDist = pinchDist(e.touches);
      var scale = curDist / _pinchStart.dist;
      var aspect = _pinchStart.imgH / _pinchStart.imgW;
      _imgState.w = Math.max(40, _pinchStart.imgW * scale);
      _imgState.h = _imgState.w * aspect;
      // Pan move
      var curCenter = pinchCenter(e.touches);
      _imgState.x = _pinchStart.imgX + (curCenter.x - _pinchStart.center.x);
      _imgState.y = _pinchStart.imgY + (curCenter.y - _pinchStart.center.y);
      redrawCanvas();
      return;
    }
    // 1 finger draw
    if (!spDrawing || e.touches.length !== 1) return;
    var pt = getTouchPos(e.touches[0]);
    var lw = parseInt(document.getElementById('spLineWidth').value) * 2;
    spCtx.lineWidth = lw;
    if (spErasing) {
      spCtx.globalCompositeOperation = 'destination-out'; spCtx.strokeStyle = 'rgba(0,0,0,1)';
    } else {
      spCtx.globalCompositeOperation = 'source-over'; spCtx.strokeStyle = spColor;
    }
    spCtx.lineTo(pt.x, pt.y); spCtx.stroke();
    if (_currentStroke) _currentStroke.points.push(pt);
  }, { passive: false });

  canvas.addEventListener('touchend', function(e) {
    e.preventDefault();
    if (e.touches.length === 0) {
      if (_imgMode && _imgState) {
        _imgMode = false; _imgState.selected = false; _pinchStart = null; redrawCanvas();
      }
      spDrawing = false;
      if (_currentStroke && _currentStroke.points.length > 1) { window._spStrokes.push(_currentStroke); }
      _currentStroke = null;
    } else if (e.touches.length === 1 && _imgMode) {
      // Went from 2 to 1 finger - update pinch start for continued pan
      _pinchStart = null;
    }
  }, { passive: false });

  // Also support mouse for desktop
  canvas.onmousedown = function(e) {
    e.preventDefault();
    if (_imgState && _imgState.selected) { _imgState.selected = false; redrawCanvas(); }
    var pt = spPos(e);
    spDrawing = true;
    var lw = parseInt(document.getElementById('spLineWidth').value) * 2;
    _currentStroke = { color: spColor, width: lw, erasing: spErasing, points: [pt] };
    spCtx.beginPath(); spCtx.moveTo(pt.x, pt.y);
  };
  canvas.onmousemove = function(e) {
    e.preventDefault();
    if (!spDrawing) return;
    var pt = spPos(e);
    var lw = parseInt(document.getElementById('spLineWidth').value) * 2;
    spCtx.lineWidth = lw;
    if (spErasing) { spCtx.globalCompositeOperation = 'destination-out'; spCtx.strokeStyle = 'rgba(0,0,0,1)'; }
    else { spCtx.globalCompositeOperation = 'source-over'; spCtx.strokeStyle = spColor; }
    spCtx.lineTo(pt.x, pt.y); spCtx.stroke();
    if (_currentStroke) _currentStroke.points.push(pt);
  };
  canvas.onmouseup = function(e) {
    e.preventDefault(); spDrawing = false;
    if (_currentStroke && _currentStroke.points.length > 1) { window._spStrokes.push(_currentStroke); }
    _currentStroke = null;
  };
  canvas.onmouseleave = function() { spDrawing = false; _currentStroke = null; };
}

function spPos(e) {
  var c = document.getElementById('scratchpadCanvas');
  var r = c.getBoundingClientRect();
  return { x: (e.clientX - r.left) * (c.width / r.width), y: (e.clientY - r.top) * (c.height / r.height) };
}

function clearScratchpad() {
  var c = document.getElementById('scratchpadCanvas');
  if (c && c.getContext) {
    window._spStrokes = [];
    _currentStroke = null;
    // Reset image position/size
    _imgState = null;
    _imgLoaded = null;
    // Redraw bg then re-init image at default position
    var ctx = c.getContext('2d');
    ctx.globalCompositeOperation = 'source-over';
    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--canvas-bg').trim() || '#f5f5f5';
    ctx.fillRect(0, 0, c.width, c.height);
    drawProblemImageOnCanvas();
  }
}

function toggleEraser() {
  spErasing = !spErasing;
  document.getElementById('spEraser').classList.toggle('active', spErasing);
}

function setScratchColor(color, el) {
  spColor = color;
  spErasing = false;
  document.getElementById('spEraser').classList.remove('active');
  document.querySelectorAll('.sp-color').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
}

// ================================================================
// IMAGE OVERLAY CANVAS (draw on problem image with padding)
// ================================================================
var imgOvCtx = null;
var imgOvDrawing = false;

function initImageCanvas() {
  var img = document.getElementById('problemImg');
  var canvas = document.getElementById('imgOverlayCanvas');
  if (!img || !canvas) return;
  var wrap = document.getElementById('imgCanvasWrap');

  // Wait for layout
  requestAnimationFrame(() => {
    var displayW = wrap.offsetWidth;
    var padPx = 80; // white padding for writing
    var imgW = img.naturalWidth;
    var imgH = img.naturalHeight;
    // Scale: image + padding to fit display width
    var totalW = imgW + padPx * 2;
    var scale = displayW / totalW;
    var totalH = imgH + padPx * 2;
    var displayH = totalH * scale;

    // Set canvas size (2x for retina)
    canvas.width = totalW * 2;
    canvas.height = totalH * 2;
    canvas.style.width = displayW + 'px';
    canvas.style.height = displayH + 'px';
    wrap.style.height = displayH + 'px';

    // Draw white bg + image onto canvas
    var ctx = canvas.getContext('2d');
    ctx.fillStyle = '#fff';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(img, padPx * 2, padPx * 2, imgW * 2, imgH * 2);

    // Hide original image (canvas replaces it)
    img.style.display = 'none';

    imgOvCtx = ctx;
    imgOvCtx.lineCap = 'round';
    imgOvCtx.lineJoin = 'round';
    imgOvDrawing = false;

    canvas.onpointerdown = (e) => {
      e.preventDefault();
      imgOvDrawing = true;
      imgOvCtx.beginPath();
      var p = imgOvPos(e);
      imgOvCtx.moveTo(p.x, p.y);
    };
    canvas.onpointermove = (e) => {
      e.preventDefault();
      if (!imgOvDrawing) return;
      var p = imgOvPos(e);
      var lw = parseInt(document.getElementById('spLineWidth').value);
      imgOvCtx.lineWidth = lw * 2;
      imgOvCtx.globalCompositeOperation = spErasing ? 'destination-out' : 'source-over';
      imgOvCtx.strokeStyle = spErasing ? 'rgba(0,0,0,1)' : (spColor === '#333' ? '#333' : spColor);
      imgOvCtx.lineTo(p.x, p.y);
      imgOvCtx.stroke();
    };
    canvas.onpointerup = () => { imgOvDrawing = false; };
    canvas.onpointerleave = () => { imgOvDrawing = false; };
  });
}

function imgOvPos(e) {
  var c = document.getElementById('imgOverlayCanvas');
  var r = c.getBoundingClientRect();
  return { x: (e.clientX - r.left) * (c.width / r.width), y: (e.clientY - r.top) * (c.height / r.height) };
}

function showGraduated(p) {
  var flash = document.getElementById('graduatedFlash');
  document.getElementById('graduatedMsg').textContent = `ã€Œ${p.topic}ã€ãŒå®šç€æ¸ˆã¿ã«ãªã‚Šã¾ã—ãŸï¼`;
  flash.classList.add('show');
  setTimeout(() => flash.classList.remove('show'), 2000);
}

function finishSession() {
  document.getElementById('cardWrap').classList.remove('active');
  document.getElementById('queueProgress').style.width = '100%';
  var cv = document.getElementById('completionView');
  cv.style.display = '';
  var total = sessionStats.correct + sessionStats.wrong + sessionStats.hard;

  if (isSingleProblemMode) {
    var result = sessionStats.correct > 0 ? 'âœ… ã§ããŸï¼' : sessionStats.hard > 0 ? 'ğŸ¤” ã‚ã‚„ã—ã„' : 'âŒ ã§ããªã‹ã£ãŸ';
    document.getElementById('completionMsg').textContent = result;
    var pid = currentQueue[0]?.id || '';
    document.getElementById('completionStats').innerHTML = `
      <div style="grid-column:1/-1;display:flex;gap:10px;justify-content:center;margin-top:12px;flex-wrap:wrap">
        <button class="btn-start" onclick="isSingleProblemMode=false;openProblemDetail('${pid}')" style="max-width:180px;background:var(--accent)">ğŸ”„ ã‚‚ã†ä¸€åº¦</button>
        <button class="btn-start" onclick="isSingleProblemMode=false;switchScreen('List')" style="max-width:180px;background:var(--surface2);border:1px solid var(--border)">ğŸ“š ä¸€è¦§ã«æˆ»ã‚‹</button>
      </div>
    `;
  } else {
    document.getElementById('completionMsg').textContent =
      sessionStats.graduated > 0
        ? `${sessionStats.graduated}å•ãŒæ–°ãŸã«å®šç€æ¸ˆã¿ã«ï¼`
        : 'ãŠã¤ã‹ã‚Œã•ã¾ï¼';
    document.getElementById('completionStats').innerHTML = `
      <div class="comp-stat"><div class="comp-stat-num" style="color:var(--success)">${sessionStats.correct}</div><div class="comp-stat-label">ã§ããŸ</div></div>
      <div class="comp-stat"><div class="comp-stat-num" style="color:var(--warning)">${sessionStats.hard}</div><div class="comp-stat-label">ã‚ã‚„ã—ã„</div></div>
      <div class="comp-stat"><div class="comp-stat-num" style="color:var(--danger)">${sessionStats.wrong}</div><div class="comp-stat-label">ã§ããªã‹ã£ãŸ</div></div>
      <div style="grid-column:1/-1;text-align:center;margin-top:8px">
        <button onclick="shareCard({type:'session'})" style="padding:8px 20px;border-radius:8px;background:var(--accent);color:#fff;font-weight:700;border:none;font-size:13px;cursor:pointer">ğŸ“± çµæœã‚’ã‚·ã‚§ã‚¢</button>
      </div>
    `;
  }
  // log session
  DATA.sessionLog.push({ date: today(), ...sessionStats });
  saveData(DATA);
  // Check milestones
  checkStreakMilestone();
  checkMasteredMilestone();
}

// ================================================================
// TOPIC PRESETS (ä¸­å­¦å—é¨“ã‚«ãƒªã‚­ãƒ¥ãƒ©ãƒ æº–æ‹ )
// ================================================================
var TOPIC_PRESETS = {
  'ç®—æ•°': {
    'è¨ˆç®—': ['è¨ˆç®—ã®å·¥å¤«','é€†ç®—','åˆ†æ•°ãƒ»å°æ•°'],
    'æ–‡ç« é¡Œ': ['å’Œå·®ç®—ãƒ»ã¤ã‚‹ã‹ã‚ç®—','éä¸è¶³ç®—ãƒ»æ¶ˆå»ç®—','å¹´é½¢ç®—ãƒ»å¹³å‡ç®—'],
    'å‰²åˆã¨æ¯”': ['å‰²åˆã®åŸºæœ¬','ç™¾åˆ†ç‡ãƒ»æ­©åˆ','æ¯”ã®æ–‡ç« é¡Œ','æ¿ƒåº¦ï¼ˆé£Ÿå¡©æ°´ï¼‰','æç›Šç®—'],
    'é€Ÿã•': ['é€Ÿã•ã®åŸºæœ¬','æ—…äººç®—','é€šéç®—','æµæ°´ç®—','æ™‚è¨ˆç®—'],
    'æ•°ã®æ€§è³ª': ['å€æ•°ã¨ç´„æ•°','è¦å‰‡æ€§','Né€²æ³•'],
    'å ´åˆã®æ•°': ['ä¸¦ã¹æ–¹','çµ„ã¿åˆã‚ã›','ã‚«ãƒ¼ãƒ‰ãƒ»ã‚µã‚¤ã‚³ãƒ­'],
    'å¹³é¢å›³å½¢': ['è§’åº¦','é¢ç©','å††','ç›¸ä¼¼ãƒ»é¢ç©æ¯”','å›³å½¢ã®ç§»å‹•'],
    'ç«‹ä½“å›³å½¢': ['ä½“ç©ãƒ»è¡¨é¢ç©','å±•é–‹å›³','å›è»¢ä½“','æ°´é‡å¤‰åŒ–'],
    'ç‰¹æ®Šç®—': ['ä»•äº‹ç®—','ãƒ‹ãƒ¥ãƒ¼ãƒˆãƒ³ç®—','æ¨ç†ã¨è«–è¨¼'],
    'ã‚°ãƒ©ãƒ•': ['æ¯”ä¾‹ã¨åæ¯”ä¾‹','ã‚°ãƒ©ãƒ•ã®èª­ã¿å–ã‚Š','ç‚¹ã®ç§»å‹•']
  },
  'å›½èª': {
    'èª­è§£': ['ç‰©èªæ–‡','èª¬æ˜æ–‡ãƒ»è«–èª¬æ–‡','éšç­†','è©©ãƒ»éŸ»æ–‡'],
    'èª­è§£ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯': ['å¿ƒæƒ…ã®èª­ã¿å–ã‚Š','ä¸»é¡Œãƒ»è¦æ—¨','æŒ‡ç¤ºèªãƒ»æ¥ç¶šèª','è¨˜è¿°ã®æ›¸ãæ–¹'],
    'èªå½™': ['æ…£ç”¨å¥','ã“ã¨ã‚ã–','å››å­—ç†Ÿèª','åŒéŸ³ç•°ç¾©èª','é¡ç¾©èªãƒ»å¯¾ç¾©èª'],
    'æ¼¢å­—ãƒ»æ–‡æ³•': ['æ¼¢å­—ã®èª­ã¿æ›¸ã','æ•¬èª','æ–‡æ³•','é€ã‚Šä»®åãƒ»éƒ¨é¦–'],
    'å¤å…¸': ['å¤å…¸ã®åŸºç¤','ä¿³å¥ãƒ»çŸ­æ­Œ']
  },
  'ç†ç§‘': {
    'ç”Ÿç‰©': ['æ¤ç‰©','æ˜†è™«ãƒ»å‹•ç‰©','äººä½“','å­£ç¯€ã¨ç”Ÿç‰©'],
    'ç‰©ç†': ['ã¦ã“ãƒ»ã°ã­ãƒ»æ»‘è»Š','æµ®åŠ›','æŒ¯ã‚Šå­','é›»æµãƒ»é›»ç£çŸ³','å…‰ãƒ»éŸ³'],
    'åŒ–å­¦': ['æ°´æº¶æ¶²','æ°—ä½“','ç‡ƒç„¼','çŠ¶æ…‹å¤‰åŒ–'],
    'åœ°å­¦': ['å¤©æ°—','å¤ªé™½','æœˆ','æ˜Ÿåº§ãƒ»æƒ‘æ˜Ÿ','åœ°å±¤ãƒ»ç«å±±ãƒ»åœ°éœ‡'],
    'ç’°å¢ƒ': ['ç’°å¢ƒå•é¡Œ','æµæ°´ã®ã¯ãŸã‚‰ã']
  },
  'ç¤¾ä¼š': {
    'åœ°ç†': ['å›½åœŸã¨åœ°å½¢','æ°—å€™','éƒ½é“åºœçœŒ','è¾²æ¥­','æ°´ç”£æ¥­','å·¥æ¥­','è²¿æ˜“','è³‡æºãƒ»ç’°å¢ƒ'],
    'æ­´å²ï¼ˆå¤ä»£ã€œä¸­ä¸–ï¼‰': ['æ—§çŸ³å™¨ã€œå¼¥ç”Ÿ','å¤å¢³ã€œé£›é³¥','å¥ˆè‰¯ãƒ»å¹³å®‰','éŒå€‰ãƒ»å®¤ç”º'],
    'æ­´å²ï¼ˆè¿‘ä¸–ã€œç¾ä»£ï¼‰': ['å®‰åœŸæ¡ƒå±±ãƒ»æ±Ÿæˆ¸','æ˜æ²»ç¶­æ–°','æ—¥æ¸…ãƒ»æ—¥éœ²ã€œå¤§æ­£','æ˜­å’Œã€œæˆ¦å¾Œ'],
    'å…¬æ°‘': ['æ†²æ³•ãƒ»äººæ¨©','å›½ä¼šãƒ»å†…é–£ãƒ»è£åˆ¤æ‰€','é¸æŒ™ãƒ»ç¨é‡‘ãƒ»ç¤¾ä¼šä¿éšœ'],
    'å›½éš›': ['å›½éš›é€£åˆ','ä¸–ç•Œã®åœ°ç†']
  }
};

var TOPIC_PRESETS_SECONDARY = {
  'æ•°å­¦': {
    'æ•°ã¨å¼': ['æ­£è² ã®æ•°','æ–‡å­—å¼','æ–¹ç¨‹å¼','é€£ç«‹æ–¹ç¨‹å¼','å¹³æ–¹æ ¹','å¤šé …å¼'],
    'é–¢æ•°': ['æ¯”ä¾‹ãƒ»åæ¯”ä¾‹','ä¸€æ¬¡é–¢æ•°','äºŒæ¬¡é–¢æ•°','ä¸‰è§’é–¢æ•°'],
    'å›³å½¢': ['å¹³é¢å›³å½¢','ç©ºé–“å›³å½¢','åˆåŒ','ç›¸ä¼¼','ä¸‰å¹³æ–¹ã®å®šç†','å††'],
    'ãƒ‡ãƒ¼ã‚¿ãƒ»ç¢ºç‡': ['ç¢ºç‡','çµ±è¨ˆ','æ¨™æœ¬èª¿æŸ»'],
    'æ•°åˆ—': ['ç­‰å·®ãƒ»ç­‰æ¯”','æ¼¸åŒ–å¼','æ•°å­¦çš„å¸°ç´æ³•'],
    'ãƒ™ã‚¯ãƒˆãƒ«ãƒ»è¡Œåˆ—': ['ãƒ™ã‚¯ãƒˆãƒ«','è¡Œåˆ—']
  },
  'è‹±èª': {
    'æ–‡æ³•': ['æ™‚åˆ¶','åŠ©å‹•è©','ä¸å®šè©ãƒ»å‹•åè©','é–¢ä¿‚ä»£åè©','ä»®å®šæ³•','å—å‹•æ…‹','æ¯”è¼ƒ'],
    'èª­è§£': ['é•·æ–‡èª­è§£','å†…å®¹ä¸€è‡´','èªå¥æ•´åº','ç©ºæ¬„è£œå……'],
    'èªå½™': ['å˜èª','ç†Ÿèªãƒ»ã‚¤ãƒ‡ã‚£ã‚ªãƒ ','å‰ç½®è©'],
    'ãƒªã‚¹ãƒ‹ãƒ³ã‚°': ['ãƒªã‚¹ãƒ‹ãƒ³ã‚°å•é¡Œ'],
    'è‹±ä½œæ–‡': ['å’Œæ–‡è‹±è¨³','è‡ªç”±è‹±ä½œæ–‡']
  },
  'å›½èª': {
    'ç¾ä»£æ–‡': ['è©•è«–','å°èª¬','éšç­†','è©©'],
    'å¤å…¸': ['å¤æ–‡æ–‡æ³•','å¤æ–‡èª­è§£','æ¼¢æ–‡å¥æ³•','æ¼¢æ–‡èª­è§£'],
    'èªå½™ãƒ»çŸ¥è­˜': ['æ¼¢å­—','èªå¥','æ–‡å­¦å²']
  },
  'ç†ç§‘': {
    'ç‰©ç†': ['åŠ›å­¦','æ³¢å‹•','ç†±åŠ›å­¦','é›»ç£æ°—','åŸå­'],
    'åŒ–å­¦': ['ç†è«–åŒ–å­¦','ç„¡æ©ŸåŒ–å­¦','æœ‰æ©ŸåŒ–å­¦'],
    'ç”Ÿç‰©': ['ç´°èƒãƒ»éºä¼','é€²åŒ–ãƒ»ç”Ÿæ…‹','äººä½“'],
    'åœ°å­¦': ['åœ°çƒãƒ»åœ°è³ª','å¤§æ°—ãƒ»æµ·æ´‹','å¤©æ–‡']
  },
  'ç¤¾ä¼š': {
    'åœ°ç†': ['è‡ªç„¶ç’°å¢ƒ','äººå£ãƒ»éƒ½å¸‚','ç”£æ¥­','åœ°åŸŸç ”ç©¶'],
    'æ­´å²': ['å¤ä»£','ä¸­ä¸–','è¿‘ä¸–','è¿‘ä»£','ç¾ä»£'],
    'å…¬æ°‘': ['æ”¿æ²»','çµŒæ¸ˆ','å›½éš›','å€«ç†']
  }
};

function getSchoolLevel() {
  return (DATA.settings && DATA.settings.schoolLevel) || 'elementary';
}

function getTopicPresets() {
  return getSchoolLevel() === 'secondary' ? TOPIC_PRESETS_SECONDARY : TOPIC_PRESETS;
}

function getSubjects() {
  return getSchoolLevel() === 'secondary'
    ? ['æ•°å­¦','è‹±èª','å›½èª','ç†ç§‘','ç¤¾ä¼š']
    : ['ç®—æ•°','å›½èª','ç†ç§‘','ç¤¾ä¼š'];
}

function onSchoolLevelChange() {
  var level = document.getElementById('settingSchoolLevel').value;
  DATA.settings.schoolLevel = level;
  saveData(DATA);
  updateSubjectDropdown();
}

function updateSubjectDropdown() {
  var sel = document.getElementById('addSubject');
  var subjects = getSubjects();
  var current = sel.value;
  sel.innerHTML = subjects.map(s => `<option value="${s}">${s}</option>`).join('');
  // Keep selection if still valid
  if (subjects.includes(current)) sel.value = current;
  onSubjectChange();
}

// Also update badge classes for new subjects
function getBadgeClass(subject) {
  return {
    'ç®—æ•°': 'badge-math', 'æ•°å­¦': 'badge-math',
    'è‹±èª': 'badge-english',
    'å›½èª': 'badge-japanese',
    'ç†ç§‘': 'badge-science', 'ç¤¾ä¼š': 'badge-social'
  }[subject] || 'badge-math';
}

// ================================================================
// IMAGE HANDLING
// ================================================================
var contentImageData = null;
var answerImageData = null;

function switchContentTab(type) {
  document.getElementById('contentTabText').classList.toggle('active', type === 'text');
  document.getElementById('contentTabImage').classList.toggle('active', type === 'image');
  document.getElementById('contentTextArea').style.display = type === 'text' ? '' : 'none';
  document.getElementById('contentImageArea').style.display = type === 'image' ? '' : 'none';
}
function switchAnswerTab(type) {
  document.getElementById('answerTabText').classList.toggle('active', type === 'text');
  document.getElementById('answerTabImage').classList.toggle('active', type === 'image');
  document.getElementById('answerTextArea').style.display = type === 'text' ? '' : 'none';
  document.getElementById('answerImageArea').style.display = type === 'image' ? '' : 'none';
}

function handleImgUpload(e, target) {
  var file = e.target.files[0];
  if (!file) return;
  processImageFile(file, target);
}

function processImageFile(file, target) {
  if (!file.type.startsWith('image/')) return;
  // compress to max 800px wide for storage efficiency
  var reader = new FileReader();
  reader.onload = (ev) => {
    var img = new Image();
    img.onload = () => {
      var canvas = document.createElement('canvas');
      var MAX = 800;
      var w = img.width, h = img.height;
      if (w > MAX) { h = h * MAX / w; w = MAX; }
      canvas.width = w; canvas.height = h;
      canvas.getContext('2d').drawImage(img, 0, 0, w, h);
      var dataUrl = canvas.toDataURL('image/jpeg', 0.8);
      if (target === 'content') {
        contentImageData = dataUrl;
        renderImgPreview('contentImgPreview', dataUrl, 'content');
      } else {
        answerImageData = dataUrl;
        renderImgPreview('answerImgPreview', dataUrl, 'answer');
      }
    };
    img.src = ev.target.result;
  };
  reader.readAsDataURL(file);
}

function renderImgPreview(elemId, dataUrl, target) {
  document.getElementById(elemId).innerHTML = `
    <img src="${dataUrl}" alt="preview">
    <button class="remove-img" onclick="event.stopPropagation();removeImg('${target}')" type="button">âœ•</button>
  `;
}
function removeImg(target) {
  if (target === 'content') {
    contentImageData = null;
    document.getElementById('contentImgPreview').innerHTML = 'ğŸ“· ã‚¿ãƒƒãƒ—ã§é¸æŠ / ãƒšãƒ¼ã‚¹ãƒˆã‚‚å¯';
    document.querySelector('#contentImgDrop input').value = '';
  } else {
    answerImageData = null;
    document.getElementById('answerImgPreview').innerHTML = 'ğŸ“· ã‚¿ãƒƒãƒ—ã§é¸æŠ / ãƒšãƒ¼ã‚¹ãƒˆã‚‚å¯';
    document.querySelector('#answerImgDrop input').value = '';
  }
}

// Clipboard paste support
document.addEventListener('paste', (e) => {
  var addScreen = document.getElementById('screenAdd');
  if (!addScreen.classList.contains('active')) return;
  var items = e.clipboardData?.items;
  if (!items) return;
  for (var item of items) {
    if (item.type.startsWith('image/')) {
      e.preventDefault();
      var file = item.getAsFile();
      if (addMode === 'quick') {
        // In quick mode, always paste to content
        processImageFile(file, 'content');
      } else {
        // In normal mode, determine target
        var contentImgActive = document.getElementById('contentTabImage').classList.contains('active');
        var answerImgActive = document.getElementById('answerTabImage').classList.contains('active');
        if (!contentImageData) {
          if (!contentImgActive) switchContentTab('image');
          processImageFile(file, 'content');
        } else if (!answerImageData) {
          if (!answerImgActive) switchAnswerTab('image');
          processImageFile(file, 'answer');
        }
      }
      break;
    }
  }
});

// ================================================================
// CORRECT RATE HELPER
// ================================================================
function toggleRateSlider() {
  var checked = document.getElementById('addRateCheck').checked;
  document.getElementById('rateSliderWrap').style.display = checked ? 'block' : 'none';
  if (checked) updateRateLabel();
}
function updateRateLabel() {
  var v = parseInt(document.getElementById('addCorrectRate').value);
  var label = document.getElementById('rateLabel');
  var hint = document.getElementById('rateHint');
  label.textContent = v + '%';
  if (v >= 70) {
    hint.innerHTML = '<span style="color:var(--success)">ğŸŸ¢ åŸºæœ¬å•é¡Œ â€” ç¢ºå®Ÿã«å–ã‚ŠãŸã„</span>';
  } else if (v >= 40) {
    hint.innerHTML = '<span style="color:var(--warning)">ğŸŸ¡ å·®ãŒã¤ãå•é¡Œ â€” æœ€å„ªå…ˆã§å¾©ç¿’</span>';
  } else if (v >= 20) {
    hint.innerHTML = '<span style="color:var(--danger)">ğŸ”´ é›£å• â€” å¿—æœ›æ ¡æ¬¡ç¬¬ã§å–æ¨é¸æŠ</span>';
  } else {
    hint.innerHTML = '<span style="color:var(--text2)">âšª è¶…é›£å• â€” æ¨ã¦å•å€™è£œ</span>';
  }
}

// ================================================================
// SUBJECT â†’ TOPIC 2-LEVEL DROPDOWN
// ================================================================
function onSubjectChange() {
  var subject = document.getElementById('addSubject').value;
  var catSelect = document.getElementById('addTopicCategory');
  var categories = getTopicPresets()[subject] || {};
  catSelect.innerHTML = '<option value="">-- ã‚«ãƒ†ã‚´ãƒª --</option>' +
    Object.keys(categories).map(c => `<option value="${c}">${c}</option>`).join('');
  document.getElementById('addTopicDetail').innerHTML = '<option value="">-- è©³ç´°ï¼ˆä»»æ„ï¼‰ --</option>';
}
function onCategoryChange() {
  var subject = document.getElementById('addSubject').value;
  var cat = document.getElementById('addTopicCategory').value;
  var detailSelect = document.getElementById('addTopicDetail');
  var details = (getTopicPresets()[subject] || {})[cat] || [];
  detailSelect.innerHTML = '<option value="">-- è©³ç´°ï¼ˆä»»æ„ï¼‰ --</option>' +
    details.map(d => `<option value="${d}">${d}</option>`).join('');
  document.getElementById('addTopic').value = cat;
}
function onDetailChange() {
  var cat = document.getElementById('addTopicCategory').value;
  var detail = document.getElementById('addTopicDetail').value;
  if (detail) {
    document.getElementById('addTopic').value = cat + ' - ' + detail;
  } else if (cat) {
    document.getElementById('addTopic').value = cat;
  }
}

// ================================================================
// ADD MODE (normal / quick)
// ================================================================
var addMode = 'normal';
function setAddMode(mode) {
  addMode = mode;
  var screen = document.getElementById('screenAdd');
  screen.classList.toggle('quick-mode', mode === 'quick');
  document.getElementById('modeNormal').classList.toggle('active', mode === 'normal');
  document.getElementById('modeQuick').classList.toggle('active', mode === 'quick');
  document.getElementById('quickModeHint').style.display = mode === 'quick' ? 'block' : 'none';
  if (mode === 'quick') {
    // In quick mode, force content to image tab
    switchContentTab('image');
  }
}

// ================================================================
// ADD PROBLEM
// ================================================================
function renderAdd() {
  // Only populate categories if dropdown is empty (first load)
  var catSelect = document.getElementById('addTopicCategory');
  if (catSelect.options.length <= 1) onSubjectChange();
  updateTagSuggestions();
  var pending = DATA.problems.filter(p => !p.frozen && getStage(p) !== 'mastered' && p.nextReviewDate <= today()).length;
  var warn = document.getElementById('addQueueWarning');
  if (pending > 20) {
    warn.innerHTML = `<div class="queue-warning">âš ï¸ ã‚­ãƒ¥ãƒ¼ã«${pending}å•æºœã¾ã£ã¦ã„ã¾ã™ã€‚ç™»éŒ²ã™ã‚‹ã¨æ˜æ—¥ä»¥é™ã«è¿½åŠ ã•ã‚Œã¾ã™ã€‚</div>`;
  } else {
    warn.innerHTML = '';
  }
}

var addCount = 0; // session registration counter

function addProblem() {
  // Build topic: use hand-input, or category, or "æœªåˆ†é¡" in quick mode
  var topic = document.getElementById('addTopic').value.trim();
  if (!topic && addMode === 'normal') {
    var cat = document.getElementById('addTopicCategory').value;
    if (cat) {
      topic = cat;
      document.getElementById('addTopic').value = cat;
    }
  }
  if (!topic) topic = addMode === 'quick' ? 'æœªåˆ†é¡' : '';
  if (!topic && addMode === 'normal') { 
    alert('å˜å…ƒã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„'); return; 
  }
  
  // In quick mode, require at least a photo
  if (addMode === 'quick' && !contentImageData) {
    alert('ğŸ“· å•é¡Œã®ç”»åƒã‚’æ’®å½±ã—ã¦ãã ã•ã„'); return;
  }

  // Determine content type
  var contentIsImage = (addMode === 'quick') || 
    (document.getElementById('contentTabImage').classList.contains('active') && contentImageData);
  var answerIsImage = document.getElementById('answerTabImage') && 
    document.getElementById('answerTabImage').classList.contains('active') && answerImageData;

  var rateChecked = document.getElementById('addRateCheck').checked;
  var correctRate = rateChecked ? parseInt(document.getElementById('addCorrectRate').value) : null;

  var freq = document.getElementById('addFreq').value;
  if (correctRate !== null && freq === 'medium') {
    if (correctRate >= 40 && correctRate < 70) freq = 'high';
    else if (correctRate < 20) freq = 'low';
  }

  // Parse tags
  var tagsRaw = (document.getElementById('addTags').value || '').trim();
  var tags = tagsRaw ? tagsRaw.split(/[\s,]+/).filter(t => t) : [];

  var p = {
    id: 'p_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5),
    subject: document.getElementById('addSubject').value,
    topic,
    source: document.getElementById('addSource').value.trim(),
    content: contentIsImage ? '' : document.getElementById('addContent').value.trim(),
    contentImage: contentIsImage ? contentImageData : null,
    answer: answerIsImage ? '' : (document.getElementById('addAnswer').value || '').trim(),
    answerImage: answerIsImage ? answerImageData : null,
    correctRate: correctRate,
    frequency: freq,
    difficulty: document.getElementById('addDiff').value,
    tags: tags,
    easeFactor: 2.5,
    interval: 0,
    repetitions: 0,
    consecutiveFailures: 0,
    masteryLevel: 0,
    nextReviewDate: today(),
    frozen: false,
    history: [],
    createdAt: today()
  };
  DATA.problems.push(p);
  saveData(DATA);
  addCount++;

  // Update tag suggestions
  updateTagSuggestions();

  // â‘  Keep: subject, source, freq, difficulty, correctRate, topic, category, detail, tags
  // Clear only: content, answer, images
  document.getElementById('addContent').value = '';
  document.getElementById('addAnswer').value = '';
  contentImageData = null; answerImageData = null;
  document.getElementById('contentImgPreview').innerHTML = 'ğŸ“· ã‚¿ãƒƒãƒ—ã§é¸æŠ / ãƒšãƒ¼ã‚¹ãƒˆã‚‚å¯';
  document.getElementById('answerImgPreview').innerHTML = 'ğŸ“· ã‚¿ãƒƒãƒ—ã§é¸æŠ / ãƒšãƒ¼ã‚¹ãƒˆã‚‚å¯';
  if (addMode === 'normal') {
    switchContentTab('text'); switchAnswerTab('text');
  }

  // â‘¡ Toast near button
  var toast = document.getElementById('addSuccessToast');
  toast.textContent = `âœ…ã€Œ${topic}ã€ã‚’ç™»éŒ²ã—ã¾ã—ãŸï¼ˆ${addCount}å•ç›®ï¼‰`;
  toast.style.display = 'block';
  setTimeout(() => { toast.style.display = 'none'; }, 2500);
  document.getElementById('addContinueHint').style.display = 'block';
}

// ================================================================
// CLIPBOARD PASTE BUTTON (for iPad)
// ================================================================
async function pasteFromClipboard(target) {
  try {
    var items = await navigator.clipboard.read();
    for (var item of items) {
      var imageType = item.types.find(t => t.startsWith('image/'));
      if (imageType) {
        var blob = await item.getType(imageType);
        processImageFile(blob, target);
        return;
      }
    }
    alert('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ç”»åƒãŒã‚ã‚Šã¾ã›ã‚“');
  } catch(e) {
    alert('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
  }
}

// ================================================================
// TAG SUGGESTIONS
// ================================================================
function updateTagSuggestions() {
  var allTags = {};
  DATA.problems.forEach(p => (p.tags || []).forEach(t => { allTags[t] = (allTags[t] || 0) + 1; }));
  var sorted = Object.entries(allTags).sort((a,b) => b[1] - a[1]).slice(0, 8);
  var container = document.getElementById('tagSuggestions');
  if (!container) return;
  container.innerHTML = sorted.map(([tag]) => 
    `<button class="sp-btn" style="font-size:11px" onclick="addTagFromSuggestion('${tag}')">#${tag}</button>`
  ).join('');
}
function addTagFromSuggestion(tag) {
  var input = document.getElementById('addTags');
  var current = input.value.trim();
  if (current.split(/[\s,]+/).includes(tag)) return;
  input.value = current ? current + ' ' + tag : tag;
}

// ================================================================
// CONFETTI EFFECT
// ================================================================
function fireConfetti() {
  var canvas = document.createElement('canvas');
  canvas.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:9999';
  document.body.appendChild(canvas);
  var ctx = canvas.getContext('2d');
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  var pieces = [];
  var colors = ['#6c63ff','#4ecdc4','#ff6b6b','#ffd93d','#51cf66','#ff9ff3','#54a0ff'];
  for (var i = 0; i < 80; i++) {
    pieces.push({
      x: canvas.width * 0.5 + (Math.random() - 0.5) * 200,
      y: canvas.height * 0.5,
      vx: (Math.random() - 0.5) * 16,
      vy: -Math.random() * 18 - 4,
      w: Math.random() * 8 + 4,
      h: Math.random() * 6 + 2,
      color: colors[Math.floor(Math.random() * colors.length)],
      rot: Math.random() * 360,
      rv: (Math.random() - 0.5) * 12,
      gravity: 0.4 + Math.random() * 0.2
    });
  }
  var frame = 0;
  function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    pieces.forEach(p => {
      p.x += p.vx; p.y += p.vy; p.vy += p.gravity; p.rot += p.rv;
      ctx.save(); ctx.translate(p.x, p.y); ctx.rotate(p.rot * Math.PI / 180);
      ctx.fillStyle = p.color; ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
      ctx.restore();
    });
    frame++;
    if (frame < 60) requestAnimationFrame(draw);
    else document.body.removeChild(canvas);
  }
  draw();
}

// ================================================================
// PROBLEM DETAIL VIEW (from list â†’ solve/edit)
// ================================================================
var isSingleProblemMode = false;

function openProblemDetail(id) {
  var p = DATA.problems.find(x => x.id === id);
  if (!p) return;
  isSingleProblemMode = true;
  sessionStats = { correct: 0, wrong: 0, hard: 0, graduated: 0 };
  switchScreen('Today');
  // Set queue AFTER switchScreen (which calls renderToday and overwrites currentQueue)
  currentQueue = [p];
  currentIndex = 0;
  document.getElementById('queueSummary').style.display = 'none';
  document.getElementById('completionView').style.display = 'none';
  document.getElementById('cardWrap').classList.add('active');
  showCard();
}

// ================================================================
// PROBLEM LIST
// ================================================================
var listFilter = 'all';
var listTagFilter = '';
var listSubjectFilter = '';
function renderList() {
  // Curriculum filter
  var cFilter = document.getElementById('curriculumFilter');
  var currFilter = cFilter ? cFilter.value : 'all';
  var juku = DATA.settings.jukuType || 'none';
  var gradeInfo = getJukuGradeMonth(DATA.settings.birthDate);

  var container = document.getElementById('problemListContainer');
  var filterRow = document.getElementById('filterRow');
  var subjectFilterRow = document.getElementById('subjectFilterRow');
  var tagFilterRow = document.getElementById('tagFilterRow');
  var filters = [
    { key: 'all', label: 'ã™ã¹ã¦' },
    { key: 'priority', label: 'ğŸ”´ æœ€å„ªå…ˆ' },
    { key: 'review', label: 'ğŸŸ¡ å¾©ç¿’' },
    { key: 'graduated', label: 'ğŸŸ¢ å®šç€æ¸ˆ' },
    { key: 'frozen', label: 'â„ï¸ å‡çµ' },
  ];
  filterRow.innerHTML = filters.map(f =>
    `<button class="filter-chip ${listFilter === f.key ? 'active' : ''}" onclick="listFilter='${f.key}';renderList()">${f.label}</button>`
  ).join('');

  // Subject filter
  var subjects = [...new Set(DATA.problems.map(p => p.subject))];
  subjectFilterRow.innerHTML = `<button class="filter-chip ${!listSubjectFilter ? 'active' : ''}" onclick="listSubjectFilter='';renderList()">å…¨æ•™ç§‘</button>` +
    subjects.map(s => `<button class="filter-chip ${listSubjectFilter === s ? 'active' : ''}" onclick="listSubjectFilter='${s}';renderList()">${s}</button>`).join('');

  // Tag filter
  var allTags = {};
  DATA.problems.forEach(p => (p.tags || []).forEach(t => { allTags[t] = (allTags[t] || 0) + 1; }));
  var tagList = Object.entries(allTags).sort((a,b) => b[1] - a[1]);
  tagFilterRow.innerHTML = tagList.length ? (`<button class="filter-chip ${!listTagFilter ? 'active' : ''}" onclick="listTagFilter='';renderList()">å…¨ã‚¿ã‚°</button>` +
    tagList.map(([tag]) => `<button class="filter-chip ${listTagFilter === tag ? 'active' : ''}" onclick="listTagFilter='${tag}';renderList()">#${tag}</button>`).join('')) : '';

  var items = DATA.problems;
  if (listFilter !== 'all') items = items.filter(p => classifyZone(p) === listFilter);
  if (listSubjectFilter) items = items.filter(p => p.subject === listSubjectFilter);
  if (listTagFilter) items = items.filter(p => (p.tags || []).includes(listTagFilter));

  // Sort
  var sortKey = document.getElementById('listSort') ? document.getElementById('listSort').value : 'next';
  items = [...items].sort((a, b) => {
    if (sortKey === 'next') return (a.nextReviewDate || '').localeCompare(b.nextReviewDate || '');
    if (sortKey === 'created') return (b.createdAt || '').localeCompare(a.createdAt || '');
    if (sortKey === 'topic') return (a.topic || '').localeCompare(b.topic || '');
    if (sortKey === 'failures') return (b.consecutiveFailures || 0) - (a.consecutiveFailures || 0);
    if (sortKey === 'recentWrong') {
      var aLast = (a.history || []).slice().reverse().find(h => h.result === 'incorrect');
      var bLast = (b.history || []).slice().reverse().find(h => h.result === 'incorrect');
      var aDate = aLast ? aLast.date : '0000';
      var bDate = bLast ? bLast.date : '0000';
      return bDate.localeCompare(aDate);
    }
    if (sortKey === 'almostMastered') {
      // Problems closest to mastery (high reps, not yet mastered)
      var aScore = getStage(a) === 'reviewing' ? (a.repetitions || 0) : -1;
      var bScore = getStage(b) === 'reviewing' ? (b.repetitions || 0) : -1;
      return bScore - aScore;
    }
    if (sortKey === 'longIdle') {
      var aLR = (a.history && a.history.length > 0) ? a.history[a.history.length-1].date : a.createdAt || '0000';
      var bLR = (b.history && b.history.length > 0) ? b.history[b.history.length-1].date : b.createdAt || '0000';
      return aLR.localeCompare(bLR); // oldest first
    }
    return 0;
  });

  if (items.length === 0) {
    container.innerHTML = '<div class="empty-state"><div class="icon">ğŸ“</div><p>å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“</p></div>';
    return;
  }
  container.innerHTML = items.map(p => {
    var stage = getStage(p);
    var color = {new:'var(--accent)',learning:'var(--warning)',reviewing:'#4ecdc4',mastered:'var(--success)',frozen:'var(--frozen)'}[stage] || 'var(--text2)';
    var hist = (p.history || []).slice(-5);
    var dotsHtml = hist.map(h => h.result === 'correct' ? 'â­•' : h.result === 'hard' ? 'ğŸ”º' : 'âŒ').join('');
    var tagsHtml = (p.tags||[]).map(t => `<span style="font-size:9px;padding:1px 5px;border-radius:3px;background:var(--surface2);color:var(--text2)">#${t}</span>`).join(' ');
    var lastReview = (p.history && p.history.length > 0) ? p.history[p.history.length-1].date : null;
    var createdShort = p.createdAt ? p.createdAt.replace(/^\d{4}-/,'') : '';
    var lastShort = lastReview ? lastReview.replace(/^\d{4}-/,'') : '';
    var preview = '';
    if (p.contentImage) {
      preview = '<div style="margin-top:4px"><img src="' + p.contentImage + '" style="max-height:40px;border-radius:4px;opacity:.8"></div>';
    } else if (p.content) {
      var txt = p.content.length > 40 ? p.content.substring(0, 40) + 'â€¦' : p.content;
      preview = '<div style="font-size:10px;color:var(--text2);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:220px">' + txt + '</div>';
    }
    return `
      <div class="problem-list-item" style="flex-wrap:wrap">
        <div class="pli-status" style="background:${color}"></div>
        <div class="pli-info" style="min-width:0;flex:1">
          <div class="pli-topic">${p.subject} / ${p.topic} ${getStageBadge(p)} ${getTypeBadge(p)}</div>
          <div class="pli-sub">${p.source || ''} ãƒ» ${p.interval||0}æ—¥å¾Œ ãƒ» <span style="color:var(--text2)">ä½œæˆ${createdShort}</span>${lastShort?' ãƒ» <span style="color:var(--text2)">æœ€çµ‚'+lastShort+'</span>':''}</div>
          ${preview}
          <div style="display:flex;gap:4px;align-items:center;margin-top:2px;font-size:10px">
            ${dotsHtml || '<span style="color:var(--text2)">å±¥æ­´ãªã—</span>'}
            ${tagsHtml ? ' ' + tagsHtml : ''}
          </div>
        </div>
        <div style="display:flex;gap:4px;flex-shrink:0">
          <button class="btn-freeze" onclick="event.stopPropagation();openProblemDetail('${p.id}')" style="background:rgba(108,99,255,.12);border-color:var(--accent);color:var(--accent)">â–¶è§£ã</button>
          <button class="btn-freeze" onclick="event.stopPropagation();${p.frozen ? "unfreezeProblem('" + p.id + "')" : "freezeProblem('" + p.id + "')"}">${p.frozen ? 'è§£å‡' : 'å‡çµ'}</button>
          <button class="btn-delete-p" onclick="event.stopPropagation();deleteProblem('${p.id}')">å‰Šé™¤</button>
        </div>
      </div>`;
  }).join('');
}


function freezeProblem(id) {
  var p = DATA.problems.find(x => x.id === id);
  if (p) { p.frozen = true; saveData(DATA); renderList(); renderToday(); }
}
function unfreezeProblem(id) {
  var p = DATA.problems.find(x => x.id === id);
  if (p) { p.frozen = false; p.nextReviewDate = today(); saveData(DATA); renderList(); }
}
function deleteProblem(id) {
  if (!confirm('ã“ã®å•é¡Œã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
  DATA.problems = DATA.problems.filter(x => x.id !== id);
  saveData(DATA); renderList();
}

// ================================================================
// DASHBOARD
// ================================================================
function renderDashboard() {
  var zones = { priority: 0, review: 0, graduated: 0, frozen: 0, discard: 0 };
  _zoneProbs={priority:[],review:[],graduated:[],frozen:[],discard:[]};
  DATA.problems.forEach(p => { var z = classifyZone(p); zones[z] = (zones[z]||0) + 1; (_zoneProbs[z]=_zoneProbs[z]||[]).push(p); });
  // Stretch Zone stats
  var szStats = getStretchZoneStats();
  var szEl = document.getElementById('stretchZoneGrid');
  if(szEl){
    szEl.innerHTML = '<div class="sz-grid">'
      +'<div class="sz-card sz-stretch-card" onclick="showSZDetail(\'stretch\')"><div class="sz-num">'+szStats.totals.stretch+'</div><div class="sz-label">âœ¨ ã‚¹ãƒˆãƒ¬ãƒƒãƒ</div></div>'
      +'<div class="sz-card sz-comfort-card" onclick="showSZDetail(\'comfort\')"><div class="sz-num">'+szStats.totals.comfort+'</div><div class="sz-label">âš ï¸ ã‚³ãƒ³ãƒ•ã‚©ãƒ¼ãƒˆ</div></div>'
      +'<div class="sz-card sz-panic-card" onclick="showSZDetail(\'panic\')"><div class="sz-num">'+szStats.totals.panic+'</div><div class="sz-label">ğŸ”´ ãƒ‘ãƒ‹ãƒƒã‚¯</div></div>'
      +'</div>';
    // Per-subject breakdown
    var subjects = getSubjects();
    var szBreakdown = subjects.map(function(s){
      var st=szStats.bySubject.stretch[s]||0,co=szStats.bySubject.comfort[s]||0,pa=szStats.bySubject.panic[s]||0;
      var tot=st+co+pa;if(!tot)return'';
      return '<div style="display:flex;align-items:center;gap:8px;font-size:11px;margin-top:4px">'
        +'<span style="width:40px;font-weight:600">'+s+'</span>'
        +'<div class="sz-bar" style="flex:1">'
        +'<div class="sz-bar-seg" style="width:'+Math.round(st/tot*100)+'%;background:var(--accent)"></div>'
        +'<div class="sz-bar-seg" style="width:'+Math.round(co/tot*100)+'%;background:#4ecdc4"></div>'
        +'<div class="sz-bar-seg" style="width:'+Math.round(pa/tot*100)+'%;background:var(--danger)"></div>'
        +'</div>'
        +'<span style="color:var(--text2)">'+tot+'å•</span></div>';
    }).join('');
    szEl.innerHTML += szBreakdown;
  }
  // Stage counts for dashboard
  var stageCounts = {new:0, learning:0, reviewing:0, mastered:0, frozen:0};
  DATA.problems.forEach(function(p){ stageCounts[getStage(p)]++; });
  document.getElementById('zoneGrid').innerHTML = `
    <div class="zone-card zone-priority" onclick="showZoneDetail('priority','ğŸ†• ã¯ã˜ã‚ã¦')" style="cursor:pointer"><div class="num">${stageCounts.new}</div><div class="label">ğŸ†• ã¯ã˜ã‚ã¦</div></div>
    <div class="zone-card zone-review" onclick="showZoneDetail('review','ğŸ“ ç·´ç¿’ä¸­')" style="cursor:pointer"><div class="num">${stageCounts.learning}</div><div class="label">ğŸ“ ç·´ç¿’ä¸­</div></div>
    <div class="zone-card zone-review" onclick="showZoneDetail('review','ğŸ”„ å¾©ç¿’ä¸­')" style="cursor:pointer;border-color:#4ecdc4"><div class="num">${stageCounts.reviewing}</div><div class="label">ğŸ”„ å¾©ç¿’ä¸­</div></div>
    <div class="zone-card zone-graduated" onclick="showZoneDetail('graduated','âœ… å®šç€')" style="cursor:pointer"><div class="num">${stageCounts.mastered}</div><div class="label">âœ… å®šç€</div></div>
    <div class="zone-card zone-frozen" onclick="showZoneDetail('frozen','â„ï¸ å‡çµ')" style="cursor:pointer"><div class="num">${stageCounts.frozen}</div><div class="label">â„ï¸ å‡çµä¸­</div></div>
  `;
  // subject bars
  var subjects = getSubjects();
  var colors = ['var(--accent)', 'var(--danger)', 'var(--accent2)', 'var(--warning)', 'var(--frozen)'];
  var bars = document.getElementById('subjectBars');
  bars.innerHTML = subjects.map((s, i) => {
    var all = DATA.problems.filter(p => p.subject === s);
    var grad = all.filter(p => getStage(p) === 'mastered').length;
    var pct = all.length > 0 ? Math.round(grad / all.length * 100) : 0;
    return `
      <div class="subject-row">
        <span class="subject-name">${s}</span>
        <div class="subject-bar-bg"><div class="subject-bar" style="width:${pct}%;background:${colors[i]}"></div></div>
        <span class="subject-pct">${pct}%</span>
      </div>
    `;
  }).join('');
  // weekly report
  var weekAgo = new Date(); weekAgo.setDate(weekAgo.getDate() - 7);
  var weekStr = weekAgo.toISOString().split('T')[0];
  var weekSessions = DATA.sessionLog.filter(s => s.date >= weekStr);
  var weekCorrect = weekSessions.reduce((a, s) => a + s.correct, 0);
  var weekWrong = weekSessions.reduce((a, s) => a + s.wrong, 0);
  var weekGrad = weekSessions.reduce((a, s) => a + (s.graduated || 0), 0);
  document.getElementById('weeklyContent').innerHTML = `
    å¾©ç¿’ã‚»ãƒƒã‚·ãƒ§ãƒ³: <strong>${weekSessions.length}å›</strong><br>
    æ­£è§£: <strong style="color:var(--success)">${weekCorrect}</strong> ï¼
    ä¸æ­£è§£: <strong style="color:var(--danger)">${weekWrong}</strong><br>
    æ–°ãŸã«å®šç€: <strong style="color:var(--accent)">${weekGrad}å•</strong><br>
    å…¨ä½“ã®å®šç€ç‡: <strong>${DATA.problems.length > 0 ? Math.round(DATA.problems.filter(p=>getStage(p)==='mastered').length / DATA.problems.length * 100) : 0}%</strong>
  `;
}

// ================================================================
// SETTINGS
// ================================================================
function renderSettings() {
  if(document.getElementById('settingExamDate')){
    document.getElementById('settingBirthDate').value=DATA.settings.birthDate||'';
  document.getElementById('settingJuku').value=DATA.settings.jukuType||'none';
  updateJukuInfo();
  document.getElementById('settingExamDate').value=DATA.settings.examDate||'';
    document.getElementById('settingExamName').value=DATA.settings.examName||'';
  }
  var level = (DATA.settings && DATA.settings.schoolLevel) || 'elementary';
  document.getElementById('settingSchoolLevel').value = level;
  document.getElementById('settingCap').value = DATA.settings.dailyCap || 15;
  document.getElementById('settingFreeze').value = DATA.settings.freezeThreshold || 5;
  updateCapLabel();
  updateFreezeLabel();
}
function updateCapLabel() {
  var v = document.getElementById('settingCap').value;
  document.getElementById('capLabel').textContent = v + 'å•';
  DATA.settings.dailyCap = parseInt(v);
  saveData(DATA);
}
function updateFreezeLabel() {
  var v = document.getElementById('settingFreeze').value;
  document.getElementById('freezeLabel').textContent = v + 'å›';
  document.getElementById('algoFreezeN').textContent = v;
  DATA.settings.freezeThreshold = parseInt(v);
  saveData(DATA);
}

// ================================================================
// IMPORT / EXPORT
// ================================================================
function exportData() {
  var blob = new Blob([JSON.stringify(DATA, null, 2)], { type: 'application/json' });
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url; a.download = `revenge-note-${today()}.json`;
  a.click(); URL.revokeObjectURL(url);
}
function importData(e) {
  var file = e.target.files[0];
  if (!file) return;
  var reader = new FileReader();
  reader.onload = () => {
    try {
      var imported = JSON.parse(reader.result);
      if (imported.problems) {
        DATA = imported;
        saveData(DATA);
        alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†');
        switchScreen('Today');
      }
    } catch { alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸ'); }
  };
  reader.readAsText(file);
}
function resetAll() {
  localStorage.removeItem(STORAGE_KEY);
  location.reload();
}

// ================================================================
// SAMPLE DATA
// ================================================================
function loadSampleData() {
  if (DATA.problems.length > 0 && !confirm('æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã«è¿½åŠ ã•ã‚Œã¾ã™ã€‚ç¶šã‘ã¾ã™ã‹ï¼Ÿ')) return;
  var samples = [
    // ============ 4å¹´ç”Ÿ ============
    // ç®—æ•°4å¹´
    { subject:'ç®—æ•°', topic:'è¨ˆç®— - è¨ˆç®—ã®å·¥å¤«', source:'äºˆç¿’ã‚·ãƒªãƒ¼ã‚º 4å¹´ä¸Š ç¬¬3å›', frequency:'high', difficulty:'basic', content:'25Ã—36 ã‚’å·¥å¤«ã—ã¦è¨ˆç®—ã—ãªã•ã„', answer:'ã€è§£æ³•ã€‘25Ã—4=100ã‚’åˆ©ç”¨\n25Ã—36=25Ã—4Ã—9=100Ã—9=900\nğŸ’¡25Ã—4=100ã‚’è¦šãˆã‚‹ã¨è¨ˆç®—ãŒé€Ÿã„', correctRate:75, tags:['4å¹´','è¨ˆç®—'] },
    { subject:'ç®—æ•°', topic:'è¨ˆç®— - é€†ç®—', source:'äºˆç¿’ã‚·ãƒªãƒ¼ã‚º 4å¹´ä¸Š ç¬¬5å›', frequency:'high', difficulty:'basic', content:'â–¡Ã—7ï¼‹15ï¼71 ã®â–¡ã‚’æ±‚ã‚ãªã•ã„', answer:'â–¡ï¼8', correctRate:68, tags:['4å¹´','è¨ˆç®—'] },
    { subject:'ç®—æ•°', topic:'æ–‡ç« é¡Œ - å’Œå·®ç®—', source:'äºˆç¿’ã‚·ãƒªãƒ¼ã‚º 4å¹´ä¸Š ç¬¬8å›', frequency:'high', difficulty:'standard', content:'å…„ã¨å¼Ÿã®æŒã£ã¦ã„ã‚‹ãŠé‡‘ã®åˆè¨ˆã¯3200å††ã€å·®ã¯400å††ã€‚ãã‚Œãã‚Œã„ãã‚‰ã‹', answer:'ã€å’Œå·®ç®—ã®å…¬å¼ã€‘\nå¤§=(å’Œ+å·®)Ã·2=(3200+400)Ã·2=1800å††\nå°=å’Œ-å¤§=3200-1800=1400å††\nğŸ’¡ç·šåˆ†å›³ã‚’æã„ã¦å·®ã‚’æƒãˆã‚‹', correctRate:62, tags:['4å¹´','ç‰¹æ®Šç®—'] },
    { subject:'ç®—æ•°', topic:'æ–‡ç« é¡Œ - ã¤ã‚‹ã‹ã‚ç®—', source:'äºˆç¿’ã‚·ãƒªãƒ¼ã‚º 4å¹´ä¸‹ ç¬¬2å›', frequency:'high', difficulty:'standard', content:'ãƒ„ãƒ«ã¨ã‚«ãƒ¡ãŒåˆã‚ã›ã¦10åŒ¹ã€è¶³ã®åˆè¨ˆãŒ28æœ¬ã€‚ãã‚Œãã‚Œä½•åŒ¹ã‹', answer:'ã€ã¤ã‚‹ã‹ã‚ç®—ã€‘å…¨éƒ¨ãƒ„ãƒ«ã¨ä»®å®šâ†’è¶³20æœ¬\nå®Ÿéš›28æœ¬â†’8æœ¬å¤šã„\nã‚«ãƒ¡ã¯ãƒ„ãƒ«ã‚ˆã‚Š2æœ¬å¤šã„â†’8Ã·2=ã‚«ãƒ¡4åŒ¹ ãƒ„ãƒ«6åŒ¹', correctRate:55, tags:['4å¹´','ç‰¹æ®Šç®—'] },
    { subject:'ç®—æ•°', topic:'å¹³é¢å›³å½¢ - è§’åº¦', source:'äºˆç¿’ã‚·ãƒªãƒ¼ã‚º 4å¹´ä¸‹ ç¬¬6å›', frequency:'high', difficulty:'basic', content:'ä¸‰è§’å½¢ã®å†…è§’ã®å’Œã¯ï¼Ÿ å››è§’å½¢ã¯ï¼Ÿ', answer:'ä¸‰è§’å½¢180Â° å››è§’å½¢360Â°', correctRate:85, tags:['4å¹´','å›³å½¢'] },
    { subject:'ç®—æ•°', topic:'æ•°ã®æ€§è³ª - å€æ•°ã¨ç´„æ•°', source:'äºˆç¿’ã‚·ãƒªãƒ¼ã‚º 4å¹´ä¸‹ ç¬¬10å›', frequency:'high', difficulty:'standard', content:'36ã®ç´„æ•°ã‚’ã™ã¹ã¦æ±‚ã‚ãªã•ã„', answer:'1,2,3,4,6,9,12,18,36ï¼ˆ9å€‹ï¼‰', correctRate:58, tags:['4å¹´','æ•°ã®æ€§è³ª'] },
    // å›½èª4å¹´
    { subject:'å›½èª', topic:'æ¼¢å­—ãƒ»æ–‡æ³• - æ¼¢å­—ã®èª­ã¿æ›¸ã', source:'æ¼¢å­—ã®è¦ 4å¹´', frequency:'high', difficulty:'basic', content:'ã€ŒåŠªåŠ›ã€ã€Œç«¶äº‰ã€ã€Œç©æ¥µã€ã®èª­ã¿ã¨æ›¸ã', answer:'ã©ã‚Šã‚‡ããƒ»ãã‚‡ã†ãã†ãƒ»ã›ã£ãã‚‡ã', correctRate:72, tags:['4å¹´','æ¼¢å­—'] },
    { subject:'å›½èª', topic:'èªå½™ - æ…£ç”¨å¥', source:'äºˆç¿’ã‚·ãƒªãƒ¼ã‚º 4å¹´ä¸Š ç¬¬6å›', frequency:'medium', difficulty:'standard', content:'ã€Œè…•ã‚’ãµã‚‹ã†ã€ã€Œç›®ã‚’ä¸¸ãã™ã‚‹ã€ã®æ„å‘³', answer:'è…•ã‚’ãµã‚‹ã†ï¼å®ŸåŠ›ã‚’ç™ºæ®ã™ã‚‹ã€€ç›®ã‚’ä¸¸ãã™ã‚‹ï¼é©šã', correctRate:60, tags:['4å¹´','èªå½™'] },
    { subject:'å›½èª', topic:'èª­è§£ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ - å¿ƒæƒ…ã®èª­ã¿å–ã‚Š', source:'äºˆç¿’ã‚·ãƒªãƒ¼ã‚º 4å¹´ä¸Š ç¬¬12å›', frequency:'high', difficulty:'standard', content:'ç‰©èªæ–‡ã§ç™»å ´äººç‰©ã®æ°—æŒã¡ãŒå¤‰ã‚ã‚‹ãã£ã‹ã‘ã‚’æ¢ã™æ–¹æ³•', answer:'ã€Œã—ã‹ã—ã€ã€Œã¨ã“ã‚ãŒã€ãªã©ã®é€†æ¥ï¼‹è¡Œå‹•ãƒ»è¡¨æƒ…ã®å¤‰åŒ–ã«æ³¨ç›®', correctRate:45, tags:['4å¹´','èª­è§£'] },
    // ç†ç§‘4å¹´
    { subject:'ç†ç§‘', topic:'ç”Ÿç‰© - å­£ç¯€ã¨ç”Ÿç‰©', source:'äºˆç¿’ã‚·ãƒªãƒ¼ã‚º 4å¹´ä¸Š ç¬¬4å›', frequency:'high', difficulty:'basic', content:'æ˜¥ã«å’²ãèŠ±ã‚’3ã¤ç­”ãˆãªã•ã„', answer:'ã‚µã‚¯ãƒ©ãƒ»ãƒãƒ¥ãƒ¼ãƒªãƒƒãƒ—ãƒ»ã‚¿ãƒ³ãƒãƒ', correctRate:80, tags:['4å¹´','ç”Ÿç‰©'] },
    { subject:'ç†ç§‘', topic:'ç‰©ç† - ã¦ã“', source:'äºˆç¿’ã‚·ãƒªãƒ¼ã‚º 4å¹´ä¸‹ ç¬¬7å›', frequency:'high', difficulty:'standard', content:'ã¦ã“ãŒã¤ã‚Šåˆã†æ¡ä»¶ï¼ˆå¼ã§è¡¨ã™ï¼‰', answer:'æ”¯ç‚¹ã‹ã‚‰ã®è·é›¢Ã—ãŠã‚‚ã‚Šã®é‡ã• ãŒå·¦å³ç­‰ã—ã„', correctRate:52, tags:['4å¹´','ç‰©ç†'] },
    { subject:'ç†ç§‘', topic:'åœ°å­¦ - å¤©æ°—', source:'äºˆç¿’ã‚·ãƒªãƒ¼ã‚º 4å¹´ä¸Š ç¬¬10å›', frequency:'medium', difficulty:'basic', content:'é›²ã®ç¨®é¡ã§é›¨ã‚’é™ã‚‰ã™ã‚‚ã®ã¯ï¼Ÿ', answer:'ä¹±å±¤é›²ï¼ˆã‚ã¾ãã‚‚ï¼‰ãƒ»ç©ä¹±é›²ï¼ˆã«ã‚…ã†ã©ã†ãã‚‚ï¼‰', correctRate:65, tags:['4å¹´','åœ°å­¦'] },
    // ç¤¾ä¼š4å¹´
    { subject:'ç¤¾ä¼š', topic:'åœ°ç† - éƒ½é“åºœçœŒ', source:'äºˆç¿’ã‚·ãƒªãƒ¼ã‚º 4å¹´ä¸Š ç¬¬1å›', frequency:'high', difficulty:'basic', content:'é–¢æ±åœ°æ–¹ã®1éƒ½6çœŒã‚’ã™ã¹ã¦ç­”ãˆãªã•ã„', answer:'æ±äº¬ãƒ»ç¥å¥ˆå·ãƒ»åƒè‘‰ãƒ»åŸ¼ç‰ãƒ»èŒ¨åŸãƒ»æ ƒæœ¨ãƒ»ç¾¤é¦¬', correctRate:70, tags:['4å¹´','åœ°ç†'] },
    { subject:'ç¤¾ä¼š', topic:'åœ°ç† - å›½åœŸã¨åœ°å½¢', source:'äºˆç¿’ã‚·ãƒªãƒ¼ã‚º 4å¹´ä¸Š ç¬¬3å›', frequency:'high', difficulty:'basic', content:'æ—¥æœ¬ã§ä¸€ç•ªé•·ã„å·ã¨ä¸€ç•ªåºƒã„æ¹–', answer:'ä¿¡æ¿ƒå·ï¼ˆ367kmï¼‰ãƒ»çµç¶æ¹–ï¼ˆ670kmÂ²ï¼‰', correctRate:75, tags:['4å¹´','åœ°ç†'] },
    { subject:'ç¤¾ä¼š', topic:'åœ°ç† - æ°—å€™', source:'äºˆç¿’ã‚·ãƒªãƒ¼ã‚º 4å¹´ä¸Š ç¬¬5å›', frequency:'medium', difficulty:'standard', content:'æ—¥æœ¬æµ·å´ã®å†¬ã®æ°—å€™ã®ç‰¹å¾´ã¨ãã®ç†ç”±', answer:'é›ªãŒå¤šã„ã€‚å­£ç¯€é¢¨ãŒæ—¥æœ¬æµ·ã®æ°´åˆ†ã‚’å«ã¿å±±è„ˆã«ã¶ã¤ã‹ã‚‹ãŸã‚', correctRate:50, tags:['4å¹´','åœ°ç†'] },

    // ============ 5å¹´ç”Ÿ ============
    // ç®—æ•°5å¹´
    { subject:'ç®—æ•°', topic:'å‰²åˆã¨æ¯” - ç™¾åˆ†ç‡ãƒ»æ­©åˆ', source:'äºˆç¿’ã‚·ãƒªãƒ¼ã‚º 5å¹´ä¸Š ç¬¬14å›', frequency:'high', difficulty:'basic', content:'å®šä¾¡2000å††ã®å“ç‰©ã‚’2å‰²å¼•ãã§è²·ã£ãŸã€‚æ”¯æ‰•ã£ãŸé‡‘é¡ã¯ï¼Ÿ', answer:'2000Ã—0.8ï¼1600å††', correctRate:72, tags:['5å¹´','å‰²åˆ'] },
    { subject:'ç®—æ•°', topic:'å‰²åˆã¨æ¯” - æ¿ƒåº¦ï¼ˆé£Ÿå¡©æ°´ï¼‰', source:'äºˆç¿’ã‚·ãƒªãƒ¼ã‚º 5å¹´ä¸‹ ç¬¬12å›', frequency:'high', difficulty:'hard', content:'8%ã®é£Ÿå¡©æ°´200gã«æ°´ã‚’ä½•gæ··ãœã‚‹ã¨5%ã«ãªã‚‹ã‹', answer:'é£Ÿå¡©:200Ã—0.08=16g\n5%ã«â†’16Ã·0.05=320g(å…¨ä½“)\næ°´:320-200=120g\nğŸ’¡é£Ÿå¡©ã®é‡ã•ãŒå¤‰ã‚ã‚‰ãªã„ã®ãŒé‰„å‰‡', correctRate:35, tags:['5å¹´','å‰²åˆ','é »å‡º'] },
    { subject:'ç®—æ•°', topic:'é€Ÿã• - æ—…äººç®—', source:'äºˆç¿’ã‚·ãƒªãƒ¼ã‚º 5å¹´ä¸‹ ç¬¬15å›', frequency:'high', difficulty:'standard', content:'å…„ã¯æ¯åˆ†80mã€å¼Ÿã¯æ¯åˆ†60mã§åŒã˜æ–¹å‘ã«æ­©ãã€‚600mé›¢ã‚Œã¦è¿½ã„ã‹ã‘ã‚‹ã¨ä½•åˆ†ã§è¿½ã„ã¤ãã‹', answer:'600Ã·(80-60)ï¼30åˆ†', correctRate:48, tags:['5å¹´','é€Ÿã•','é »å‡º'] },
    { subject:'ç®—æ•°', topic:'é€Ÿã• - é€šéç®—', source:'äºˆç¿’ã‚·ãƒªãƒ¼ã‚º 5å¹´ä¸‹ ç¬¬16å›', frequency:'high', difficulty:'hard', content:'é•·ã•150mã®åˆ—è»ŠãŒç§’é€Ÿ25mã§400mã®é‰„æ©‹ã‚’æ¸¡ã‚Šå§‹ã‚ã¦ã‹ã‚‰æ¸¡ã‚Šçµ‚ã‚ã‚‹ã¾ã§ä½•ç§’ã‹', answer:'é€²ã‚€è·é›¢=åˆ—è»Š+é‰„æ©‹=150+400=550m\næ™‚é–“:550Ã·25=22ç§’\nğŸ’¡å…ˆé ­ãŒå…¥ã£ã¦æœ€å¾Œå°¾ãŒå‡ºã‚‹ã¾ã§', correctRate:42, tags:['5å¹´','é€Ÿã•'] },
    { subject:'ç®—æ•°', topic:'å ´åˆã®æ•° - ä¸¦ã¹æ–¹', source:'äºˆç¿’ã‚·ãƒªãƒ¼ã‚º 5å¹´ä¸Š ç¬¬18å›', frequency:'medium', difficulty:'standard', content:'1,2,3,4 ã®4æšã®ã‚«ãƒ¼ãƒ‰ã‹ã‚‰3æšé¸ã‚“ã§3æ¡ã®æ•´æ•°ã‚’ä½œã‚‹ã€‚ä½•é€šã‚Šã‚ã‚‹ã‹', answer:'4Ã—3Ã—2ï¼24é€šã‚Š', correctRate:55, tags:['5å¹´','å ´åˆã®æ•°'] },
    { subject:'ç®—æ•°', topic:'å¹³é¢å›³å½¢ - ç›¸ä¼¼ãƒ»é¢ç©æ¯”', source:'äºˆç¿’ã‚·ãƒªãƒ¼ã‚º 5å¹´ä¸‹ ç¬¬20å›', frequency:'high', difficulty:'hard', content:'ç›¸ä¼¼æ¯”ãŒ2:3ã®ä¸‰è§’å½¢ã®é¢ç©æ¯”ã¯ï¼Ÿ', answer:'é¢ç©æ¯”=ç›¸ä¼¼æ¯”ã®2ä¹—â†’2Â²:3Â²=4:9\nğŸ’¡ä½“ç©æ¯”ãªã‚‰3ä¹—â†’8:27 è¶…é »å‡ºï¼', correctRate:40, tags:['5å¹´','å›³å½¢','é »å‡º'] },
    { subject:'ç®—æ•°', topic:'å¹³é¢å›³å½¢ - å††', source:'äºˆç¿’ã‚·ãƒªãƒ¼ã‚º 5å¹´ä¸Š ç¬¬20å›', frequency:'high', difficulty:'basic', content:'åŠå¾„5cmã®å††ã®é¢ç©ã¨å††å‘¨ã‚’æ±‚ã‚ãªã•ã„', answer:'é¢ç©: 25Ï€â‰’78.5cmÂ²  å††å‘¨: 10Ï€â‰’31.4cm', correctRate:82, tags:['5å¹´','å›³å½¢'] },
    { subject:'ç®—æ•°', topic:'å‰²åˆã¨æ¯” - æç›Šç®—', source:'äºˆç¿’ã‚·ãƒªãƒ¼ã‚º 5å¹´ä¸‹ ç¬¬13å›', frequency:'high', difficulty:'standard', content:'åŸä¾¡800å††ã®å“ã«3å‰²ã®åˆ©ç›Šã‚’è¦‹è¾¼ã‚“ã§å®šä¾¡ã‚’ã¤ã‘ãŸã€‚å®šä¾¡ã¯ï¼Ÿ', answer:'800Ã—1.3ï¼1040å††', correctRate:65, tags:['5å¹´','å‰²åˆ'] },
    // å›½èª5å¹´
    { subject:'å›½èª', topic:'èª­è§£ - èª¬æ˜æ–‡ãƒ»è«–èª¬æ–‡', source:'äºˆç¿’ã‚·ãƒªãƒ¼ã‚º 5å¹´ä¸Š ç¬¬8å›', frequency:'high', difficulty:'standard', content:'ç­†è€…ã®ä¸»å¼µã‚’è¦‹ã¤ã‘ã‚‹ã‚³ãƒ„', answer:'ã€Œã€œã¹ãã ã€ã€Œã€œã¨è€ƒãˆã‚‹ã€ã€Œã€œã§ã¯ãªã„ã‹ã€ãªã©æ„è¦‹ã‚’è¡¨ã™è¡¨ç¾ã«æ³¨ç›®', correctRate:50, tags:['5å¹´','èª­è§£'] },
    { subject:'å›½èª', topic:'èªå½™ - å››å­—ç†Ÿèª', source:'å››ç§‘ã®ã¾ã¨ã‚ p.22', frequency:'high', difficulty:'standard', content:'ã€Œä¸€çŸ³äºŒé³¥ã€ã€Œè‡¨æ©Ÿå¿œå¤‰ã€ã€Œè‡ªç”»è‡ªè³›ã€ã®æ„å‘³', answer:'ä¸€ã¤ã®è¡Œå‹•ã§äºŒã¤ã®åˆ©ç›Š/ãã®å ´ã«å¿œã˜ã¦é©åˆ‡ã«å¯¾å¿œ/è‡ªåˆ†ã§è‡ªåˆ†ã‚’ã»ã‚ã‚‹', correctRate:60, tags:['5å¹´','èªå½™'] },
    { subject:'å›½èª', topic:'æ¼¢å­—ãƒ»æ–‡æ³• - æ•¬èª', source:'äºˆç¿’ã‚·ãƒªãƒ¼ã‚º 5å¹´ä¸‹ ç¬¬5å›', frequency:'high', difficulty:'standard', content:'ã€Œé£Ÿã¹ã‚‹ã€ã®å°Šæ•¬èªãƒ»è¬™è­²èªãƒ»ä¸å¯§èª', answer:'å¬ã—ä¸ŠãŒã‚‹ãƒ»ã„ãŸã ããƒ»é£Ÿã¹ã¾ã™', correctRate:55, tags:['5å¹´','æ–‡æ³•'] },
    { subject:'å›½èª', topic:'èª­è§£ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ - è¨˜è¿°ã®æ›¸ãæ–¹', source:'äºˆç¿’ã‚·ãƒªãƒ¼ã‚º 5å¹´ä¸‹ ç¬¬10å›', frequency:'high', difficulty:'hard', content:'ç†ç”±ã‚’èã‹ã‚ŒãŸæ™‚ã®è¨˜è¿°ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯', answer:'ã€Œã€œãªã®ã§ï¼ˆåŸå› ï¼‰ã€ã€œã‹ã‚‰ï¼ˆæ ¹æ‹ ï¼‰ã€ã§ç­”ãˆã‚‹ã€‚ä¸»èªã‚’æ˜ç¢ºã«', correctRate:35, tags:['5å¹´','èª­è§£','é »å‡º'] },
    // ç†ç§‘5å¹´
    { subject:'ç†ç§‘', topic:'åœ°å­¦ - æœˆ', source:'äºˆç¿’ã‚·ãƒªãƒ¼ã‚º 5å¹´ä¸Š ç¬¬8å›', frequency:'high', difficulty:'basic', content:'ä¸Šå¼¦ã®æœˆãŒå—ä¸­ã™ã‚‹æ™‚åˆ»ã¯ï¼Ÿ', answer:'åˆå¾Œ6æ™‚ã”ã‚ï¼ˆ18æ™‚ï¼‰', correctRate:68, tags:['5å¹´','åœ°å­¦'] },
    { subject:'ç†ç§‘', topic:'åŒ–å­¦ - æ°´æº¶æ¶²', source:'äºˆç¿’ã‚·ãƒªãƒ¼ã‚º 5å¹´ä¸‹ ç¬¬3å›', frequency:'high', difficulty:'standard', content:'ãƒªãƒˆãƒã‚¹ç´™ãƒ»BTBæ¶²ã®è‰²ã®å¤‰åŒ–', answer:'é…¸æ€§: é’â†’èµ¤, BTBé»„ / ã‚¢ãƒ«ã‚«ãƒªæ€§: èµ¤â†’é’, BTBé’ / ä¸­æ€§: å¤‰åŒ–ãªã—, BTBç·‘', correctRate:52, tags:['5å¹´','åŒ–å­¦','é »å‡º'] },
    { subject:'ç†ç§‘', topic:'ç‰©ç† - é›»æµãƒ»é›»ç£çŸ³', source:'äºˆç¿’ã‚·ãƒªãƒ¼ã‚º 5å¹´ä¸Š ç¬¬12å›', frequency:'high', difficulty:'standard', content:'é›»ç£çŸ³ã‚’å¼·ãã™ã‚‹æ–¹æ³•ï¼ˆ2ã¤ï¼‰', answer:'â‘ ã‚³ã‚¤ãƒ«ã®å·»ãæ•°ã‚’å¢—ã‚„ã™ â‘¡é›»æµã‚’å¤§ããã™ã‚‹', correctRate:70, tags:['5å¹´','ç‰©ç†'] },
    { subject:'ç†ç§‘', topic:'åœ°å­¦ - æ˜Ÿåº§ãƒ»æƒ‘æ˜Ÿ', source:'äºˆç¿’ã‚·ãƒªãƒ¼ã‚º 5å¹´ä¸Š ç¬¬6å›', frequency:'medium', difficulty:'standard', content:'å¤ã®å¤§ä¸‰è§’ã‚’æ§‹æˆã™ã‚‹3ã¤ã®æ˜Ÿ', answer:'ãƒ™ã‚¬ï¼ˆã“ã¨åº§ï¼‰ãƒ»ã‚¢ãƒ«ã‚¿ã‚¤ãƒ«ï¼ˆã‚ã—åº§ï¼‰ãƒ»ãƒ‡ãƒãƒ–ï¼ˆã¯ãã¡ã‚‡ã†åº§ï¼‰', correctRate:62, tags:['5å¹´','åœ°å­¦'] },
    { subject:'ç†ç§‘', topic:'ç”Ÿç‰© - äººä½“', source:'äºˆç¿’ã‚·ãƒªãƒ¼ã‚º 5å¹´ä¸‹ ç¬¬8å›', frequency:'high', difficulty:'standard', content:'é£Ÿã¹ç‰©ã®æ¶ˆåŒ–ã®æµã‚Œï¼ˆå£â†’èƒƒâ†’â€¦ï¼‰', answer:'å£ï¼ˆã æ¶²ï¼‰â†’èƒƒï¼ˆèƒƒæ¶²ï¼‰â†’åäºŒæŒ‡è…¸ï¼ˆã™ã„æ¶²ãƒ»èƒ†æ±ï¼‰â†’å°è…¸ã§å¸åâ†’å¤§è…¸', correctRate:45, tags:['5å¹´','ç”Ÿç‰©','é »å‡º'] },
    // ç¤¾ä¼š5å¹´
    { subject:'ç¤¾ä¼š', topic:'æ­´å²ï¼ˆå¤ä»£ã€œä¸­ä¸–ï¼‰ - å¤å¢³ã€œé£›é³¥', source:'äºˆç¿’ã‚·ãƒªãƒ¼ã‚º 5å¹´ä¸Š ç¬¬3å›', frequency:'high', difficulty:'basic', content:'è–å¾³å¤ªå­ãŒè¡Œã£ãŸæ”¿æ²»æ”¹é©ï¼ˆ3ã¤ï¼‰', answer:'å† ä½åäºŒéšãƒ»åä¸ƒæ¡ã®æ†²æ³•ãƒ»é£éš‹ä½¿ã®æ´¾é£', correctRate:65, tags:['5å¹´','æ­´å²'] },
    { subject:'ç¤¾ä¼š', topic:'æ­´å²ï¼ˆå¤ä»£ã€œä¸­ä¸–ï¼‰ - éŒå€‰ãƒ»å®¤ç”º', source:'äºˆç¿’ã‚·ãƒªãƒ¼ã‚º 5å¹´ä¸‹ ç¬¬4å›', frequency:'high', difficulty:'standard', content:'éŒå€‰å¹•åºœã¨å®¤ç”ºå¹•åºœã‚’é–‹ã„ãŸäººç‰©ã¨å ´æ‰€', answer:'éŒå€‰: æºé ¼æœ/éŒå€‰  å®¤ç”º: è¶³åˆ©å°Šæ°/äº¬éƒ½', correctRate:72, tags:['5å¹´','æ­´å²'] },
    { subject:'ç¤¾ä¼š', topic:'åœ°ç† - è¾²æ¥­', source:'äºˆç¿’ã‚·ãƒªãƒ¼ã‚º 5å¹´ä¸Š ç¬¬7å›', frequency:'high', difficulty:'standard', content:'ç±³ã®ç”Ÿç”£é‡ãƒ™ã‚¹ãƒˆ3ã®éƒ½é“åºœçœŒ', answer:'æ–°æ½ŸçœŒãƒ»åŒ—æµ·é“ãƒ»ç§‹ç”°çœŒ', correctRate:58, tags:['5å¹´','åœ°ç†'] },
    { subject:'ç¤¾ä¼š', topic:'åœ°ç† - å·¥æ¥­', source:'äºˆç¿’ã‚·ãƒªãƒ¼ã‚º 5å¹´ä¸Š ç¬¬12å›', frequency:'medium', difficulty:'standard', content:'å¤ªå¹³æ´‹ãƒ™ãƒ«ãƒˆã¨ã¯ä½•ã‹', answer:'æ±äº¬ã€œåŒ—ä¹å·ã®å¤ªå¹³æ´‹å´ã«å¸¯çŠ¶ã«åºƒãŒã‚‹å·¥æ¥­åœ°å¸¯ãƒ»å·¥æ¥­åœ°åŸŸã®é€£ãªã‚Š', correctRate:55, tags:['5å¹´','åœ°ç†'] },

    // ============ 6å¹´ç”Ÿ ============
    // ç®—æ•°6å¹´
    { subject:'ç®—æ•°', topic:'é€Ÿã• - æµæ°´ç®—', source:'äºˆç¿’ã‚·ãƒªãƒ¼ã‚º 6å¹´ä¸Š ç¬¬5å›', frequency:'high', difficulty:'hard', content:'é™æ°´æ™‚ã®é€Ÿã•ãŒæ™‚é€Ÿ12kmã€‚å·ã®æµã‚ŒãŒæ™‚é€Ÿ3kmã€‚ä¸Šã‚Šã§24kmé€²ã‚€ã®ã«ã‹ã‹ã‚‹æ™‚é–“', answer:'24Ã·(12-3)ï¼24/9â‰’2æ™‚é–“40åˆ†', correctRate:38, tags:['6å¹´','é€Ÿã•','é »å‡º'] },
    { subject:'ç®—æ•°', topic:'ç«‹ä½“å›³å½¢ - ä½“ç©ãƒ»è¡¨é¢ç©', source:'äºˆç¿’ã‚·ãƒªãƒ¼ã‚º 6å¹´ä¸Š ç¬¬8å›', frequency:'high', difficulty:'standard', content:'åº•é¢ã®åŠå¾„3cmã€é«˜ã•10cmã®å††æŸ±ã®ä½“ç©ã¨è¡¨é¢ç©', answer:'ä½“ç©: 90Ï€â‰’282.6cmÂ³  è¡¨é¢ç©: 78Ï€â‰’244.9cmÂ²', correctRate:52, tags:['6å¹´','å›³å½¢'] },
    { subject:'ç®—æ•°', topic:'ç«‹ä½“å›³å½¢ - æ°´é‡å¤‰åŒ–', source:'äºˆç¿’ã‚·ãƒªãƒ¼ã‚º 6å¹´ä¸Š ç¬¬10å›', frequency:'high', difficulty:'hard', content:'åº•é¢ç©100cmÂ²ã®æ°´ãã†ã«é«˜ã•20cmã¾ã§æ°´ãŒå…¥ã£ã¦ã„ã‚‹ã€‚åº•é¢ç©25cmÂ²ã®æ£’ã‚’æ²ˆã‚ã‚‹ã¨æ°´é¢ã¯ä½•cmä¸ŠãŒã‚‹ã‹', answer:'æ£’ã®ä½“ç©åˆ†ã ã‘ä¸ŠãŒã‚‹ã€‚åº•é¢ç©(100-25)ã«åˆ†æ•£ â†’ ä¸ŠãŒã‚‹é«˜ã•ã¯å•é¡Œã«ã‚ˆã‚‹', correctRate:30, tags:['6å¹´','å›³å½¢','é »å‡º'] },
    { subject:'ç®—æ•°', topic:'é€Ÿã• - æ™‚è¨ˆç®—', source:'å››ç§‘ã®ã¾ã¨ã‚ p.67', frequency:'medium', difficulty:'hard', content:'3æ™‚ã‹ã‚‰3æ™‚ã¨4æ™‚ã®é–“ã§é•·é‡ã¨çŸ­é‡ãŒé‡ãªã‚‹ã®ã¯3æ™‚ä½•åˆ†ã‹', answer:'3æ™‚16åˆ†ã¨4/11åˆ†ï¼ˆâ‰’3æ™‚16.4åˆ†ï¼‰', correctRate:25, tags:['6å¹´','é€Ÿã•'] },
    { subject:'ç®—æ•°', topic:'ç‰¹æ®Šç®— - ä»•äº‹ç®—', source:'äºˆç¿’ã‚·ãƒªãƒ¼ã‚º 6å¹´ä¸Š ç¬¬3å›', frequency:'high', difficulty:'standard', content:'Aã¯12æ—¥ã€Bã¯18æ—¥ã§çµ‚ã‚ã‚‹ä»•äº‹ã€‚2äººã§ä¸€ç·’ã«ã‚„ã‚‹ã¨ä½•æ—¥ã‹', answer:'1/12+1/18ï¼5/36  36/5ï¼7.2æ—¥', correctRate:45, tags:['6å¹´','ç‰¹æ®Šç®—'] },
    { subject:'ç®—æ•°', topic:'ç‰¹æ®Šç®— - ãƒ‹ãƒ¥ãƒ¼ãƒˆãƒ³ç®—', source:'äºˆç¿’ã‚·ãƒªãƒ¼ã‚º 6å¹´ä¸‹ ç¬¬2å›', frequency:'medium', difficulty:'hard', content:'ç‰§å ´ã«æ¯æ—¥ä¸€å®šé‡ã®è‰ãŒç”Ÿãˆã‚‹ã€‚ç‰›5é ­ã§10æ—¥ã€ç‰›8é ­ã§5æ—¥ã§é£Ÿã¹å°½ãã™ã€‚ç‰›10é ­ã§ã¯ä½•æ—¥ã‹', answer:'4æ—¥', correctRate:20, tags:['6å¹´','ç‰¹æ®Šç®—'] },
    { subject:'ç®—æ•°', topic:'æ•°ã®æ€§è³ª - è¦å‰‡æ€§', source:'äºˆç¿’ã‚·ãƒªãƒ¼ã‚º 6å¹´ä¸Š ç¬¬12å›', frequency:'high', difficulty:'standard', content:'1,1,2,3,5,8,13,â€¦ 10ç•ªç›®ã®æ•°ã¯ï¼Ÿ', answer:'55ï¼ˆãƒ•ã‚£ãƒœãƒŠãƒƒãƒæ•°åˆ—: å‰ã®2ã¤ã®å’Œï¼‰', correctRate:50, tags:['6å¹´','æ•°ã®æ€§è³ª'] },
    { subject:'ç®—æ•°', topic:'ã‚°ãƒ©ãƒ• - ç‚¹ã®ç§»å‹•', source:'äºˆç¿’ã‚·ãƒªãƒ¼ã‚º 6å¹´ä¸Š ç¬¬15å›', frequency:'high', difficulty:'hard', content:'1è¾º10cmã®æ­£æ–¹å½¢ABCDã§ç‚¹PãŒAã‹ã‚‰æ¯ç§’2cmã§Bâ†’Câ†’Dã¨ç§»å‹•ã€‚ä¸‰è§’å½¢APDã®é¢ç©ãŒ25cmÂ²ã«ãªã‚‹ã®ã¯ä½•ç§’å¾Œã‹', answer:'5ç§’å¾Œï¼ˆPãŒBCä¸Šï¼‰ã¨12.5ç§’å¾Œï¼ˆPãŒCDä¸Šï¼‰', correctRate:32, tags:['6å¹´','å›³å½¢','é »å‡º'] },
    // å›½èª6å¹´
    { subject:'å›½èª', topic:'èª­è§£ - ç‰©èªæ–‡', source:'äºˆç¿’ã‚·ãƒªãƒ¼ã‚º 6å¹´ä¸Š ç¬¬4å›', frequency:'high', difficulty:'standard', content:'ç‰©èªæ–‡ã®è¨˜è¿°ã§ã€Œæ°—æŒã¡ã®å¤‰åŒ–ã€ã‚’å•ã‚ã‚ŒãŸæ™‚ã®è§£ãæ–¹', answer:'â‘ ãã£ã‹ã‘ã¨ãªã‚‹å‡ºæ¥äº‹ã‚’ç‰¹å®š â‘¡Beforeâ†’Afterã®æ°—æŒã¡ã‚’å¯¾æ¯”ã§æ›¸ã', correctRate:40, tags:['6å¹´','èª­è§£','é »å‡º'] },
    { subject:'å›½èª', topic:'èª­è§£ - èª¬æ˜æ–‡ãƒ»è«–èª¬æ–‡', source:'äºˆç¿’ã‚·ãƒªãƒ¼ã‚º 6å¹´ä¸‹ ç¬¬2å›', frequency:'high', difficulty:'hard', content:'ã€Œç­†è€…ã®æ„è¦‹ã€ã¨ã€Œäº‹å®Ÿãƒ»å…·ä½“ä¾‹ã€ã‚’åŒºåˆ¥ã™ã‚‹æ–¹æ³•', answer:'äº‹å®Ÿ: æ•°å­—ãƒ»å›ºæœ‰åè©ãƒ»ã€Œã€œã§ã‚ã‚‹ã€ æ„è¦‹: ã€Œã€œã¹ãã ã€ã€Œã€œã¨è€ƒãˆã‚‹ã€ã€Œã€œã§ã¯ãªã„ã‹ã€', correctRate:45, tags:['6å¹´','èª­è§£'] },
    { subject:'å›½èª', topic:'èªå½™ - åŒéŸ³ç•°ç¾©èª', source:'å››ç§‘ã®ã¾ã¨ã‚ p.28', frequency:'high', difficulty:'standard', content:'ã€Œãã‹ã‚“ã€ã®åŒéŸ³ç•°ç¾©èªã‚’3ã¤', answer:'æœŸé–“ãƒ»æ©Ÿé–¢ãƒ»æ°—ç®¡ãƒ»å¸°é‚„ãƒ»å™¨å®˜', correctRate:50, tags:['6å¹´','èªå½™'] },
    { subject:'å›½èª', topic:'èª­è§£ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ - æŒ‡ç¤ºèªãƒ»æ¥ç¶šèª', source:'äºˆç¿’ã‚·ãƒªãƒ¼ã‚º 6å¹´ä¸Š ç¬¬6å›', frequency:'high', difficulty:'basic', content:'ã€Œãã‚Œã€ã€Œã“ã®ã€ãªã©ã®æŒ‡ç¤ºèªãŒæŒ‡ã™å†…å®¹ã®è¦‹ã¤ã‘æ–¹', answer:'ç›´å‰ã®æ–‡ã€ã¾ãŸã¯ç›´å‰ã®æ®µè½ã®å†…å®¹ã‚’ç¢ºèªã€‚ã€Œã“ã‚Œã€ã¯è¿‘ãã€ã€Œã‚ã‚Œã€ã¯é ã', correctRate:65, tags:['6å¹´','èª­è§£'] },
    { subject:'å›½èª', topic:'å¤å…¸ - å¤å…¸ã®åŸºç¤', source:'äºˆç¿’ã‚·ãƒªãƒ¼ã‚º 6å¹´ä¸‹ ç¬¬8å›', frequency:'medium', difficulty:'standard', content:'ã€Œã„ã¨ã‚’ã‹ã—ã€ã€Œã‚ã¯ã‚Œãªã‚Šã€ã®æ„å‘³', answer:'ã„ã¨ã‚’ã‹ã—ï¼ã¨ã¦ã‚‚è¶£ãŒã‚ã‚‹  ã‚ã¯ã‚Œãªã‚Šï¼ã—ã¿ã˜ã¿ã¨æ„Ÿã˜ã‚‹', correctRate:55, tags:['6å¹´','å¤å…¸'] },
    // ç†ç§‘6å¹´
    { subject:'ç†ç§‘', topic:'åŒ–å­¦ - æ°—ä½“', source:'äºˆç¿’ã‚·ãƒªãƒ¼ã‚º 6å¹´ä¸Š ç¬¬2å›', frequency:'high', difficulty:'standard', content:'é…¸ç´ ãƒ»äºŒé…¸åŒ–ç‚­ç´ ãƒ»æ°´ç´ ã®ç™ºç”Ÿæ–¹æ³•ã¨é›†ã‚æ–¹', answer:'é…¸ç´ : éé…¸åŒ–æ°´ç´ +äºŒé…¸åŒ–ãƒãƒ³ã‚¬ãƒ³/æ°´ä¸Šç½®æ›  CO2: çŸ³ç°çŸ³+å¡©é…¸/ä¸‹æ–¹ç½®æ›  æ°´ç´ : äºœé‰›+å¡©é…¸/æ°´ä¸Šç½®æ›', correctRate:48, tags:['6å¹´','åŒ–å­¦','é »å‡º'] },
    { subject:'ç†ç§‘', topic:'ç‰©ç† - æµ®åŠ›', source:'äºˆç¿’ã‚·ãƒªãƒ¼ã‚º 6å¹´ä¸Š ç¬¬6å›', frequency:'high', difficulty:'hard', content:'æ°´ä¸­ã®ç‰©ä½“ã«ã‹ã‹ã‚‹æµ®åŠ›ã¯ä½•ã§æ±ºã¾ã‚‹ã‹', answer:'ç‰©ä½“ãŒæŠ¼ã—ã®ã‘ãŸæ°´ã®é‡ã•ï¼ˆä½“ç©Ã—æ°´ã®å¯†åº¦ï¼‰= ã‚¢ãƒ«ã‚­ãƒ¡ãƒ‡ã‚¹ã®åŸç†', correctRate:35, tags:['6å¹´','ç‰©ç†'] },
    { subject:'ç†ç§‘', topic:'ç‰©ç† - æŒ¯ã‚Šå­', source:'äºˆç¿’ã‚·ãƒªãƒ¼ã‚º 6å¹´ä¸Š ç¬¬4å›', frequency:'high', difficulty:'standard', content:'æŒ¯ã‚Šå­ã®å‘¨æœŸã‚’å¤‰ãˆã‚‹è¦ç´ ã¯ï¼Ÿ ãŠã‚‚ã‚Šã®é‡ã•ãƒ»æŒ¯ã‚Œå¹…ãƒ»ç³¸ã®é•·ã•', answer:'ç³¸ã®é•·ã•ã ã‘ï¼ˆé•·ã„ã»ã©é…ã„ï¼‰ã€‚é‡ã•ã¨æŒ¯ã‚Œå¹…ã¯é–¢ä¿‚ãªã—', correctRate:62, tags:['6å¹´','ç‰©ç†'] },
    { subject:'ç†ç§‘', topic:'åœ°å­¦ - åœ°å±¤ãƒ»ç«å±±ãƒ»åœ°éœ‡', source:'äºˆç¿’ã‚·ãƒªãƒ¼ã‚º 6å¹´ä¸‹ ç¬¬3å›', frequency:'high', difficulty:'standard', content:'ç«æˆå²©ã®åˆ†é¡ï¼ˆæ·±æˆå²©ã¨ç«å±±å²©ã®é•ã„ï¼‰', answer:'æ·±æˆå²©: ã‚†ã£ãã‚Šå†·ãˆã‚‹â†’å¤§ããªçµæ™¶ï¼ˆèŠ±å´—å²©ï¼‰ ç«å±±å²©: æ€¥ã«å†·ãˆã‚‹â†’ç´°ã‹ã„çµæ™¶ï¼ˆå®‰å±±å²©ãƒ»ç„æ­¦å²©ï¼‰', correctRate:45, tags:['6å¹´','åœ°å­¦'] },
    { subject:'ç†ç§‘', topic:'ç”Ÿç‰© - æ¤ç‰©', source:'äºˆç¿’ã‚·ãƒªãƒ¼ã‚º 6å¹´ä¸Š ç¬¬9å›', frequency:'medium', difficulty:'standard', content:'å…‰åˆæˆã«å¿…è¦ãªã‚‚ã®3ã¤ã¨ä½œã‚‰ã‚Œã‚‹ã‚‚ã®', answer:'å¿…è¦: å…‰ãƒ»æ°´ãƒ»äºŒé…¸åŒ–ç‚­ç´   ä½œã‚‹: ãƒ‡ãƒ³ãƒ—ãƒ³ï¼ˆæ „é¤Šï¼‰ã¨é…¸ç´ ', correctRate:70, tags:['6å¹´','ç”Ÿç‰©'] },
    { subject:'ç†ç§‘', topic:'åŒ–å­¦ - ç‡ƒç„¼', source:'äºˆç¿’ã‚·ãƒªãƒ¼ã‚º 6å¹´ä¸Š ç¬¬1å›', frequency:'high', difficulty:'basic', content:'ã‚‚ã®ãŒç‡ƒãˆã‚‹ãŸã‚ã®3æ¡ä»¶', answer:'â‘ ç‡ƒãˆã‚‹ã‚‚ã® â‘¡é…¸ç´  â‘¢ç™ºç«ç‚¹ä»¥ä¸Šã®æ¸©åº¦', correctRate:78, tags:['6å¹´','åŒ–å­¦'] },
    // ç¤¾ä¼š6å¹´
    { subject:'ç¤¾ä¼š', topic:'æ­´å²ï¼ˆè¿‘ä¸–ã€œç¾ä»£ï¼‰ - æ˜æ²»ç¶­æ–°', source:'äºˆç¿’ã‚·ãƒªãƒ¼ã‚º 6å¹´ä¸Š ç¬¬8å›', frequency:'high', difficulty:'standard', content:'æ˜æ²»ç¶­æ–°ã®ä¸‰å¤§æ”¹é©', answer:'ç‰ˆç±å¥‰é‚„ãƒ»å»ƒè—©ç½®çœŒãƒ»åœ°ç§Ÿæ”¹æ­£ï¼ˆï¼‹å¾´å…µä»¤ãƒ»å­¦åˆ¶ï¼‰', correctRate:55, tags:['6å¹´','æ­´å²','é »å‡º'] },
    { subject:'ç¤¾ä¼š', topic:'æ­´å²ï¼ˆè¿‘ä¸–ã€œç¾ä»£ï¼‰ - å®‰åœŸæ¡ƒå±±ãƒ»æ±Ÿæˆ¸', source:'äºˆç¿’ã‚·ãƒªãƒ¼ã‚º 6å¹´ä¸Š ç¬¬5å›', frequency:'high', difficulty:'standard', content:'ç¹”ç”°ä¿¡é•·ãƒ»è±Šè‡£ç§€å‰ãƒ»å¾³å·å®¶åº· ãã‚Œãã‚Œã®çµ±ä¸€äº‹æ¥­', answer:'ä¿¡é•·: æ¥½å¸‚æ¥½åº§ãƒ»é•·ç¯ ã®æˆ¦ã„ ç§€å‰: å¤ªé–¤æ¤œåœ°ãƒ»åˆ€ç‹© å®¶åº·: é–¢ãƒ¶åŸâ†’æ±Ÿæˆ¸å¹•åºœ', correctRate:60, tags:['6å¹´','æ­´å²'] },
    { subject:'ç¤¾ä¼š', topic:'å…¬æ°‘ - æ†²æ³•ãƒ»äººæ¨©', source:'äºˆç¿’ã‚·ãƒªãƒ¼ã‚º 6å¹´ä¸‹ ç¬¬1å›', frequency:'high', difficulty:'standard', content:'æ—¥æœ¬å›½æ†²æ³•ã®ä¸‰å¤§åŸå‰‡', answer:'å›½æ°‘ä¸»æ¨©ãƒ»åŸºæœ¬çš„äººæ¨©ã®å°Šé‡ãƒ»å¹³å’Œä¸»ç¾©', correctRate:80, tags:['6å¹´','å…¬æ°‘'] },
    { subject:'ç¤¾ä¼š', topic:'å…¬æ°‘ - å›½ä¼šãƒ»å†…é–£ãƒ»è£åˆ¤æ‰€', source:'äºˆç¿’ã‚·ãƒªãƒ¼ã‚º 6å¹´ä¸‹ ç¬¬3å›', frequency:'high', difficulty:'hard', content:'ä¸‰æ¨©åˆ†ç«‹ã®ä»•çµ„ã¿ï¼ˆãã‚Œãã‚Œã®æŠ‘åˆ¶é–¢ä¿‚ï¼‰', answer:'å›½ä¼šâ†’å†…é–£ï¼ˆå†…é–£ä¸ä¿¡ä»»ï¼‰ å†…é–£â†’å›½ä¼šï¼ˆè¡†è­°é™¢è§£æ•£ï¼‰ è£åˆ¤æ‰€â†’å›½ä¼šï¼ˆé•æ†²ç«‹æ³•å¯©æŸ»ï¼‰ ç­‰', correctRate:38, tags:['6å¹´','å…¬æ°‘','é »å‡º'] },
    { subject:'ç¤¾ä¼š', topic:'æ­´å²ï¼ˆè¿‘ä¸–ã€œç¾ä»£ï¼‰ - æ˜­å’Œã€œæˆ¦å¾Œ', source:'äºˆç¿’ã‚·ãƒªãƒ¼ã‚º 6å¹´ä¸Š ç¬¬12å›', frequency:'high', difficulty:'standard', content:'æˆ¦å¾Œã®æ—¥æœ¬ã®å‡ºæ¥äº‹ã‚’å¹´ä»£é †ã«', answer:'æ—¥æœ¬å›½æ†²æ³•(1946)â†’ã‚µãƒ³ãƒ•ãƒ©ãƒ³ã‚·ã‚¹ã‚³è¬›å’Œ(1951)â†’é«˜åº¦çµŒæ¸ˆæˆé•·(1960s)â†’æ²–ç¸„è¿”é‚„(1972)', correctRate:42, tags:['6å¹´','æ­´å²'] },
    { subject:'ç¤¾ä¼š', topic:'å›½éš› - å›½éš›é€£åˆ', source:'äºˆç¿’ã‚·ãƒªãƒ¼ã‚º 6å¹´ä¸‹ ç¬¬6å›', frequency:'medium', difficulty:'standard', content:'å›½é€£ã®ä¸»ãªæ©Ÿé–¢ã¨å®‰å…¨ä¿éšœç†äº‹ä¼šã®å¸¸ä»»ç†äº‹å›½', answer:'ç·ä¼šãƒ»å®‰ä¿ç†ãƒ»çµŒç¤¾ç†ãƒ»äº‹å‹™å±€ã€‚å¸¸ä»»ç†äº‹å›½: ç±³è‹±ä»éœ²ä¸­ï¼ˆæ‹’å¦æ¨©ã‚ã‚Šï¼‰', correctRate:50, tags:['6å¹´','å…¬æ°‘'] },
    // ===== âœï¸ æ¼¢å­—ãƒ»æš—è¨˜å•é¡Œ =====
    { subject:'å›½èª', topic:'æ¼¢å­—ã®æ›¸ãå–ã‚Š', source:'æ¼¢å­—ã®è¦', frequency:'high', difficulty:'basic', content:'æ¬¡ã®æ¼¢å­—ã‚’æ›¸ããªã•ã„ï¼šãã‚‡ã†ãã†ï¼ˆèµ°ã‚‹æ–¹ï¼‰', answer:'ç«¶èµ°\nğŸ’¡ã€Œç«¶äº‰ã€ï¼ˆäº‰ã†æ–¹ï¼‰ã¨åŒºåˆ¥ï¼', correctRate:55, tags:['æš—è¨˜','æ¼¢å­—'] },
    { subject:'å›½èª', topic:'æ¼¢å­—ã®æ›¸ãå–ã‚Š', source:'æ¼¢å­—ã®è¦', frequency:'high', difficulty:'basic', content:'æ¬¡ã®æ¼¢å­—ã‚’æ›¸ããªã•ã„ï¼šã—ã‚…ã†ã—ã‚‡ãï¼ˆä»•äº‹ã«å°±ãï¼‰', answer:'å°±è·\nğŸ’¡å°±ï¼ã¤ãã€è·ï¼ã¤ã¨ã‚', correctRate:50, tags:['æš—è¨˜','æ¼¢å­—'] },
    { subject:'å›½èª', topic:'æ¼¢å­—ã®æ›¸ãå–ã‚Š', source:'æ¼¢å­—ã®è¦', frequency:'high', difficulty:'standard', content:'æ¬¡ã®æ¼¢å­—ã‚’æ›¸ããªã•ã„ï¼šã„ã£ã—ã‚‡ã‘ã‚“ã‚ã„', answer:'ä¸€ç”Ÿæ‡¸å‘½\nğŸ’¡ã‚‚ã¨ã¯ã€Œä¸€æ‰€æ‡¸å‘½ã€ï¼ˆé ˜åœ°ã‚’å‘½ãŒã‘ã§å®ˆã‚‹ï¼‰', correctRate:45, tags:['æš—è¨˜','æ¼¢å­—'] },
    { subject:'å›½èª', topic:'æ¼¢å­—ã®æ›¸ãå–ã‚Š', source:'æ¼¢å­—ã®è¦', frequency:'high', difficulty:'standard', content:'æ¬¡ã®æ¼¢å­—ã‚’æ›¸ããªã•ã„ï¼šã—ã‚“ã‘ã‚“ã«ï¼ˆã¨ã‚Šãã‚€ï¼‰', answer:'çœŸå‰£ã«\nğŸ’¡å‰£ï¼ã¤ã‚‹ãã€‚åˆ€ã®å­—ãŒå…¥ã‚‹', correctRate:60, tags:['æš—è¨˜','æ¼¢å­—'] },
    { subject:'å›½èª', topic:'æ¼¢å­—ã®æ›¸ãå–ã‚Š', source:'æ¼¢å­—ã®è¦', frequency:'high', difficulty:'basic', content:'æ¬¡ã®æ¼¢å­—ã‚’æ›¸ããªã•ã„ï¼šã“ã“ã‚ã–ã—', answer:'å¿—\nğŸ’¡å£«ï¼‹å¿ƒã€‚æ­¦å£«ã®å¿ƒ', correctRate:65, tags:['æš—è¨˜','æ¼¢å­—'] },
    { subject:'å›½èª', topic:'æ¼¢å­—ã®æ›¸ãå–ã‚Š', source:'æ¼¢å­—ã®è¦', frequency:'high', difficulty:'standard', content:'æ¬¡ã®æ¼¢å­—ã‚’æ›¸ããªã•ã„ï¼šã‘ã„ã‘ã‚“ï¼ˆã‚’ã¤ã‚€ï¼‰', answer:'çµŒé¨“\nğŸ’¡çµŒï¼ã¸ã‚‹ã€é¨“ï¼ãŸã‚ã™', correctRate:55, tags:['æš—è¨˜','æ¼¢å­—'] },
    { subject:'å›½èª', topic:'æ¼¢å­—ã®æ›¸ãå–ã‚Š', source:'æ¼¢å­—ã®è¦', frequency:'high', difficulty:'hard', content:'æ¬¡ã®æ¼¢å­—ã‚’æ›¸ããªã•ã„ï¼šã¯ã‚“ã›ã„ï¼ˆã™ã‚‹ï¼‰', answer:'åçœ\nğŸ’¡çœï¼ã‹ãˆã‚Šã¿ã‚‹ã€‚ç›®ï¼‹å°‘', correctRate:48, tags:['æš—è¨˜','æ¼¢å­—'] },
    { subject:'å›½èª', topic:'æ¼¢å­—ã®æ›¸ãå–ã‚Š', source:'æ¼¢å­—ã®è¦', frequency:'high', difficulty:'standard', content:'æ¬¡ã®æ¼¢å­—ã‚’æ›¸ããªã•ã„ï¼šã„ã˜ã‚‡ã†ãƒ»ã„ã‹', answer:'ä»¥ä¸Šãƒ»ä»¥ä¸‹\nğŸ’¡ã€Œä»¥ã€ã¯ã€Œã€œã‚ˆã‚Šã€ã®æ„å‘³', correctRate:70, tags:['æš—è¨˜','æ¼¢å­—'] },
    { subject:'å›½èª', topic:'å››å­—ç†Ÿèª', source:'äºˆã‚·ãƒª6ä¸Š', frequency:'high', difficulty:'standard', content:'ã€Œâ–¡â–¡â–¡â–¡ã€ï¼šä¸€ã¤ã®çŸ³ã§äºŒç¾½ã®é³¥ã‚’æ‰“ã¤ï¼ä¸€åº¦ã§äºŒã¤ã®åˆ©ç›Š', answer:'ä¸€çŸ³äºŒé³¥ï¼ˆã„ã£ã›ãã«ã¡ã‚‡ã†ï¼‰\nğŸ’¡è‹±èª: kill two birds with one stone', correctRate:80, tags:['æš—è¨˜','èªå½™'] },
    { subject:'å›½èª', topic:'å››å­—ç†Ÿèª', source:'äºˆã‚·ãƒª6ä¸Š', frequency:'high', difficulty:'standard', content:'ã€Œâ–¡â–¡â–¡â–¡ã€ï¼šä¸€ã¤ã®ã“ã¨ã«å¤¢ä¸­ã«ãªã£ã¦å‘¨ã‚ŠãŒè¦‹ãˆãªã„', answer:'ä¸€å¿ƒä¸ä¹±ï¼ˆã„ã£ã—ã‚“ãµã‚‰ã‚“ï¼‰\nğŸ’¡å¿ƒãŒä¸€ã¤ã§ä¹±ã‚Œãªã„', correctRate:55, tags:['æš—è¨˜','èªå½™'] },
    { subject:'å›½èª', topic:'å››å­—ç†Ÿèª', source:'äºˆã‚·ãƒª6ä¸Š', frequency:'high', difficulty:'hard', content:'ã€Œâ–¡â–¡â–¡â–¡ã€ï¼šè‡ªåˆ†ã§è‡ªåˆ†ã®è¨€å‹•ã‚’ã»ã‚ã‚‹ã“ã¨', answer:'è‡ªç”»è‡ªè³›ï¼ˆã˜ãŒã˜ã•ã‚“ï¼‰\nğŸ’¡è‡ªåˆ†ã®çµµã‚’è‡ªåˆ†ã§ã»ã‚ã‚‹', correctRate:45, tags:['æš—è¨˜','èªå½™'] },
    // ===== ğŸ“… æ­´å²å¹´å·ãƒ»æš—è¨˜ =====
    { subject:'ç¤¾ä¼š', topic:'æ­´å²å¹´å·', source:'å…¥è©¦é »å‡º', frequency:'high', difficulty:'basic', content:'794å¹´ã«ä½•ãŒã‚ã£ãŸï¼Ÿ', answer:'å¹³å®‰äº¬é·éƒ½ï¼ˆæ¡“æ­¦å¤©çš‡ï¼‰\nğŸ’¡ã€Œé³´ãã‚ˆ(794)ã‚¦ã‚°ã‚¤ã‚¹å¹³å®‰äº¬ã€', correctRate:78, tags:['æš—è¨˜','å¹´å·'] },
    { subject:'ç¤¾ä¼š', topic:'æ­´å²å¹´å·', source:'å…¥è©¦é »å‡º', frequency:'high', difficulty:'basic', content:'1192å¹´ã«ä½•ãŒã‚ã£ãŸï¼Ÿ', answer:'éŒå€‰å¹•åºœæˆç«‹ï¼ˆæºé ¼æœãŒå¾å¤·å¤§å°†è»ï¼‰\nğŸ’¡ã€Œã„ã„å›½(1192)ã¤ãã‚ã†éŒå€‰å¹•åºœã€\nâ€»è¿‘å¹´ã¯1185å¹´èª¬ã‚‚', correctRate:85, tags:['æš—è¨˜','å¹´å·'] },
    { subject:'ç¤¾ä¼š', topic:'æ­´å²å¹´å·', source:'å…¥è©¦é »å‡º', frequency:'high', difficulty:'basic', content:'1603å¹´ã«ä½•ãŒã‚ã£ãŸï¼Ÿ', answer:'æ±Ÿæˆ¸å¹•åºœæˆç«‹ï¼ˆå¾³å·å®¶åº·ï¼‰\nğŸ’¡ã€Œãƒ’ãƒ¼ãƒ­ãƒ¼ãŠã£ã•ã‚“(1603)å®¶åº·ã•ã‚“ã€', correctRate:70, tags:['æš—è¨˜','å¹´å·'] },
    { subject:'ç¤¾ä¼š', topic:'æ­´å²å¹´å·', source:'å…¥è©¦é »å‡º', frequency:'high', difficulty:'standard', content:'1868å¹´ã«ä½•ãŒã‚ã£ãŸï¼Ÿ', answer:'æ˜æ²»ç¶­æ–°\nğŸ’¡ã€Œä¸€ã¤ã‚„ã‚ã†ã‚„(1868)æ˜æ²»ç¶­æ–°ã€\nç‹æ”¿å¾©å¤ã®å¤§å·ä»¤â†’äº”ç®‡æ¡ã®å¾¡èª“æ–‡', correctRate:65, tags:['æš—è¨˜','å¹´å·'] },
    { subject:'ç¤¾ä¼š', topic:'æ­´å²å¹´å·', source:'å…¥è©¦é »å‡º', frequency:'high', difficulty:'standard', content:'1945å¹´ã«ä½•ãŒã‚ã£ãŸï¼Ÿ', answer:'å¤ªå¹³æ´‹æˆ¦äº‰çµ‚çµï¼ˆãƒãƒ„ãƒ€ãƒ å®£è¨€å—è«¾ï¼‰\nğŸ’¡8æœˆ6æ—¥åºƒå³¶ã€8æœˆ9æ—¥é•·å´ã€8æœˆ15æ—¥çµ‚æˆ¦', correctRate:80, tags:['æš—è¨˜','å¹´å·'] },
    { subject:'ç¤¾ä¼š', topic:'æ­´å²å¹´å·', source:'å…¥è©¦é »å‡º', frequency:'high', difficulty:'standard', content:'1543å¹´ã«ä½•ãŒã‚ã£ãŸï¼Ÿ', answer:'é‰„ç ²ä¼æ¥ï¼ˆãƒãƒ«ãƒˆã‚¬ãƒ«äººâ†’ç¨®å­å³¶ï¼‰\nğŸ’¡ã€Œä»¥å¾Œäºˆç®—(1543)ã§é‰„ç ²è²·ã„ã€', correctRate:55, tags:['æš—è¨˜','å¹´å·'] },
    { subject:'ç¤¾ä¼š', topic:'æ­´å²å¹´å·', source:'å…¥è©¦é »å‡º', frequency:'high', difficulty:'standard', content:'1549å¹´ã«ä½•ãŒã‚ã£ãŸï¼Ÿ', answer:'ã‚­ãƒªã‚¹ãƒˆæ•™ä¼æ¥ï¼ˆãƒ•ãƒ©ãƒ³ã‚·ã‚¹ã‚³ãƒ»ã‚¶ãƒ“ã‚¨ãƒ«ï¼‰\nğŸ’¡ã€Œä»¥å¾Œã‚ˆã(1549)åºƒã¾ã‚‹ã‚­ãƒªã‚¹ãƒˆæ•™ã€', correctRate:60, tags:['æš—è¨˜','å¹´å·'] },
    { subject:'ç¤¾ä¼š', topic:'æ­´å²å¹´å·', source:'å…¥è©¦é »å‡º', frequency:'high', difficulty:'standard', content:'1853å¹´ã«ä½•ãŒã‚ã£ãŸï¼Ÿ', answer:'ãƒšãƒªãƒ¼æ¥èˆªï¼ˆé»’èˆ¹ï¼‰â†’ç¿Œå¹´æ—¥ç±³å’Œè¦ªæ¡ç´„\nğŸ’¡ã€Œå«Œã§ã”ã–(1853)ã‚“ã™ãƒšãƒªãƒ¼ã•ã‚“ã€', correctRate:70, tags:['æš—è¨˜','å¹´å·'] },
    { subject:'ç¤¾ä¼š', topic:'æ­´å²å¹´å·', source:'å…¥è©¦é »å‡º', frequency:'high', difficulty:'standard', content:'710å¹´ã«ä½•ãŒã‚ã£ãŸï¼Ÿ', answer:'å¹³åŸäº¬é·éƒ½ï¼ˆå¥ˆè‰¯æ™‚ä»£ã®å§‹ã¾ã‚Šï¼‰\nğŸ’¡ã€Œãªã‚“ã¨(710)ç«‹æ´¾ãªå¹³åŸäº¬ã€', correctRate:75, tags:['æš—è¨˜','å¹´å·'] },
    { subject:'ç¤¾ä¼š', topic:'æ­´å²å¹´å·', source:'å…¥è©¦é »å‡º', frequency:'high', difficulty:'hard', content:'1637å¹´ã«ä½•ãŒã‚ã£ãŸï¼Ÿ', answer:'å³¶åŸã®ä¹±ï¼ˆå¤©è‰å››éƒï¼‰\nğŸ’¡ã‚­ãƒªã‚·ã‚¿ãƒ³å¼¾åœ§â†’é–å›½ã®å¼·åŒ–ã¸', correctRate:40, tags:['æš—è¨˜','å¹´å·'] },
    // ===== ğŸ”¬ ç†ç§‘æš—è¨˜ =====
    { subject:'ç†ç§‘', topic:'äººä½“ã®æš—è¨˜', source:'äºˆã‚·ãƒª6ä¸Š', frequency:'high', difficulty:'standard', content:'æ¶ˆåŒ–æ¶²ã¨æ¶ˆåŒ–é…µç´ ã®çµ„ã¿åˆã‚ã›ï¼šã æ¶²â†’ï¼Ÿ èƒƒæ¶²â†’ï¼Ÿ ã™ã„æ¶²â†’ï¼Ÿ', answer:'ã æ¶²â†’ã‚¢ãƒŸãƒ©ãƒ¼ã‚¼ï¼ˆãƒ‡ãƒ³ãƒ—ãƒ³åˆ†è§£ï¼‰\nèƒƒæ¶²â†’ãƒšãƒ—ã‚·ãƒ³ï¼ˆã‚¿ãƒ³ãƒ‘ã‚¯è³ªåˆ†è§£ï¼‰\nã™ã„æ¶²â†’ã™ã¹ã¦åˆ†è§£ï¼ˆä¸‡èƒ½é¸æ‰‹ï¼‰\nğŸ’¡ã€Œã‚ãƒ»ãºãƒ»ã™ã€ã§è¦šãˆã‚‹', correctRate:42, tags:['æš—è¨˜','ç†ç§‘'] },
    { subject:'ç†ç§‘', topic:'æ˜Ÿåº§ã®æš—è¨˜', source:'äºˆã‚·ãƒª5ä¸Š', frequency:'high', difficulty:'basic', content:'å¤ã®å¤§ä¸‰è§’ã‚’æ§‹æˆã™ã‚‹3ã¤ã®æ˜Ÿã¨æ˜Ÿåº§ã¯ï¼Ÿ', answer:'ãƒ™ã‚¬ï¼ˆã“ã¨åº§ï¼‰\nã‚¢ãƒ«ã‚¿ã‚¤ãƒ«ï¼ˆã‚ã—åº§ï¼‰\nãƒ‡ãƒãƒ–ï¼ˆã¯ãã¡ã‚‡ã†åº§ï¼‰\nğŸ’¡ã€Œãƒ™ã‚¢ãƒ‡ã€ã§è¦šãˆã‚‹', correctRate:58, tags:['æš—è¨˜','ç†ç§‘'] },
    { subject:'ç†ç§‘', topic:'å²©çŸ³ã®æš—è¨˜', source:'äºˆã‚·ãƒª6ä¸Š', frequency:'high', difficulty:'hard', content:'ç«æˆå²©ã®åˆ†é¡ï¼šæ·±æˆå²©3ã¤ãƒ»ç«å±±å²©3ã¤', answer:'æ·±æˆå²©: èŠ±ã“ã†å²©ãƒ»é–ƒç·‘å²©ãƒ»ã¯ã‚“ã‚Œã„å²©\nç«å±±å²©: æµç´‹å²©ãƒ»å®‰å±±å²©ãƒ»ç„æ­¦å²©\nğŸ’¡ã€Œã—ã‚“(æ·±)ã‹ã›ã‚“(é–ƒ)ã¯ã‚“(æ–‘) / ã‹(ç«)ã‚Šã‚…ã†(æµ)ã‚ã‚“(å®‰)ã’ã‚“(ç„)ã€', correctRate:30, tags:['æš—è¨˜','ç†ç§‘'] },
    // ===== ğŸ“¸ ç”»åƒå•é¡Œã‚µãƒ³ãƒ—ãƒ« =====
    { subject:'ç®—æ•°', topic:'è§’åº¦ï¼ˆå›³å½¢å•é¡Œï¼‰', source:'äºˆã‚·ãƒª4ä¸Š', frequency:'high', difficulty:'standard', contentImage:'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MDAiIGhlaWdodD0iMjgwIiBzdHlsZT0iYmFja2dyb3VuZDojZmZmO2ZvbnQtZmFtaWx5OnNhbnMtc2VyaWYiPgo8dGV4dCB4PSIyMCIgeT0iMzAiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIj7kuIvjga7lm7Pjga5444Gu6KeS5bqm44KS5rGC44KB44Gq44GV44GE44CCPC90ZXh0Pgo8cG9seWdvbiBwb2ludHM9IjIwMCw2MCA4MCwyMjAgMzIwLDIyMCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjMzMzIiBzdHJva2Utd2lkdGg9IjIiLz4KPHRleHQgeD0iMTg1IiB5PSI1NSIgZm9udC1zaXplPSIxMyIgZmlsbD0iIzMzMyI+QTwvdGV4dD4KPHRleHQgeD0iNTUiIHk9IjI0MCIgZm9udC1zaXplPSIxMyIgZmlsbD0iIzMzMyI+QjwvdGV4dD4KPHRleHQgeD0iMzI1IiB5PSIyNDAiIGZvbnQtc2l6ZT0iMTMiIGZpbGw9IiMzMzMiPkM8L3RleHQ+Cjx0ZXh0IHg9IjE4MiIgeT0iMTAwIiBmb250LXNpemU9IjE2IiBmaWxsPSIjNmM2M2ZmIiBmb250LXdlaWdodD0iYm9sZCI+eMKwPC90ZXh0Pgo8dGV4dCB4PSIxMDAiIHk9IjIxNSIgZm9udC1zaXplPSIxNCIgZmlsbD0iI2U3NGMzYyI+NjXCsDwvdGV4dD4KPHRleHQgeD0iMjcwIiB5PSIyMTUiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiNlNzRjM2MiPjQwwrA8L3RleHQ+CjxwYXRoIGQ9Ik0gMTEwLDIyMCBBIDMwLDMwIDAgMCwxIDk0LDE5OCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjZTc0YzNjIiBzdHJva2Utd2lkdGg9IjEuNSIvPgo8cGF0aCBkPSJNIDI5MCwyMjAgQSAzMCwzMCAwIDAsMCAzMDYsMTk4IiBmaWxsPSJub25lIiBzdHJva2U9IiNlNzRjM2MiIHN0cm9rZS13aWR0aD0iMS41Ii8+Cjwvc3ZnPg==', answer:'ä¸‰è§’å½¢ã®å†…è§’ã®å’Œ=180Â°\nx=180-65-40=75Â°\nğŸ’¡ä¸‰è§’å½¢ã®å†…è§’ã®å’Œã¯180Â°', correctRate:70, tags:['4å¹´','å›³å½¢','ğŸ“¸ç”»åƒ'] },
    { subject:'ç®—æ•°', topic:'é€Ÿã•ï¼ˆå›³ã¤ãï¼‰', source:'äºˆã‚·ãƒª5ä¸Š', frequency:'high', difficulty:'standard', contentImage:'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MDAiIGhlaWdodD0iMjUwIiBzdHlsZT0iYmFja2dyb3VuZDojZmZmO2ZvbnQtZmFtaWx5OnNhbnMtc2VyaWYiPgo8dGV4dCB4PSIyMCIgeT0iMjgiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIj5B5Zyw54K544GL44KJQuWcsOeCueOBvuOBpzEyMDBt6Zui44KM44Gm44GE44G+44GZ44CCPC90ZXh0Pgo8dGV4dCB4PSIyMCIgeT0iNTAiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIj7lpKrpg47jga/liIbpgJ82MG3jgIHoirHlrZDjga/liIbpgJ84MG3jgaflkIzmmYLjgas8L3RleHQ+Cjx0ZXh0IHg9IjIwIiB5PSI3MiIgZm9udC1zaXplPSIxNCIgZm9udC13ZWlnaHQ9ImJvbGQiPkHlnLDngrnjgpLlh7rnmbrjgZfjgb7jgZfjgZ/jgILoirHlrZDjgYzliLDnnYDjgZnjgovjga7jga88L3RleHQ+Cjx0ZXh0IHg9IjIwIiB5PSI5NCIgZm9udC1zaXplPSIxNCIgZm9udC13ZWlnaHQ9ImJvbGQiPuWkqumDjuOCiOOCiuS9leWIhuaXqeOBhOOBp+OBmeOBi+OAgjwvdGV4dD4KPGxpbmUgeDE9IjYwIiB5MT0iMTYwIiB4Mj0iMzQwIiB5Mj0iMTYwIiBzdHJva2U9IiMzMzMiIHN0cm9rZS13aWR0aD0iMiIvPgo8Y2lyY2xlIGN4PSI2MCIgY3k9IjE2MCIgcj0iNiIgZmlsbD0iIzZjNjNmZiIvPgo8Y2lyY2xlIGN4PSIzNDAiIGN5PSIxNjAiIHI9IjYiIGZpbGw9IiNlNzRjM2MiLz4KPHRleHQgeD0iNDUiIHk9IjE5MCIgZm9udC1zaXplPSIxMyIgZmlsbD0iIzZjNjNmZiIgZm9udC13ZWlnaHQ9ImJvbGQiPkE8L3RleHQ+Cjx0ZXh0IHg9IjMzMCIgeT0iMTkwIiBmb250LXNpemU9IjEzIiBmaWxsPSIjZTc0YzNjIiBmb250LXdlaWdodD0iYm9sZCI+QjwvdGV4dD4KPHRleHQgeD0iMTcwIiB5PSIxNTUiIGZvbnQtc2l6ZT0iMTIiIGZpbGw9IiM4ODgiPjEyMDBtPC90ZXh0Pgo8dGV4dCB4PSIxMDAiIHk9IjIyMCIgZm9udC1zaXplPSIxMiIgZmlsbD0iIzZjNjNmZiI+5aSq6YOOIOWIhumAnzYwbSDihpI8L3RleHQ+Cjx0ZXh0IHg9IjEwMCIgeT0iMjQwIiBmb250LXNpemU9IjEyIiBmaWxsPSIjZTc0YzNjIj7oirHlrZAg5YiG6YCfODBtIOKGkjwvdGV4dD4KPGxpbmUgeDE9IjYwIiB5MT0iMTY1IiB4Mj0iMzQwIiB5Mj0iMTY1IiBzdHJva2U9IiM2YzYzZmYiIHN0cm9rZS13aWR0aD0iMSIgc3Ryb2tlLWRhc2hhcnJheT0iNCIvPgo8L3N2Zz4=', answer:'å¤ªéƒ: 1200Ã·60=20åˆ†\nèŠ±å­: 1200Ã·80=15åˆ†\nå·®: 20-15=5åˆ†æ—©ã„\nğŸ’¡æ™‚é–“=è·é›¢Ã·é€Ÿã•', correctRate:58, tags:['5å¹´','é€Ÿã•','ğŸ“¸ç”»åƒ'] },
    { subject:'ç®—æ•°', topic:'å††ã¨æ­£æ–¹å½¢ï¼ˆé¢ç©ï¼‰', source:'äºˆã‚·ãƒª5ä¸Š', frequency:'high', difficulty:'hard', contentImage:'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MDAiIGhlaWdodD0iMzAwIiBzdHlsZT0iYmFja2dyb3VuZDojZmZmO2ZvbnQtZmFtaWx5OnNhbnMtc2VyaWYiPgo8dGV4dCB4PSIyMCIgeT0iMjgiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIj7kuIvjga7lm7Pjga7oibLjgYzjgaTjgYTjgZ/pg6jliIbjga7pnaLnqY3jgpI8L3RleHQ+Cjx0ZXh0IHg9IjIwIiB5PSI1MCIgZm9udC1zaXplPSIxNCIgZm9udC13ZWlnaHQ9ImJvbGQiPuaxguOCgeOBquOBleOBhOOAgu+8iOWGhuWRqOeOh+OBrzMuMTTvvIk8L3RleHQ+CjxyZWN0IHg9IjEwMCIgeT0iODAiIHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiBmaWxsPSJub25lIiBzdHJva2U9IiMzMzMiIHN0cm9rZS13aWR0aD0iMiIvPgo8Y2lyY2xlIGN4PSIyMDAiIGN5PSIxODAiIHI9IjEwMCIgZmlsbD0iIzZjNjNmZiIgZmlsbC1vcGFjaXR5PSIwLjE1IiBzdHJva2U9IiM2YzYzZmYiIHN0cm9rZS13aWR0aD0iMiIvPgo8dGV4dCB4PSI5MCIgeT0iNzUiIGZvbnQtc2l6ZT0iMTIiIGZpbGw9IiMzMzMiPkE8L3RleHQ+Cjx0ZXh0IHg9IjMwMiIgeT0iNzUiIGZvbnQtc2l6ZT0iMTIiIGZpbGw9IiMzMzMiPkI8L3RleHQ+Cjx0ZXh0IHg9IjMwMiIgeT0iMjkwIiBmb250LXNpemU9IjEyIiBmaWxsPSIjMzMzIj5DPC90ZXh0Pgo8dGV4dCB4PSI5MCIgeT0iMjkwIiBmb250LXNpemU9IjEyIiBmaWxsPSIjMzMzIj5EPC90ZXh0Pgo8bGluZSB4MT0iMjAwIiB5MT0iMjgwIiB4Mj0iMjAwIiB5Mj0iMjcwIiBzdHJva2U9IiMzMzMiIHN0cm9rZS13aWR0aD0iMSIvPgo8bGluZSB4MT0iMTk1IiB5MT0iMjc1IiB4Mj0iMjA1IiB5Mj0iMjc1IiBzdHJva2U9IiMzMzMiIHN0cm9rZS13aWR0aD0iMSIvPgo8dGV4dCB4PSIxNDAiIHk9IjI5NSIgZm9udC1zaXplPSIxMyIgZmlsbD0iI2U3NGMzYyIgZm9udC13ZWlnaHQ9ImJvbGQiPjIwY208L3RleHQ+CjxsaW5lIHgxPSIzMDUiIHkxPSI4MCIgeDI9IjMxNSIgeTI9IjgwIiBzdHJva2U9IiMzMzMiIHN0cm9rZS13aWR0aD0iMSIvPgo8bGluZSB4MT0iMzA1IiB5MT0iMjgwIiB4Mj0iMzE1IiB5Mj0iMjgwIiBzdHJva2U9IiMzMzMiIHN0cm9rZS13aWR0aD0iMSIvPgo8bGluZSB4MT0iMzEwIiB5MT0iODAiIHgyPSIzMTAiIHkyPSIyODAiIHN0cm9rZT0iIzMzMyIgc3Ryb2tlLXdpZHRoPSIxIi8+Cjx0ZXh0IHg9IjMxOCIgeT0iMTg1IiBmb250LXNpemU9IjEzIiBmaWxsPSIjZTc0YzNjIiBmb250LXdlaWdodD0iYm9sZCI+MjBjbTwvdGV4dD4KPC9zdmc+', answer:'æ­£æ–¹å½¢: 20Ã—20=400cmÂ²\nå††: 10Ã—10Ã—3.14=314cmÂ²\nè‰²ã¤ã=400-314=86cmÂ²\nğŸ’¡æ­£æ–¹å½¢-å†…æ¥å††', correctRate:45, tags:['5å¹´','å›³å½¢','ğŸ“¸ç”»åƒ'] },
    { subject:'ç®—æ•°', topic:'å‰²åˆï¼ˆã‚°ãƒ©ãƒ•èª­å–ï¼‰', source:'äºˆã‚·ãƒª5ä¸Š', frequency:'high', difficulty:'standard', contentImage:'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MDAiIGhlaWdodD0iMjgwIiBzdHlsZT0iYmFja2dyb3VuZDojZmZmO2ZvbnQtZmFtaWx5OnNhbnMtc2VyaWYiPgo8dGV4dCB4PSIyMCIgeT0iMjgiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIj7lj7Pjga7jgrDjg6njg5Xjga80MOS6uuOBruOCr+ODqeOCueOBrumAmuWtpuaWueazleOCkjwvdGV4dD4KPHRleHQgeD0iMjAiIHk9IjUwIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iYm9sZCI+6KGo44GX44Gm44GE44G+44GZ44CC6Ieq6Lui6LuK44Gn6YCa44GG5Lq644Gv5L2V5Lq677yfPC90ZXh0Pgo8Y2lyY2xlIGN4PSIzMDAiIGN5PSIxNzAiIHI9IjgwIiBmaWxsPSJub25lIiBzdHJva2U9IiMzMzMiIHN0cm9rZS13aWR0aD0iMiIvPgo8cGF0aCBkPSJNMzAwLDE3MCBMMzAwLDkwIEE4MCw4MCAwIDAsMSAzNzIsMTQyIFoiIGZpbGw9IiM2YzYzZmYiIGZpbGwtb3BhY2l0eT0iMC4zIi8+CjxwYXRoIGQ9Ik0zMDAsMTcwIEwzNzIsMTQyIEE4MCw4MCAwIDAsMSAzNDAsMjQ1IFoiIGZpbGw9IiNlNzRjM2MiIGZpbGwtb3BhY2l0eT0iMC4zIi8+CjxwYXRoIGQ9Ik0zMDAsMTcwIEwzNDAsMjQ1IEE4MCw4MCAwIDAsMSAyMjgsMTk4IFoiIGZpbGw9IiMyZWNjNzEiIGZpbGwtb3BhY2l0eT0iMC4zIi8+CjxwYXRoIGQ9Ik0zMDAsMTcwIEwyMjgsMTk4IEE4MCw4MCAwIDAsMSAzMDAsOTAgWiIgZmlsbD0iI2YzOWMxMiIgZmlsbC1vcGFjaXR5PSIwLjMiLz4KPHRleHQgeD0iMzIwIiB5PSIxMjUiIGZvbnQtc2l6ZT0iMTEiIGZpbGw9IiM2YzYzZmYiIGZvbnQtd2VpZ2h0PSJib2xkIj7lvpLmrakgMzAlPC90ZXh0Pgo8dGV4dCB4PSIzNDgiIHk9IjE5MCIgZm9udC1zaXplPSIxMSIgZmlsbD0iI2U3NGMzYyIgZm9udC13ZWlnaHQ9ImJvbGQiPuODkOOCuSAyNSU8L3RleHQ+Cjx0ZXh0IHg9IjI2MCIgeT0iMjQwIiBmb250LXNpemU9IjExIiBmaWxsPSIjMmVjYzcxIiBmb250LXdlaWdodD0iYm9sZCI+6Ieq6Lui6LuKID8lPC90ZXh0Pgo8dGV4dCB4PSIyNDIiIHk9IjE1MCIgZm9udC1zaXplPSIxMSIgZmlsbD0iI2YzOWMxMiIgZm9udC13ZWlnaHQ9ImJvbGQiPumbu+i7iiAyNSU8L3RleHQ+Cjwvc3ZnPg==', answer:'è‡ªè»¢è»Š=100-30-25-25=20%\n40äººÃ—0.2=8äºº\nğŸ’¡å…¨ä½“=100%ã‹ã‚‰å¼•ã', correctRate:65, tags:['5å¹´','å‰²åˆ','ğŸ“¸ç”»åƒ'] },
  ];

  // Generate varied review states for demo
  samples.forEach((s, i) => {
    var d = new Date();
    // Vary next review dates
    var offsets = [-7,-3,-1,0,0,1,2,3,5,7,14];
    var offset = offsets[i % offsets.length];
    // Image problems always due today for immediate testing
    if (s.contentImage) offset = 0;
    d.setDate(d.getDate() + offset);

    // Simulate history for some problems
    var history = [];
    var histCount = Math.floor(Math.random() * 5);
    var results = ['correct','hard','incorrect'];
    for (var h = 0; h < histCount; h++) {
      var hDate = new Date();
      hDate.setDate(hDate.getDate() - (histCount - h) * 3);
      history.push({
        date: hDate.toISOString().split('T')[0],
        result: results[Math.floor(Math.random() * (h > 1 ? 2 : 3))],
        quality: Math.floor(Math.random() * 6)
      });
    }

    // Vary mastery levels
    var masteryLevel, reps, consFailures, ef, interval;
    var rand = Math.random();
    if (rand < 0.12) {
      // Graduated
      masteryLevel = 4; reps = 5; consFailures = 0; ef = 2.8; interval = 30;
    } else if (rand < 0.2) {
      // Frozen (struggling)
      masteryLevel = 0; reps = 0; consFailures = 5; ef = 1.5; interval = 1;
    } else if (rand < 0.5) {
      // Priority (low mastery)
      masteryLevel = 1; reps = Math.floor(Math.random()*2); consFailures = Math.floor(Math.random()*2); ef = 2.1 + Math.random()*0.4; interval = Math.max(1, Math.abs(offset));
    } else {
      // In progress
      masteryLevel = 2 + Math.floor(Math.random()*2); reps = 2 + Math.floor(Math.random()*2); consFailures = 0; ef = 2.3 + Math.random()*0.5; interval = 3 + Math.floor(Math.random()*10);
    }

    var p = {
      id: 'p_' + Date.now() + '_' + Math.random().toString(36).substr(2,5) + '_' + i,
      subject: s.subject,
      topic: s.topic,
      source: s.source,
      content: s.content,
      contentImage: s.contentImage || null,
      answer: s.answer,
      answerImage: null,
      correctRate: s.correctRate != null ? s.correctRate : null,
      frequency: s.frequency,
      difficulty: s.difficulty,
      tags: s.tags || [],
      easeFactor: ef,
      interval: interval,
      repetitions: reps,
      consecutiveFailures: consFailures,
      masteryLevel: masteryLevel,
      nextReviewDate: d.toISOString().split('T')[0],
      frozen: consFailures >= 5,
      history: history,
      createdAt: today()
    };
    DATA.problems.push(p);
  });
  saveData(DATA);
  alert(`ã‚µãƒ³ãƒ—ãƒ«${samples.length}å•ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼`);
  switchScreen('Today');
}

// ================================================================
// UTILS
// ================================================================
function formatDate(d) {
  var dt = new Date(d + 'T00:00:00');
  var days = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
  return `${dt.getMonth()+1}æœˆ${dt.getDate()}æ—¥ï¼ˆ${days[dt.getDay()]}ï¼‰`;
}


// ================================================================
// TIMER (Pomodoro)
// ================================================================
var timerSec=25*60,timerRunning=false,timerInterval=null;
var timerModes=[{label:'25åˆ†',sec:25*60},{label:'5åˆ†ä¼‘',sec:5*60},{label:'50åˆ†',sec:50*60},{label:'10åˆ†ä¼‘',sec:10*60}];
var timerModeIdx=0;
function updateTimerDisplay(){var m=Math.floor(timerSec/60),s=timerSec%60;document.getElementById('timerDisplay').textContent=String(m).padStart(2,'0')+':'+String(s).padStart(2,'0')}
function toggleTimer(){if(timerRunning){clearInterval(timerInterval);timerRunning=false;document.getElementById('timerStartBtn').textContent='â–¶'}else{timerRunning=true;document.getElementById('timerStartBtn').textContent='â¸';timerInterval=setInterval(function(){timerSec--;if(timerSec<=0){clearInterval(timerInterval);timerRunning=false;document.getElementById('timerStartBtn').textContent='â–¶';alert('â° ã‚¿ã‚¤ãƒãƒ¼çµ‚äº†ï¼')}updateTimerDisplay()},1000)}}
function resetTimer(){clearInterval(timerInterval);timerRunning=false;timerSec=timerModes[timerModeIdx].sec;updateTimerDisplay();document.getElementById('timerStartBtn').textContent='â–¶'}
function cycleTimerMode(){timerModeIdx=(timerModeIdx+1)%timerModes.length;timerSec=timerModes[timerModeIdx].sec;document.getElementById('timerModeBtn').textContent=timerModes[timerModeIdx].label;updateTimerDisplay();if(timerRunning){clearInterval(timerInterval);timerRunning=false;document.getElementById('timerStartBtn').textContent='â–¶'}}

// ================================================================
// CALENDAR
// ================================================================
var calMonth=new Date().getMonth(),calYear=new Date().getFullYear();
function renderCalendar(){
  var el=document.getElementById('calTitle');if(!el)return;
  el.textContent=calYear+'å¹´'+(calMonth+1)+'æœˆ';
  var grid=document.getElementById('calGrid');
  var headers=['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
  var h=headers.map(function(x){return'<div class="cal-header">'+x+'</div>'}).join('');
  var first=new Date(calYear,calMonth,1);var startDay=first.getDay();
  var daysInMonth=new Date(calYear,calMonth+1,0).getDate();
  var daysInPrev=new Date(calYear,calMonth,0).getDate();
  var dayCounts={};var dayResults={};
  DATA.problems.forEach(function(p){(p.history||[]).forEach(function(x){
    dayCounts[x.date]=(dayCounts[x.date]||0)+1;
    if(!dayResults[x.date])dayResults[x.date]={correct:0,hard:0,incorrect:0};
    dayResults[x.date][x.result]=(dayResults[x.date][x.result]||0)+1;
  })});
  var todayStr=today();
  for(var i=0;i<startDay;i++){h+='<div class="cal-day other-month">'+(daysInPrev-startDay+i+1)+'</div>'}
  for(var d=1;d<=daysInMonth;d++){
    var ds=calYear+'-'+String(calMonth+1).padStart(2,'0')+'-'+String(d).padStart(2,'0');
    var cnt=dayCounts[ds]||0;var cls='cal-day';
    if(ds===todayStr)cls+=' today';
    if(cnt>=5)cls+=' has-data-many';else if(cnt>0)cls+=' has-data';
    var dots='';
    if(dayResults[ds]){
      var r=dayResults[ds];
      if(r.correct)dots+='<span style="color:var(--success)">â—</span>';
      if(r.hard)dots+='<span style="color:var(--warning)">â—</span>';
      if(r.incorrect)dots+='<span style="color:var(--danger)">â—</span>';
    }
    h+='<div class="'+cls+'" onclick="showDayDetail(\''+ds+'\')" style="cursor:pointer" title="'+cnt+'å•">'+d+(dots?'<div style="font-size:6px;line-height:1;margin-top:-2px">'+dots+'</div>':'')+'</div>';
  }
  var remain=7-(startDay+daysInMonth)%7;
  if(remain<7)for(var j=1;j<=remain;j++)h+='<div class="cal-day other-month">'+j+'</div>';
  grid.innerHTML=h;
}

function showDayDetail(dateStr) {
  // Find all history entries for this date
  var entries = [];
  DATA.problems.forEach(function(p) {
    (p.history || []).forEach(function(h) {
      if (h.date === dateStr) {
        entries.push({ subject: p.subject, topic: p.topic, result: h.result, memo: h.memo || '' });
      }
    });
  });
  if (entries.length === 0) return;
  var correct = entries.filter(e => e.result === 'correct').length;
  var hard = entries.filter(e => e.result === 'hard').length;
  var wrong = entries.filter(e => e.result === 'incorrect').length;
  var list = entries.map(function(e) {
    var icon = e.result === 'correct' ? 'â­•' : e.result === 'hard' ? 'ğŸ”º' : 'âŒ';
    return icon + ' ' + e.subject + ' / ' + e.topic + (e.memo ? ' ğŸ“' + e.memo : '');
  }).join('\n');
  var summary = dateStr.replace(/^\d{4}-/,'') + ' ã®å­¦ç¿’è¨˜éŒ²\n\n'
    + 'â­• ' + correct + 'å•  ğŸ”º ' + hard + 'å•  âŒ ' + wrong + 'å•\n'
    + 'åˆè¨ˆ: ' + entries.length + 'å•\n\n' + list;
  alert(summary);
}
function calNav(dir){calMonth+=dir;if(calMonth<0){calMonth=11;calYear--}if(calMonth>11){calMonth=0;calYear++}renderCalendar()}

// ================================================================
// EXAM COUNTDOWN
// ================================================================
function renderExamCountdown(){
  var el=document.getElementById('examCountdown');
  var badge=document.getElementById('countdownBadge');
  if(!el)return;
  if(DATA.settings.examDate){
    var diff=Math.ceil((new Date(DATA.settings.examDate)-new Date())/864e5);
    if(diff>0){el.style.display='';
      document.getElementById('examLabel').textContent=(DATA.settings.examName||'å…¥è©¦')+'ã¾ã§';
      document.getElementById('examDays').textContent=diff;
      if(badge)badge.textContent=(DATA.settings.examName||'å…¥è©¦')+' ã‚ã¨'+diff+'æ—¥';
    }else{el.style.display='none';if(badge)badge.textContent=''}
  }else{el.style.display='none';if(badge)badge.textContent=''}
}

function saveBirthJuku(){
  DATA.settings.birthDate=document.getElementById('settingBirthDate').value;
  DATA.settings.jukuType=document.getElementById('settingJuku').value;
  saveData(DATA);
  updateJukuInfo();
}
function updateJukuInfo(){
  var el=document.getElementById('jukuInfo');
  if(!el)return;
  var info=getJukuGradeMonth(DATA.settings.birthDate);
  if(!info){el.textContent='ç”Ÿå¹´æœˆæ—¥ã‚’è¨­å®šã—ã¦ãã ã•ã„';return}
  var juku=DATA.settings.jukuType||'none';
  var jukuNames={none:'æŒ‡å®šãªã—',yotsuya:'å››è°·å¤§å¡š',sapix:'SAPIX',nichinoken:'æ—¥èƒ½ç ”'};
  el.innerHTML='<strong>å¡¾å­¦å¹´: '+info.grade+'å¹´ç”Ÿ</strong>ï¼ˆå­¦æ ¡: å°'+info.schoolGrade+'ï¼‰'
    +(juku!=='none'?' ãƒ» '+jukuNames[juku]+'æº–æ‹ ':'');
  // Show this month's topics
  if(juku!=='none'){
    var topics=getCurrentMonthTopics(juku,info.grade,info.month);
    if(topics.length){el.innerHTML+='<br>ğŸ“– ä»Šæœˆã®å˜å…ƒ: '+topics.map(function(t){return t.name}).join(', ')}
  }
}
function saveExamGoal(){
  DATA.settings.examDate=document.getElementById('settingExamDate').value;
  DATA.settings.examName=document.getElementById('settingExamName').value;
  saveData(DATA);
  // Show current month topics
  var juku=DATA.settings.jukuType||'none';
  var info=getJukuGradeMonth(DATA.settings.birthDate);
  var mtEl=document.getElementById('monthTopics');
  if(mtEl && info && juku!=='none'){
    var topics=getCurrentMonthTopics(juku,info.grade,info.month);
    if(topics.length){mtEl.style.display='';
      document.getElementById('monthTopicsList').textContent=topics.map(function(t){return t.subject+': '+t.name}).join(' / ')
    }else{mtEl.style.display='none'}
  }else if(mtEl){mtEl.style.display='none'}
  renderExamCountdown();
}

// ================================================================
// SHARE LINK SYNC
// ================================================================
function generateShareLink(){
  try{var json=JSON.stringify({problems:DATA.problems,settings:DATA.settings});
    var compressed=btoa(unescape(encodeURIComponent(json)));
    var url=location.origin+location.pathname+'#sync='+compressed;
    document.getElementById('shareLinkArea').style.display='';
    document.getElementById('shareLinkText').value=url;
  }catch(e){alert('ãƒ‡ãƒ¼ã‚¿ãŒå¤§ãã™ãã¾ã™ã€‚JSONã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚')}
}
function importFromURL(){var h=location.hash;if(!h.startsWith('#sync=')){alert('å…±æœ‰ãƒªãƒ³ã‚¯ã‚’é–‹ã„ã¦ã‹ã‚‰ã“ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„');return}
  try{var d=JSON.parse(decodeURIComponent(escape(atob(h.slice(6)))));
    if(d.problems){var added=0;d.problems.forEach(function(p){if(!DATA.problems.find(function(x){return x.id===p.id})){DATA.problems.push(p);added++}});
      if(d.settings)Object.assign(DATA.settings,d.settings);saveData(DATA);location.hash='';
      alert(added+'å•ã‚’å–ã‚Šè¾¼ã¿ã¾ã—ãŸ');switchScreen('Today')}
  }catch(e){alert('ãƒªãƒ³ã‚¯ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ')}}

// ================================================================
// DASHBOARD ZONE DETAIL
// ================================================================
var _zoneProbs={};

function showSZDetail(zone){
  var panel=document.getElementById('szDetailPanel');
  if(!panel)return;
  panel.style.display='';
  var labels={comfort:'âš ï¸ ã‚³ãƒ³ãƒ•ã‚©ãƒ¼ãƒˆã‚¾ãƒ¼ãƒ³ï¼ˆç°¡å˜ã™ãã‚‹ï¼‰',stretch:'âœ¨ ã‚¹ãƒˆãƒ¬ãƒƒãƒã‚¾ãƒ¼ãƒ³ï¼ˆæœ€é©ãªè² è·ï¼‰',panic:'ğŸ”´ ãƒ‘ãƒ‹ãƒƒã‚¯ã‚¾ãƒ¼ãƒ³ï¼ˆé›£ã—ã™ãã‚‹ï¼‰'};
  document.getElementById('szDetailTitle').textContent=labels[zone]||zone;
  var probs=DATA.problems.filter(function(p){return !p.frozen && p.masteryLevel<4 && classifyStretchZone(p)===zone});
  document.getElementById('szDetailList').innerHTML=probs.length?probs.map(function(p){
    var hist=p.history||[];var recent=hist.slice(-3);
    var c=0;recent.forEach(function(h){if(h.result==='correct'||h.quality>=4)c++});
    var rateStr=recent.length?Math.round(c/recent.length*100)+'%':'--';
    return'<div class="zone-detail-item"><strong>'+p.subject+'</strong> '+p.topic+' <span style="color:var(--text2);font-size:10px">ç›´è¿‘'+rateStr+'</span></div>';
  }).join(''):'<div style="color:var(--text2);font-size:12px">ãªã—</div>';
}
function showZoneDetail(zone,title){
  var panel=document.getElementById('zoneDetailPanel');if(!panel)return;
  panel.style.display='';
  document.getElementById('zoneDetailTitle').textContent=title+' ã®å•é¡Œ';
  var probs=_zoneProbs[zone]||[];
  document.getElementById('zoneDetailList').innerHTML=probs.length?probs.map(function(p){
    return'<div class="zone-detail-item"><strong>'+p.subject+'</strong> '+p.topic+' <span style="color:var(--text2);font-size:10px">'+(p.source||'')+' ãƒ» '+(p.interval||0)+'æ—¥é–“éš”</span></div>'
  }).join(''):'<div style="color:var(--text2);font-size:12px">ãªã—</div>';
}


// ================================================================
// STRETCH ZONE SYSTEM
// ================================================================
// Classify problem into comfort/stretch/panic based on recent history
function classifyStretchZone(p) {
  var hist = p.history || [];
  if (hist.length < 2) return 'stretch'; // new problems = stretch by default
  // Take last 3 (or fewer)
  var recent = hist.slice(-3);
  var correct = 0;
  recent.forEach(function(h) { if (h.result === 'correct' || h.quality >= 4) correct++; });
  var rate = correct / recent.length;
  if (rate >= 0.8) return 'comfort';   // 80%+ correct = too easy
  if (rate < 0.4) return 'panic';      // <40% = too hard
  return 'stretch';                     // 40-80% = optimal zone
}

function getStretchZoneLabel(zone) {
  return {comfort:'âš ï¸ ã‚³ãƒ³ãƒ•ã‚©ãƒ¼ãƒˆ',stretch:'âœ¨ ã‚¹ãƒˆãƒ¬ãƒƒãƒ',panic:'ğŸ”´ ãƒ‘ãƒ‹ãƒƒã‚¯'}[zone] || zone;
}
function getStretchZoneBadge(zone) {
  var cls = {comfort:'sz-comfort',stretch:'sz-stretch',panic:'sz-panic'}[zone]||'sz-stretch';
  var label = {comfort:'âš ï¸ ç°¡å˜',stretch:'âœ¨ æœ€é©',panic:'ğŸ”´ é›£ã—ã„'}[zone]||'';
  return '<span class="sz-badge '+cls+'">'+label+'</span>';
}

// Stretch zone stats by subject
function getStretchZoneStats() {
  var stats = {comfort:{},stretch:{},panic:{}};
  var totals = {comfort:0,stretch:0,panic:0};
  DATA.problems.forEach(function(p){
    if(p.frozen || getStage(p) === 'mastered') return;
    var sz = classifyStretchZone(p);
    stats[sz][p.subject] = (stats[sz][p.subject]||0) + 1;
    totals[sz]++;
  });
  return {bySubject:stats, totals:totals};
}

// ================================================================
// THEME (light/dark)
// ================================================================
function toggleCalendar(){
  var body = document.getElementById('calBody');
  var toggle = document.getElementById('calToggle');
  var open = body.style.display === 'none';
  body.style.display = open ? 'block' : 'none';
  toggle.textContent = open ? 'â–¼' : 'â–¶';
  if(open) renderCalendar();
}

function toggleTheme(){
  var isLight = document.documentElement.classList.toggle('light');
  localStorage.setItem('revnote-theme', isLight ? 'light' : 'dark');
  updateThemeButtons();
}
function updateThemeButtons(){
  var isLight = document.documentElement.classList.contains('light');
  var icon = isLight ? 'â˜€ï¸' : 'ğŸŒ™';
  var label = isLight ? 'ãƒ©ã‚¤ãƒˆ' : 'ãƒ€ãƒ¼ã‚¯';
  var btn = document.getElementById('settingThemeBtn');
  if(btn) btn.textContent = icon + ' ' + label;
  var sBtn = document.getElementById('sideThemeBtn');
  if(sBtn) sBtn.innerHTML = '<span>' + icon + '</span>ãƒ†ãƒ¼ãƒ';
}
function initTheme(){
  var saved = localStorage.getItem('revnote-theme');
  if(saved === 'light') document.documentElement.classList.add('light');
  updateThemeButtons();
}

// ================================================================
// JUKU CURRICULUM DATA
// ================================================================
// Format: grade-month (e.g. '4-2' = 4å¹´ç”Ÿ2æœˆ = æ–°4å¹´æœ€åˆ)
// School year: Feb=start. '4-2'~'4-7'=å‰æœŸ, '4-9'~'5-1'=å¾ŒæœŸ
// null = not in standard curriculum for that juku

var JUKU_CURRICULUM = {
  // ===== ç®—æ•° =====
  // --- 4å¹´ å‰æœŸ (2æœˆ~7æœˆ) ---
  'è¨ˆç®—ã®å·¥å¤«':        {subject:'ç®—æ•°', yotsuya:'4-2',  sapix:'4-2',  nichinoken:'4-2'},
  'å’Œå·®ç®—':            {subject:'ç®—æ•°', yotsuya:'4-2',  sapix:'4-3',  nichinoken:'4-3'},
  'æ¤æœ¨ç®—':            {subject:'ç®—æ•°', yotsuya:'4-3',  sapix:'4-3',  nichinoken:'4-4'},
  'å‘¨æœŸç®—':            {subject:'ç®—æ•°', yotsuya:'4-3',  sapix:'4-4',  nichinoken:'4-5'},
  'ã¤ã‚‹ã‹ã‚ç®—':        {subject:'ç®—æ•°', yotsuya:'4-4',  sapix:'4-4',  nichinoken:'4-5'},
  'éä¸è¶³ç®—':          {subject:'ç®—æ•°', yotsuya:'4-4',  sapix:'4-5',  nichinoken:'4-6'},
  'è§’åº¦':              {subject:'ç®—æ•°', yotsuya:'4-4',  sapix:'4-5',  nichinoken:'4-5'},
  'ä¸‰è§’å½¢ã®æ€§è³ª':      {subject:'ç®—æ•°', yotsuya:'4-5',  sapix:'4-5',  nichinoken:'4-6'},
  'å››è§’å½¢ã®æ€§è³ª':      {subject:'ç®—æ•°', yotsuya:'4-5',  sapix:'4-6',  nichinoken:'4-6'},
  'é¢ç©ã®åŸºæœ¬':        {subject:'ç®—æ•°', yotsuya:'4-5',  sapix:'4-6',  nichinoken:'4-7'},
  'ç´„æ•°':              {subject:'ç®—æ•°', yotsuya:'4-6',  sapix:'4-6',  nichinoken:'4-9'},
  'å€æ•°':              {subject:'ç®—æ•°', yotsuya:'4-6',  sapix:'4-7',  nichinoken:'4-9'},
  'æ–¹é™£ç®—':            {subject:'ç®—æ•°', yotsuya:'4-6',  sapix:'4-7',  nichinoken:'4-10'},
  'å°æ•°ã®è¨ˆç®—':        {subject:'ç®—æ•°', yotsuya:'4-7',  sapix:'4-3',  nichinoken:'4-9'},
  'åˆ†æ•°ã®åŸºæœ¬':        {subject:'ç®—æ•°', yotsuya:'4-7',  sapix:'4-7',  nichinoken:'4-10'},
  // --- 4å¹´ å¾ŒæœŸ (9æœˆ~1æœˆ) ---
  'å ´åˆã®æ•°':          {subject:'ç®—æ•°', yotsuya:'4-9',  sapix:'4-9',  nichinoken:'4-10'},
  'å¹³å‡ç®—':            {subject:'ç®—æ•°', yotsuya:'4-9',  sapix:'4-9',  nichinoken:'4-10'},
  'ç·šåˆ†å›³':            {subject:'ç®—æ•°', yotsuya:'4-10', sapix:'4-4',  nichinoken:'4-11'},
  'è¦å‰‡æ€§':            {subject:'ç®—æ•°', yotsuya:'4-10', sapix:'4-10', nichinoken:'4-11'},
  'å††ã¨æ‰‡å½¢':          {subject:'ç®—æ•°', yotsuya:'4-11', sapix:'4-10', nichinoken:'4-12'},
  'æ­£æ–¹å½¢ã¨é•·æ–¹å½¢ã®é¢ç©':{subject:'ç®—æ•°',yotsuya:'4-11',sapix:'4-6',  nichinoken:'4-12'},
  'è¤‡åˆå›³å½¢ã®é¢ç©':    {subject:'ç®—æ•°', yotsuya:'4-12', sapix:'4-11', nichinoken:'5-1'},
  'ãŒã„æ•°':            {subject:'ç®—æ•°', yotsuya:'4-7',  sapix:'4-11', nichinoken:'4-11'},
  'è¡¨ã¨ã‚°ãƒ©ãƒ•':        {subject:'ç®—æ•°', yotsuya:'4-12', sapix:'4-12', nichinoken:'5-1'},

  // ===== 5å¹´ å‰æœŸ (2æœˆ~7æœˆ) =====
  'å‰²åˆã®åŸºæœ¬':        {subject:'ç®—æ•°', yotsuya:'5-2',  sapix:'5-2',  nichinoken:'5-2'},
  'ç™¾åˆ†ç‡ã¨æ­©åˆ':      {subject:'ç®—æ•°', yotsuya:'5-2',  sapix:'5-2',  nichinoken:'5-3'},
  'é£Ÿå¡©æ°´':            {subject:'ç®—æ•°', yotsuya:'5-3',  sapix:'5-3',  nichinoken:'5-4'},
  'æç›Šç®—':            {subject:'ç®—æ•°', yotsuya:'5-3',  sapix:'5-3',  nichinoken:'5-4'},
  'é€Ÿã•ã®åŸºæœ¬':        {subject:'ç®—æ•°', yotsuya:'5-4',  sapix:'5-4',  nichinoken:'5-5'},
  'æ—…äººç®—':            {subject:'ç®—æ•°', yotsuya:'5-4',  sapix:'5-5',  nichinoken:'5-11'},
  'é€šéç®—':            {subject:'ç®—æ•°', yotsuya:'5-5',  sapix:'5-7',  nichinoken:'5-11'},
  'æµæ°´ç®—':            {subject:'ç®—æ•°', yotsuya:'5-5',  sapix:'5-7',  nichinoken:'5-12'},
  'æ™‚è¨ˆç®—':            {subject:'ç®—æ•°', yotsuya:'5-5',  sapix:'5-7',  nichinoken:'5-12'},
  'æ¯”ã®åŸºæœ¬':          {subject:'ç®—æ•°', yotsuya:'5-6',  sapix:'5-6',  nichinoken:'5-9'},
  'æ¯”ä¾‹ã¨åæ¯”ä¾‹':      {subject:'ç®—æ•°', yotsuya:'5-6',  sapix:'5-6',  nichinoken:'5-10'},
  'ç›¸ä¼¼':              {subject:'ç®—æ•°', yotsuya:'5-7',  sapix:'5-7',  nichinoken:'5-10'},
  'é¢ç©æ¯”':            {subject:'ç®—æ•°', yotsuya:'5-7',  sapix:'5-7',  nichinoken:'5-11'},

  // ===== 5å¹´ å¾ŒæœŸ (9æœˆ~1æœˆ) =====
  'ä»•äº‹ç®—':            {subject:'ç®—æ•°', yotsuya:'5-9',  sapix:'5-9',  nichinoken:'5-12'},
  'ãƒ‹ãƒ¥ãƒ¼ãƒˆãƒ³ç®—':      {subject:'ç®—æ•°', yotsuya:'5-10', sapix:'5-10', nichinoken:'6-2'},
  'æ•°åˆ—':              {subject:'ç®—æ•°', yotsuya:'5-10', sapix:'5-10', nichinoken:'5-10'},
  'å ´åˆã®æ•°ï¼ˆç™ºå±•ï¼‰':  {subject:'ç®—æ•°', yotsuya:'5-11', sapix:'5-11', nichinoken:'5-9'},
  'ç«‹ä½“å›³å½¢':          {subject:'ç®—æ•°', yotsuya:'5-11', sapix:'5-11', nichinoken:'5-12'},
  'ä½“ç©ã¨è¡¨é¢ç©':      {subject:'ç®—æ•°', yotsuya:'5-12', sapix:'5-12', nichinoken:'6-1'},
  'é€Ÿã•ã¨æ¯”':          {subject:'ç®—æ•°', yotsuya:'5-12', sapix:'5-12', nichinoken:'6-2'},
  'ãƒ€ã‚¤ãƒ¤ã‚°ãƒ©ãƒ ':      {subject:'ç®—æ•°', yotsuya:'6-1',  sapix:'5-12', nichinoken:'6-2'},
  'å¹³é¢å›³å½¢ã¨æ¯”':      {subject:'ç®—æ•°', yotsuya:'6-2',  sapix:'6-2',  nichinoken:'6-3'},

  // ===== 6å¹´ (2æœˆ~7æœˆ: ç·åˆæ¼”ç¿’) =====
  'æ•°ã®æ€§è³ªï¼ˆç™ºå±•ï¼‰':  {subject:'ç®—æ•°', yotsuya:'6-2',  sapix:'6-2',  nichinoken:'6-2'},
  'æ–‡ç« é¡Œç·åˆ':        {subject:'ç®—æ•°', yotsuya:'6-3',  sapix:'6-3',  nichinoken:'6-3'},
  'å›³å½¢ç·åˆ':          {subject:'ç®—æ•°', yotsuya:'6-4',  sapix:'6-4',  nichinoken:'6-4'},
  'é€Ÿã•ç·åˆ':          {subject:'ç®—æ•°', yotsuya:'6-5',  sapix:'6-5',  nichinoken:'6-5'},

  // ===== ç†ç§‘ =====
  'æ¤ç‰©ã®ã¤ãã‚Š':      {subject:'ç†ç§‘', yotsuya:'4-2',  sapix:'4-3',  nichinoken:'4-4'},
  'æ˜†è™«':              {subject:'ç†ç§‘', yotsuya:'4-3',  sapix:'4-4',  nichinoken:'4-5'},
  'å¤©ä½“ã®å‹•ã':        {subject:'ç†ç§‘', yotsuya:'4-5',  sapix:'4-5',  nichinoken:'4-6'},
  'æ°´æº¶æ¶²ã®æ€§è³ª':      {subject:'ç†ç§‘', yotsuya:'5-2',  sapix:'5-2',  nichinoken:'5-3'},
  'æ°—ä½“ã®æ€§è³ª':        {subject:'ç†ç§‘', yotsuya:'5-3',  sapix:'5-3',  nichinoken:'5-4'},
  'ã¦ã“ã¨æ»‘è»Š':        {subject:'ç†ç§‘', yotsuya:'5-5',  sapix:'5-5',  nichinoken:'5-6'},
  'é›»æµã¨å›è·¯':        {subject:'ç†ç§‘', yotsuya:'5-6',  sapix:'5-4',  nichinoken:'5-5'},
  'å¤©ä½“ï¼ˆç™ºå±•ï¼‰':      {subject:'ç†ç§‘', yotsuya:'5-9',  sapix:'5-9',  nichinoken:'5-10'},
  'ç‰©è³ªã®å¤‰åŒ–':        {subject:'ç†ç§‘', yotsuya:'6-2',  sapix:'6-2',  nichinoken:'6-3'},

  // ===== ç¤¾ä¼š =====
  'åœ°å›³ã®èª­ã¿æ–¹':      {subject:'ç¤¾ä¼š', yotsuya:'4-2',  sapix:'4-2',  nichinoken:'4-2'},
  'æ—¥æœ¬ã®å›½åœŸ':        {subject:'ç¤¾ä¼š', yotsuya:'4-3',  sapix:'4-3',  nichinoken:'4-3'},
  'æ—¥æœ¬ã®è¾²æ¥­':        {subject:'ç¤¾ä¼š', yotsuya:'4-5',  sapix:'4-5',  nichinoken:'4-6'},
  'æ—¥æœ¬ã®å·¥æ¥­':        {subject:'ç¤¾ä¼š', yotsuya:'4-7',  sapix:'4-7',  nichinoken:'4-9'},
  'æ­´å²ï¼ˆå¤ä»£ã€œå¹³å®‰ï¼‰':{subject:'ç¤¾ä¼š', yotsuya:'5-9',  sapix:'5-9',  nichinoken:'5-9'},
  'æ­´å²ï¼ˆéŒå€‰ã€œå®¤ç”ºï¼‰':{subject:'ç¤¾ä¼š', yotsuya:'5-10', sapix:'5-10', nichinoken:'5-10'},
  'æ­´å²ï¼ˆæˆ¦å›½ã€œæ±Ÿæˆ¸ï¼‰':{subject:'ç¤¾ä¼š', yotsuya:'5-11', sapix:'5-11', nichinoken:'5-11'},
  'æ­´å²ï¼ˆæ˜æ²»ã€œç¾ä»£ï¼‰':{subject:'ç¤¾ä¼š', yotsuya:'5-12', sapix:'5-12', nichinoken:'5-12'},
  'å…¬æ°‘':              {subject:'ç¤¾ä¼š', yotsuya:'6-2',  sapix:'6-2',  nichinoken:'6-2'},
};

// Derive school grade & month from birthdate
// Rule: Born Apr 2 ~ next Apr 1 â†’ same school year
// å°4 = grade 4, starts April of year when child turns 10
// Juku "4å¹´" starts February (æ–°4å¹´=å°3ã®2æœˆ)
function getJukuGradeMonth(birthDateStr) {
  if (!birthDateStr) return null;
  var bd = new Date(birthDateStr);
  var now = new Date();
  // School grade: child born in year Y enters grade 1 in April Y+7
  // (except born Jan-Mar â†’ enters April Y+6)
  var birthYear = bd.getFullYear();
  var birthMonth = bd.getMonth() + 1; // 1-12
  var enterYear; // year child enters grade 1
  if (birthMonth >= 4) { enterYear = birthYear + 7; }
  else { enterYear = birthYear + 6; }

  // Current school grade
  var currentMonth = now.getMonth() + 1; // 1-12
  var currentYear = now.getFullYear();
  var schoolYear = currentYear - enterYear + 1; // grade 1 in enterYear
  if (currentMonth < 4) schoolYear--; // before April, still previous school year

  // Juku grade: "æ–°4å¹´" = å°3ã®2æœˆ = school grade 3, month 2
  // So juku grade 4 starts when schoolYear=3 and month>=2, or schoolYear>=4
  var jukuGrade;
  if (currentMonth >= 2) {
    jukuGrade = schoolYear + 1; // Feb onwards = æ–°(schoolYear+1)å¹´
  } else {
    jukuGrade = schoolYear; // Jan = still current juku year
  }

  return { grade: Math.max(1, Math.min(6, jukuGrade)), month: currentMonth, schoolGrade: schoolYear };
}

// Check if a topic should have been learned by now
function isTopicLearned(topicCurr, jukuType, currentGrade, currentMonth) {
  if (!topicCurr || !jukuType || jukuType === 'none') return true; // show all
  var timing = topicCurr[jukuType];
  if (!timing) return true;
  var parts = timing.split('-');
  var tGrade = parseInt(parts[0]);
  var tMonth = parseInt(parts[1]);
  if (currentGrade > tGrade) return true;
  if (currentGrade === tGrade && currentMonth >= tMonth) return true;
  return false;
}

// Get topics for current month
function getCurrentMonthTopics(jukuType, currentGrade, currentMonth) {
  var topics = [];
  Object.keys(JUKU_CURRICULUM).forEach(function(name) {
    var c = JUKU_CURRICULUM[name];
    var timing = c[jukuType];
    if (!timing) return;
    var parts = timing.split('-');
    if (parseInt(parts[0]) === currentGrade && parseInt(parts[1]) === currentMonth) {
      topics.push({name: name, subject: c.subject});
    }
  });
  return topics;
}


// ================================================================
// SAMPLE PROBLEMS WITH CURRICULUM MAPPING
// ================================================================
function generateSampleProblems() {
  var id = Date.now();
  var samples = [
    // ===== 4å¹´ ç®—æ•° å‰æœŸ =====
    {subject:'ç®—æ•°',topic:'è¨ˆç®—ã®å·¥å¤«',question:'25Ã—36 ã‚’å·¥å¤«ã—ã¦è¨ˆç®—ã—ãªã•ã„',answer:'25Ã—4=100ã‚’åˆ©ç”¨\n25Ã—36=25Ã—4Ã—9=900\nğŸ’¡25Ã—4=100ã¯å¿…é ˆæš—è¨˜',source:'åŸºæœ¬',difficulty:1,curriculum:'è¨ˆç®—ã®å·¥å¤«'},
    {subject:'ç®—æ•°',topic:'è¨ˆç®—ã®å·¥å¤«',question:'998Ã—5 ã‚’å·¥å¤«ã—ã¦è¨ˆç®—ã—ãªã•ã„',answer:'(1000-2)Ã—5=5000-10=4990\nğŸ’¡1000ã«è¿‘ã„æ•°ã¯å¼•ãç®—ã§',source:'åŸºæœ¬',difficulty:1,curriculum:'è¨ˆç®—ã®å·¥å¤«'},
    {subject:'ç®—æ•°',topic:'è¨ˆç®—ã®å·¥å¤«',question:'â–¡ã«ã‚ã¦ã¯ã¾ã‚‹æ•°: (â–¡+15)Ã—7=71',answer:'é€†ç®—: 71ã¯å‰²ã‚Œãªã„ã®ã§ç¢ºèªâ†’(â–¡+15)Ã—7=161?\næ­£ã—ãã¯71Ã·7ã¯å‰²ã‚Šåˆ‡ã‚Œãªã„â†’å•é¡Œç¢ºèª\nåˆ¥è§£: â–¡+15=71Ã·7...',source:'äºˆã‚·ãƒª4ä¸Š',difficulty:2,curriculum:'è¨ˆç®—ã®å·¥å¤«'},
    {subject:'ç®—æ•°',topic:'å’Œå·®ç®—',question:'å…„ã¨å¼Ÿã§åˆè¨ˆ3200å††ã€‚å…„ãŒå¼Ÿã‚ˆã‚Š400å††å¤šã„ã€‚ãã‚Œãã‚Œã„ãã‚‰ï¼Ÿ',answer:'ã€å’Œå·®ç®—ã€‘\nå…„=(3200+400)Ã·2=1800å††\nå¼Ÿ=3200-1800=1400å††\nğŸ’¡å¤§=(å’Œ+å·®)Ã·2',source:'äºˆã‚·ãƒª4ä¸Š',difficulty:1,curriculum:'å’Œå·®ç®—'},
    {subject:'ç®—æ•°',topic:'å’Œå·®ç®—',question:'3ã¤ã®æ•°ã®å’ŒãŒ45ã€‚ä¸€ç•ªå¤§ãã„æ•°ã¯ä¸€ç•ªå°ã•ã„æ•°ã‚ˆã‚Š12å¤§ããã€çœŸã‚“ä¸­ã®æ•°ã‚ˆã‚Š5å¤§ãã„ã€‚',answer:'å°=x, ä¸­=x+7, å¤§=x+12\n3x+19=45 â†’ x=26/3...\nåˆ¥è§£: å…¨éƒ¨å°ã«æƒãˆã‚‹â†’3x+12+7=45â†’x=26/3\nâ€»æ•´æ•°å•é¡Œãªã‚‰å†ç¢ºèª',source:'å¿œç”¨',difficulty:3,curriculum:'å’Œå·®ç®—'},
    {subject:'ç®—æ•°',topic:'æ¤æœ¨ç®—',question:'120mã®é“ã«6mãŠãã«æœ¨ã‚’æ¤ãˆã‚‹ã€‚ä¸¡ç«¯ã«ã‚‚æ¤ãˆã‚‹ã¨ä½•æœ¬ï¼Ÿ',answer:'120Ã·6=20(é–“ã®æ•°)\n20+1=21æœ¬\nğŸ’¡ä¸¡ç«¯ã‚ã‚Š=é–“+1, ä¸¡ç«¯ãªã—=é–“-1, ç‰‡æ–¹=é–“',source:'åŸºæœ¬',difficulty:1,curriculum:'æ¤æœ¨ç®—'},
    {subject:'ç®—æ•°',topic:'æ¤æœ¨ç®—',question:'å††å½¢ã®æ± ã®å‘¨ã‚Šã«3mãŠãã«æœ¨ã‚’æ¤ãˆã‚‹ã€‚å‘¨ã¯60mã€‚æœ¨ã¯ä½•æœ¬ï¼Ÿ',answer:'60Ã·3=20æœ¬\nğŸ’¡å††å½¢=é–“ã®æ•°ã¨åŒã˜ï¼ˆç«¯ãŒãªã„ã‹ã‚‰ï¼‰',source:'åŸºæœ¬',difficulty:2,curriculum:'æ¤æœ¨ç®—'},
    {subject:'ç®—æ•°',topic:'ã¤ã‚‹ã‹ã‚ç®—',question:'ãƒ„ãƒ«ã¨ã‚«ãƒ¡ãŒåˆã‚ã›ã¦10åŒ¹ã€‚è¶³ã®åˆè¨ˆãŒ28æœ¬ã€‚ãã‚Œãã‚Œä½•åŒ¹ï¼Ÿ',answer:'å…¨éƒ¨ãƒ„ãƒ«ä»®å®šâ†’è¶³20æœ¬\nå·®: 28-20=8æœ¬\nã‚«ãƒ¡1åŒ¹ã§ãƒ„ãƒ«ã‚ˆã‚Š2æœ¬å¤šã„\nã‚«ãƒ¡: 8Ã·2=4åŒ¹ ãƒ„ãƒ«: 6åŒ¹',source:'äºˆã‚·ãƒª4ä¸Š',difficulty:1,curriculum:'ã¤ã‚‹ã‹ã‚ç®—'},
    {subject:'ç®—æ•°',topic:'ã¤ã‚‹ã‹ã‚ç®—',question:'1å€‹80å††ã®ã‚Šã‚“ã”ã¨1å€‹50å††ã®ã¿ã‹ã‚“ã‚’åˆã‚ã›ã¦15å€‹è²·ã„ã€åˆè¨ˆ900å††ã€‚ãã‚Œãã‚Œä½•å€‹ï¼Ÿ',answer:'å…¨éƒ¨ã¿ã‹ã‚“ä»®å®šâ†’50Ã—15=750å††\nå·®: 900-750=150å††\nã‚Šã‚“ã”1å€‹ã§50å††å¤šã„\nã‚Šã‚“ã”: 150Ã·50=3å€‹ ã¿ã‹ã‚“: 12å€‹',source:'åŸºæœ¬',difficulty:2,curriculum:'ã¤ã‚‹ã‹ã‚ç®—'},
    {subject:'ç®—æ•°',topic:'è§’åº¦',question:'ä¸‰è§’å½¢ã®å†…è§’ã®å’Œã¯ä½•åº¦ï¼Ÿäº”è§’å½¢ã¯ï¼Ÿ',answer:'ä¸‰è§’å½¢=180Â°\nå››è§’å½¢=360Â° äº”è§’å½¢=540Â°\nğŸ’¡nè§’å½¢=(n-2)Ã—180Â°',source:'åŸºæœ¬',difficulty:1,curriculum:'è§’åº¦'},
    {subject:'ç®—æ•°',topic:'è§’åº¦',question:'äºŒç­‰è¾ºä¸‰è§’å½¢ã®é ‚è§’ãŒ40Â°ã€‚åº•è§’ã¯ï¼Ÿ',answer:'(180-40)Ã·2=70Â°\nğŸ’¡äºŒç­‰è¾ºä¸‰è§’å½¢ã¯åº•è§’ãŒç­‰ã—ã„',source:'åŸºæœ¬',difficulty:1,curriculum:'è§’åº¦'},
    {subject:'ç®—æ•°',topic:'ç´„æ•°',question:'36ã®ç´„æ•°ã‚’ã™ã¹ã¦æ±‚ã‚ãªã•ã„ã€‚',answer:'ãƒšã‚¢ã§æ¢ã™: 1Ã—36,2Ã—18,3Ã—12,4Ã—9,6Ã—6\n9å€‹\nğŸ’¡ç´ å› æ•°åˆ†è§£:36=2Â²Ã—3Â²â†’(2+1)(2+1)=9å€‹',source:'äºˆã‚·ãƒª4ä¸Š',difficulty:1,curriculum:'ç´„æ•°'},
    {subject:'ç®—æ•°',topic:'ç´„æ•°',question:'72ã¨54ã®æœ€å¤§å…¬ç´„æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚',answer:'72=2Â³Ã—3Â² 54=2Ã—3Â³\nGCD=2Â¹Ã—3Â²=18\nğŸ’¡å…±é€šã™ã‚‹ç´ å› æ•°ã®å°ã•ã„æ–¹ã®æŒ‡æ•°',source:'åŸºæœ¬',difficulty:2,curriculum:'ç´„æ•°'},
    {subject:'ç®—æ•°',topic:'å€æ•°',question:'4ã¨6ã®æœ€å°å…¬å€æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚',answer:'4=2Â² 6=2Ã—3\nLCM=2Â²Ã—3=12\nğŸ’¡å„ç´ å› æ•°ã®å¤§ãã„æ–¹ã®æŒ‡æ•°',source:'åŸºæœ¬',difficulty:1,curriculum:'å€æ•°'},
    {subject:'ç®—æ•°',topic:'å ´åˆã®æ•°',question:'1,2,3,4ã®4æšã®ã‚«ãƒ¼ãƒ‰ã‹ã‚‰3æšé¸ã‚“ã§3æ¡ã®æ•´æ•°ã‚’ä½œã‚‹ã€‚ä½•é€šã‚Šï¼Ÿ',answer:'ç™¾ã®ä½:4é€šã‚Š åã®ä½:3é€šã‚Š ä¸€ã®ä½:2é€šã‚Š\n4Ã—3Ã—2=24é€šã‚Š\nğŸ’¡ä¸¦ã¹ã‚‹â†’é †åˆ—',source:'äºˆã‚·ãƒª4ä¸‹',difficulty:2,curriculum:'å ´åˆã®æ•°'},
    {subject:'ç®—æ•°',topic:'å ´åˆã®æ•°',question:'5äººã‹ã‚‰3äººé¸ã¶çµ„ã¿åˆã‚ã›ã¯ä½•é€šã‚Šï¼Ÿ',answer:'5C3=5Ã—4Ã—3Ã·(3Ã—2Ã—1)=10é€šã‚Š\nğŸ’¡é¸ã¶â†’çµ„åˆã›ï¼ˆÃ·ä¸¦ã¹æ–¹ï¼‰',source:'åŸºæœ¬',difficulty:2,curriculum:'å ´åˆã®æ•°'},
    {subject:'ç®—æ•°',topic:'é¢ç©ã®åŸºæœ¬',question:'åº•è¾º8cmã€é«˜ã•5cmã®ä¸‰è§’å½¢ã®é¢ç©',answer:'8Ã—5Ã·2=20cmÂ²\nğŸ’¡ä¸‰è§’å½¢=åº•è¾ºÃ—é«˜ã•Ã·2',source:'åŸºæœ¬',difficulty:1,curriculum:'é¢ç©ã®åŸºæœ¬'},
    {subject:'ç®—æ•°',topic:'å††ã¨æ‰‡å½¢',question:'åŠå¾„6cmã®å††ã®é¢ç©ã¨ã€ãã®1/4ã®æ‰‡å½¢ã®é¢ç©',answer:'å††: 6Ã—6Ã—3.14=113.04cmÂ²\næ‰‡å½¢: 113.04Ã·4=28.26cmÂ²\nğŸ’¡æ‰‡å½¢=å††Ã—(ä¸­å¿ƒè§’/360)',source:'åŸºæœ¬',difficulty:2,curriculum:'å††ã¨æ‰‡å½¢'},

    // ===== 5å¹´ ç®—æ•° =====
    {subject:'ç®—æ•°',topic:'å‰²åˆã®åŸºæœ¬',question:'å®šä¾¡800å††ã®å“ç‰©ã‚’2å‰²å¼•ãã§è²·ã£ãŸã€‚ä»£é‡‘ã¯ï¼Ÿ',answer:'800Ã—(1-0.2)=800Ã—0.8=640å††\nğŸ’¡â—‹å‰²å¼•=1-å‰²åˆ ã‚’æ›ã‘ã‚‹',source:'äºˆã‚·ãƒª5ä¸Š',difficulty:1,curriculum:'å‰²åˆã®åŸºæœ¬'},
    {subject:'ç®—æ•°',topic:'ç™¾åˆ†ç‡ã¨æ­©åˆ',question:'60äººã®ã‚¯ãƒ©ã‚¹ã§45äººãŒåˆæ ¼ã€‚åˆæ ¼ç‡ã¯ï¼Ÿ',answer:'45Ã·60=0.75=75%\nğŸ’¡å‰²åˆ=æ¯”ã¹ã‚‹é‡Ã·ã‚‚ã¨ã«ã™ã‚‹é‡',source:'åŸºæœ¬',difficulty:1,curriculum:'ç™¾åˆ†ç‡ã¨æ­©åˆ'},
    {subject:'ç®—æ•°',topic:'é£Ÿå¡©æ°´',question:'8%ã®é£Ÿå¡©æ°´200gã«æ°´ã‚’åŠ ãˆã¦5%ã«ã—ãŸã„ã€‚æ°´ã¯ä½•gï¼Ÿ',answer:'é£Ÿå¡©:200Ã—0.08=16g(ã“ã‚Œã¯å¤‰ã‚ã‚‰ãªã„)\n16Ã·0.05=320g(å…¨ä½“)\næ°´:320-200=120g',source:'äºˆã‚·ãƒª5ä¸Š',difficulty:2,curriculum:'é£Ÿå¡©æ°´'},
    {subject:'ç®—æ•°',topic:'é£Ÿå¡©æ°´',question:'10%ã®é£Ÿå¡©æ°´300gã¨4%ã®é£Ÿå¡©æ°´200gã‚’æ··ãœã‚‹ã¨ä½•%ï¼Ÿ',answer:'é£Ÿå¡©: 300Ã—0.1+200Ã—0.04=30+8=38g\nå…¨ä½“: 500g\n38Ã·500=7.6%\nğŸ’¡é¢ç©å›³(ã¦ã‚“ã³ã‚“æ³•)ã§ã‚‚è§£ã‘ã‚‹',source:'å¿œç”¨',difficulty:3,curriculum:'é£Ÿå¡©æ°´'},
    {subject:'ç®—æ•°',topic:'æç›Šç®—',question:'åŸä¾¡600å††ã®å“ç‰©ã«4å‰²ã®åˆ©ç›Šã‚’è¦‹è¾¼ã‚“ã§å®šä¾¡ã‚’ã¤ã‘ãŸã€‚å®šä¾¡ã¯ï¼Ÿ',answer:'600Ã—1.4=840å††\nğŸ’¡å®šä¾¡=åŸä¾¡Ã—(1+åˆ©ç›Šç‡)',source:'åŸºæœ¬',difficulty:1,curriculum:'æç›Šç®—'},
    {subject:'ç®—æ•°',topic:'é€Ÿã•ã®åŸºæœ¬',question:'æ™‚é€Ÿ60kmã§2æ™‚é–“30åˆ†èµ°ã‚‹ã¨ä½•kmï¼Ÿ',answer:'60Ã—2.5=150km\nğŸ’¡è·é›¢=é€Ÿã•Ã—æ™‚é–“ 30åˆ†=0.5æ™‚é–“',source:'åŸºæœ¬',difficulty:1,curriculum:'é€Ÿã•ã®åŸºæœ¬'},
    {subject:'ç®—æ•°',topic:'æ—…äººç®—',question:'Aã¨BãŒ600mé›¢ã‚Œã¦å‘ã‹ã„åˆã£ã¦æ­©ãã€‚Aåˆ†é€Ÿ80mã€Båˆ†é€Ÿ60mã€‚ä½•åˆ†å¾Œã«å‡ºä¼šã†ï¼Ÿ',answer:'å‡ºä¼šã„â†’é€Ÿã•ã®å’Œ\n80+60=æ¯åˆ†140m\n600Ã·140=30/7â‰’4.3åˆ†\nğŸ’¡å‡ºä¼šã„=å’Œã€è¿½ã„ã‹ã‘=å·®',source:'äºˆã‚·ãƒª5ä¸Š',difficulty:2,curriculum:'æ—…äººç®—'},
    {subject:'ç®—æ•°',topic:'æ—…äººç®—',question:'å…„ãŒåˆ†é€Ÿ80mã§å‡ºç™ºã—ã¦5åˆ†å¾Œã«å¼ŸãŒåˆ†é€Ÿ120mã§è¿½ã„ã‹ã‘ã‚‹ã€‚ä½•åˆ†å¾Œã«è¿½ã„ã¤ãï¼Ÿ',answer:'å…„ã®å…ˆè¡Œ:80Ã—5=400m\nå·®ã®é€Ÿã•:120-80=40m/åˆ†\n400Ã·40=10åˆ†å¾Œ',source:'å¿œç”¨',difficulty:3,curriculum:'æ—…äººç®—'},
    {subject:'ç®—æ•°',topic:'é€šéç®—',question:'é•·ã•150mã®åˆ—è»ŠãŒæ™‚é€Ÿ90kmã§400mã®é‰„æ©‹ã‚’æ¸¡ã‚Šãã‚‹ã®ã«ä½•ç§’ï¼Ÿ',answer:'é€²ã‚€è·é›¢=150+400=550m\næ™‚é€Ÿ90km=ç§’é€Ÿ25m\n550Ã·25=22ç§’\nğŸ’¡å…ˆé ­ãŒå…¥ã£ã¦æœ€å¾Œå°¾ãŒå‡ºã‚‹ã¾ã§',source:'äºˆã‚·ãƒª5ä¸Š',difficulty:2,curriculum:'é€šéç®—'},
    {subject:'ç®—æ•°',topic:'æµæ°´ç®—',question:'é™æ°´æ™‚é€Ÿ12kmã€å·ã®æµé€Ÿæ™‚é€Ÿ3kmã€‚24kmä¸Šã‚‹ã®ã«ã‹ã‹ã‚‹æ™‚é–“ã¯ï¼Ÿ',answer:'ä¸Šã‚Šã®é€Ÿã•=12-3=9km/h\n24Ã·9=8/3=2æ™‚é–“40åˆ†\nğŸ’¡ä¸Šã‚Š=é™æ°´-æµé€Ÿ ä¸‹ã‚Š=é™æ°´+æµé€Ÿ',source:'äºˆã‚·ãƒª5ä¸Š',difficulty:2,curriculum:'æµæ°´ç®—'},
    {subject:'ç®—æ•°',topic:'æ¯”ã®åŸºæœ¬',question:'Aã¨Bã®æ¯”ãŒ3:5ã§BãŒ40ã®ã¨ãã€Aã¯ï¼Ÿ',answer:'5â†’40ãªã®ã§1â†’8\nA=3Ã—8=24\nğŸ’¡æ¯”ã®1ã‚ãŸã‚Šã‚’æ±‚ã‚ã‚‹',source:'åŸºæœ¬',difficulty:1,curriculum:'æ¯”ã®åŸºæœ¬'},
    {subject:'ç®—æ•°',topic:'ç›¸ä¼¼',question:'ç›¸ä¼¼æ¯”2:3ã®ä¸‰è§’å½¢ã€‚é¢ç©æ¯”ã¯ï¼Ÿ',answer:'é¢ç©æ¯”=2Â²:3Â²=4:9\nğŸ’¡é¢ç©æ¯”=ç›¸ä¼¼æ¯”ã®2ä¹—',source:'äºˆã‚·ãƒª5ä¸Š',difficulty:2,curriculum:'ç›¸ä¼¼'},
    {subject:'ç®—æ•°',topic:'é¢ç©æ¯”',question:'â–³ABCã®è¾ºBCã‚’BD:DC=2:3ã«åˆ†ã‘ã‚‹ç‚¹Dã€‚â–³ABDã¨â–³ACDã®é¢ç©æ¯”ã¯ï¼Ÿ',answer:'é«˜ã•å…±é€šãªã®ã§åº•è¾ºã®æ¯”=é¢ç©æ¯”\nâ–³ABD:â–³ACD=2:3',source:'åŸºæœ¬',difficulty:2,curriculum:'é¢ç©æ¯”'},
    {subject:'ç®—æ•°',topic:'ä»•äº‹ç®—',question:'Aã¯12æ—¥ã€Bã¯18æ—¥ã§çµ‚ã‚ã‚‹ä»•äº‹ã€‚ä¸€ç·’ã«ã‚„ã‚‹ã¨ä½•æ—¥ï¼Ÿ',answer:'A:1æ—¥1/12 B:1æ—¥1/18\nåˆè¨ˆ:1/12+1/18=5/36\n36/5=7.2æ—¥\nğŸ’¡å…¨ä½“ã‚’1ã¨ãŠã',source:'äºˆã‚·ãƒª5ä¸‹',difficulty:2,curriculum:'ä»•äº‹ç®—'},
    {subject:'ç®—æ•°',topic:'ä»•äº‹ç®—',question:'æ°´æ§½ã«Aç®¡ã§10åˆ†ã€Bç®¡ã§15åˆ†ã§æº€æ°´ã€‚ä¸¡æ–¹é–‹ãã¨ï¼Ÿ',answer:'A:1/10 B:1/15 åˆè¨ˆ:1/6\n6åˆ†ã§æº€æ°´',source:'åŸºæœ¬',difficulty:2,curriculum:'ä»•äº‹ç®—'},
    {subject:'ç®—æ•°',topic:'æ•°åˆ—',question:'1,4,9,16,25,... 10ç•ªç›®ã®æ•°ã¯ï¼Ÿ',answer:'nÂ²ã®æ•°åˆ—ï¼ˆå¹³æ–¹æ•°ï¼‰\n10Â²=100\nğŸ’¡å·®ãŒ3,5,7,9...ã¨å¥‡æ•°åˆ—',source:'åŸºæœ¬',difficulty:1,curriculum:'æ•°åˆ—'},
    {subject:'ç®—æ•°',topic:'ç«‹ä½“å›³å½¢',question:'ç¸¦3cmã€æ¨ª4cmã€é«˜ã•5cmã®ç›´æ–¹ä½“ã®ä½“ç©ã¨è¡¨é¢ç©',answer:'ä½“ç©:3Ã—4Ã—5=60cmÂ³\nè¡¨é¢ç©:2Ã—(3Ã—4+4Ã—5+3Ã—5)=2Ã—(12+20+15)=94cmÂ²',source:'åŸºæœ¬',difficulty:1,curriculum:'ç«‹ä½“å›³å½¢'},
    {subject:'ç®—æ•°',topic:'é€Ÿã•ã¨æ¯”',question:'Aã¨Bã®é€Ÿã•ã®æ¯”ãŒ3:4ã€‚åŒæ™‚ã«å‡ºç™ºã—ã¦BãŒ16kmé€²ã‚“ã ã¨ãã€Aã¯ä½•kmï¼Ÿ',answer:'é€Ÿã•ã®æ¯”=è·é›¢ã®æ¯”ï¼ˆæ™‚é–“åŒã˜ï¼‰\nA:B=3:4 B=16\nA=16Ã—3/4=12km',source:'äºˆã‚·ãƒª5ä¸‹',difficulty:2,curriculum:'é€Ÿã•ã¨æ¯”'},

    // ===== 6å¹´ ç®—æ•° =====
    {subject:'ç®—æ•°',topic:'æ•°ã®æ€§è³ªï¼ˆç™ºå±•ï¼‰',question:'1ã‹ã‚‰100ã¾ã§ã®æ•´æ•°ã§ã€3ã§ã‚‚5ã§ã‚‚å‰²ã‚Šåˆ‡ã‚Œãªã„æ•°ã¯ä½•å€‹ï¼Ÿ',answer:'å…¨ä½“100 3ã®å€æ•°33 5ã®å€æ•°20 15ã®å€æ•°6\nåŒ…é™¤åŸç†:33+20-6=47\n100-47=53å€‹',source:'å…¥è©¦',difficulty:3,curriculum:'æ•°ã®æ€§è³ªï¼ˆç™ºå±•ï¼‰'},
    {subject:'ç®—æ•°',topic:'æ–‡ç« é¡Œç·åˆ',question:'æ± ã®å‘¨ã‚Šã‚’A(åˆ†é€Ÿ60m)ã¨B(åˆ†é€Ÿ80m)ãŒåŒã˜åœ°ç‚¹ã‹ã‚‰é€†æ–¹å‘ã«æ­©ãã€‚æ± ã®å‘¨ã‚Šã¯560mã€‚ä½•åˆ†å¾Œã«åˆã‚ã¦å‡ºä¼šã†ï¼Ÿ',answer:'é€†æ–¹å‘=é€Ÿã•ã®å’Œ\n60+80=140m/åˆ†\n560Ã·140=4åˆ†å¾Œ',source:'å…¥è©¦',difficulty:2,curriculum:'æ–‡ç« é¡Œç·åˆ'},

    // ===== ç†ç§‘ =====
    {subject:'ç†ç§‘',topic:'æ¤ç‰©ã®ã¤ãã‚Š',question:'æ¤ç‰©ã®å…‰åˆæˆã«å¿…è¦ãª3ã¤ã¯ï¼Ÿ',answer:'å…‰ãƒ»æ°´ãƒ»äºŒé…¸åŒ–ç‚­ç´ \nâ†’ãƒ‡ãƒ³ãƒ—ãƒ³(æ „é¤Š)+é…¸ç´ \nğŸ’¡è‘‰ç·‘ä½“ã§è¡Œã‚ã‚Œã‚‹',source:'åŸºæœ¬',difficulty:1,curriculum:'æ¤ç‰©ã®ã¤ãã‚Š'},
    {subject:'ç†ç§‘',topic:'æ°´æº¶æ¶²ã®æ€§è³ª',question:'BTBæ¶²ã®è‰²å¤‰åŒ–ã¯ï¼Ÿ',answer:'é…¸æ€§:é»„ ä¸­æ€§:ç·‘ ã‚¢ãƒ«ã‚«ãƒªæ€§:é’\nğŸ’¡ãƒªãƒˆãƒã‚¹:é…¸æ€§ã§é’â†’èµ¤(ã•ã‚“ã§ã‚ã‹)',source:'åŸºæœ¬',difficulty:1,curriculum:'æ°´æº¶æ¶²ã®æ€§è³ª'},
    {subject:'ç†ç§‘',topic:'æ°´æº¶æ¶²ã®æ€§è³ª',question:'å¡©é…¸ã«ã‚¢ãƒ«ãƒŸãƒ‹ã‚¦ãƒ ã‚’å…¥ã‚Œã‚‹ã¨ï¼Ÿ',answer:'æ°´ç´ ãŒç™ºç”Ÿã—ã¦æº¶ã‘ã‚‹\nAlClâ‚ƒ(å¡©åŒ–ã‚¢ãƒ«ãƒŸãƒ‹ã‚¦ãƒ )ã«ãªã‚‹\nğŸ’¡å¡©é…¸+é‡‘å±â†’æ°´ç´ ç™ºç”Ÿ',source:'åŸºæœ¬',difficulty:2,curriculum:'æ°´æº¶æ¶²ã®æ€§è³ª'},
    {subject:'ç†ç§‘',topic:'ã¦ã“ã¨æ»‘è»Š',question:'æ”¯ç‚¹ã‹ã‚‰30cmã«100gã®ãŠã‚‚ã‚Šã€‚æ”¯ç‚¹ã‹ã‚‰50cmã§é‡£ã‚Šåˆã‚ã›ã‚‹ã«ã¯ï¼Ÿ',answer:'30Ã—100=50Ã—â–¡\nâ–¡=60g\nğŸ’¡ã¦ã“ã®åŸç†:å·¦å›ã‚Š=å³å›ã‚Š',source:'åŸºæœ¬',difficulty:2,curriculum:'ã¦ã“ã¨æ»‘è»Š'},
    {subject:'ç†ç§‘',topic:'å¤©ä½“ã®å‹•ã',question:'æœˆã®æº€ã¡æ¬ ã‘ã®å‘¨æœŸã¯ç´„ä½•æ—¥ï¼Ÿ',answer:'ç´„29.5æ—¥(æœ”æœ›æœˆ)\nğŸ’¡æ–°æœˆâ†’ä¸Šå¼¦â†’æº€æœˆâ†’ä¸‹å¼¦â†’æ–°æœˆ',source:'åŸºæœ¬',difficulty:1,curriculum:'å¤©ä½“ã®å‹•ã'},
    {subject:'ç†ç§‘',topic:'é›»æµã¨å›è·¯',question:'ç›´åˆ—ã¨ä¸¦åˆ—ã€ã©ã¡ã‚‰ãŒæ˜ã‚‹ã„ï¼Ÿé›»æ± 2å€‹ã€è±†é›»çƒ1å€‹ã®å ´åˆ',answer:'ç›´åˆ—ã®æ–¹ãŒé›»åœ§2å€â†’æ˜ã‚‹ã„\nä¸¦åˆ—ã¯é›»åœ§åŒã˜â†’æ˜ã‚‹ã•å¤‰ã‚ã‚‰ãšé•·æŒã¡\nğŸ’¡ç›´åˆ—=é›»åœ§UP ä¸¦åˆ—=é•·æŒã¡',source:'åŸºæœ¬',difficulty:2,curriculum:'é›»æµã¨å›è·¯'},
    {subject:'ç†ç§‘',topic:'æ°—ä½“ã®æ€§è³ª',question:'é…¸ç´ ã®é›†ã‚æ–¹ã¨æ€§è³ª',answer:'æ°´ä¸Šç½®æ›æ³•ã§é›†ã‚ã‚‹\nç„¡è‰²ç„¡è‡­ã€ã‚‚ã®ã‚’ç‡ƒã‚„ã™åŠ©ç‡ƒæ€§\nğŸ’¡ç©ºæ°—ã®ç´„21%ãŒé…¸ç´ ',source:'åŸºæœ¬',difficulty:1,curriculum:'æ°—ä½“ã®æ€§è³ª'},

    // ===== ç¤¾ä¼š =====
    {subject:'ç¤¾ä¼š',topic:'æ—¥æœ¬ã®å›½åœŸ',question:'æ—¥æœ¬ã§ä¸€ç•ªé•·ã„å·ã¨ã€ä¸€ç•ªé¢ç©ãŒå¤§ãã„æ¹–ã¯ï¼Ÿ',answer:'å·:ä¿¡æ¿ƒå·(367km)\næ¹–:çµç¶æ¹–(670kmÂ²)\nğŸ’¡åˆ©æ ¹å·ã¯æµåŸŸé¢ç©æœ€å¤§',source:'åŸºæœ¬',difficulty:1,curriculum:'æ—¥æœ¬ã®å›½åœŸ'},
    {subject:'ç¤¾ä¼š',topic:'æ—¥æœ¬ã®è¾²æ¥­',question:'ç±³ã®ç”Ÿç”£é‡ãŒå¤šã„éƒ½é“åºœçœŒãƒˆãƒƒãƒ—3ã¯ï¼Ÿ',answer:'1ä½æ–°æ½ŸçœŒ 2ä½åŒ—æµ·é“ 3ä½ç§‹ç”°çœŒ\nğŸ’¡åŒ—é™¸åœ°æ–¹ã¯ç±³ã©ã“ã‚',source:'åŸºæœ¬',difficulty:1,curriculum:'æ—¥æœ¬ã®è¾²æ¥­'},
    {subject:'ç¤¾ä¼š',topic:'æ—¥æœ¬ã®å·¥æ¥­',question:'å¤ªå¹³æ´‹ãƒ™ãƒ«ãƒˆã¨ã¯ï¼Ÿ',answer:'æ±äº¬ï½åŒ—ä¹å·ã‚’çµã¶å¸¯çŠ¶ã®å·¥æ¥­åœ°å¸¯\nğŸ’¡æ—¥æœ¬ã®å·¥æ¥­ç”Ÿç”£ã®å¤§éƒ¨åˆ†ãŒé›†ä¸­',source:'åŸºæœ¬',difficulty:1,curriculum:'æ—¥æœ¬ã®å·¥æ¥­'},
    {subject:'ç¤¾ä¼š',topic:'æ­´å²ï¼ˆéŒå€‰ã€œå®¤ç”ºï¼‰',question:'éŒå€‰å¹•åºœã‚’é–‹ã„ãŸã®ã¯èª°ï¼Ÿä½•å¹´ï¼Ÿ',answer:'æºé ¼æœ 1185å¹´\n(ã„ã„ç®±ã¤ãã‚ã†éŒå€‰å¹•åºœ)\nğŸ’¡å®ˆè­·ãƒ»åœ°é ­ã‚’å…¨å›½ã«è¨­ç½®',source:'åŸºæœ¬',difficulty:1,curriculum:'æ­´å²ï¼ˆéŒå€‰ã€œå®¤ç”ºï¼‰'},
    {subject:'ç¤¾ä¼š',topic:'æ­´å²ï¼ˆæˆ¦å›½ã€œæ±Ÿæˆ¸ï¼‰',question:'æ±Ÿæˆ¸å¹•åºœã®é–å›½ã§å”¯ä¸€è²¿æ˜“ãŒè¨±ã•ã‚ŒãŸå ´æ‰€ã¨å›½ã¯ï¼Ÿ',answer:'é•·å´ã®å‡ºå³¶ ã‚ªãƒ©ãƒ³ãƒ€ã¨ä¸­å›½\nğŸ’¡ã‚­ãƒªã‚¹ãƒˆæ•™ç¦æ­¢ãŒç›®çš„',source:'åŸºæœ¬',difficulty:1,curriculum:'æ­´å²ï¼ˆæˆ¦å›½ã€œæ±Ÿæˆ¸ï¼‰'},
    {subject:'ç¤¾ä¼š',topic:'å…¬æ°‘',question:'ä¸‰æ¨©åˆ†ç«‹ã¨ã¯ï¼Ÿ',answer:'ç«‹æ³•(å›½ä¼š)ãƒ»è¡Œæ”¿(å†…é–£)ãƒ»å¸æ³•(è£åˆ¤æ‰€)\näº’ã„ã«æŠ‘åˆ¶ã¨å‡è¡¡(ãƒã‚§ãƒƒã‚¯&ãƒãƒ©ãƒ³ã‚¹)\nğŸ’¡æ¨©åŠ›ã®é›†ä¸­ã‚’é˜²ãä»•çµ„ã¿',source:'åŸºæœ¬',difficulty:1,curriculum:'å…¬æ°‘'},
  ];

    return samples.map(function(s, i) {
    return {
      id: id + i,
      subject: s.subject,
      topic: s.topic,
      question: s.question,
      answer: s.answer,
      source: s.source || '',
      difficulty: s.difficulty || 2,
      image: null,
      contentImage: s.contentImage || null,
      memo: '',
      tags: [s.curriculum || ''],
      history: [],
      interval: 1,
      ease: 2.5,
      nextDate: today(),
      createdAt: today(),
      frozen: false,
      curriculum: s.curriculum || null
    };
  });
}

// ================================================================
// INIT
// ================================================================
// Initialize school level
var initLevel = (DATA.settings && DATA.settings.schoolLevel) || 'elementary';
document.getElementById('settingSchoolLevel').value = initLevel;
updateSubjectDropdown();

updateTimerDisplay();
initTheme();
initAuth();
if(location.hash.startsWith("#sync="))importFromURL();
renderToday();
</script>
</body>
</html>
